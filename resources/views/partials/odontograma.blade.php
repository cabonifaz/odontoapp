 <!-- resources/views/partials/odontograma.blade.php -->
<div id="contenedor-odontograma">
    {{-- Aqu√≠ puedes colocar tu estructura de dientes SVG, canvas o tabla --}}
   
    <div class="row justify-content-center"> <!-- Centra el contenido -->
        <div class="col-12 col-sm-10 col-md-8 text-center">    
            <div id="svgselect" class="svg-responsive">
                <svg version="1.1" viewBox="0 0 610 340" preserveAspectRatio="xMidYMid meet" width="100%" height="105%">
                    <g transform="scale(1.5)" id="gmain">
                        <g id="P18">
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">18</text>
                            
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P18" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P17" transform="translate(25,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">17</text>
                            
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P17" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>

                        </g>
                        <g id="P16" transform="translate(50,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">16</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P16" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P15" transform="translate(75,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">15</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P15" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P14" transform="translate(100,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">14</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P14" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P13" transform="translate(125,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">13</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P13" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P12" transform="translate(150,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">12</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P12" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P11" transform="translate(175,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">11</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P11" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        
                        <!-- Izquierda segunda fila -->
                        
                        <g id="P55" transform="translate(75,60)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">55</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P55" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P54" transform="translate(100,60)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">54</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P54" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P53" transform="translate(125,60)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">53</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P53" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P52" transform="translate(150,60)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">52</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P52" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P51" transform="translate(175,60)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">51</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P51" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                
                        <!-- Izquierda tercer fila -->
                
                        <g id="P85" transform="translate(75,120)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">85</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P85" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P84" transform="translate(100,120)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">84</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P84" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P83" transform="translate(125,120)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">83</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P83" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P82" transform="translate(150,120)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">82</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P82" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P81" transform="translate(175,120)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">81</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P81" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                
                        <!-- Izquierda cuarta fila -->
                
                        <g id="P48" transform="translate(0,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">48</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P48" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P47" transform="translate(25,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">47</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P47" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P46" transform="translate(50,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">46</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P46" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P45" transform="translate(75,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">45</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P45" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P44" transform="translate(100,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">44</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P44" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P43" transform="translate(125,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">43</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P43" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P42" transform="translate(150,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">42</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P42" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P41" transform="translate(175,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">41</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P41" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        
                        <!-- Derecha primer fila -->
                        
                        <g id="P21" transform="translate(210,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">21</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P21" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P22" transform="translate(235,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">22</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P22" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P23" transform="translate(260,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">23</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P23" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P24" transform="translate(285,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">24</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P24" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P25" transform="translate(310,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">25</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P25" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P26" transform="translate(335,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">26</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P26" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P27" transform="translate(360,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">27</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P27" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P28" transform="translate(385,0)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">28</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P28" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        
                        <!-- Derecha segunda fila -->
                        
                        <g id="P61" transform="translate(210,60)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">61</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P61" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P62" transform="translate(235,60)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">62</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P62" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P63" transform="translate(260,60)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">63</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P63" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P64" transform="translate(285,60)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">64</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P64" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P65" transform="translate(310,60)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">65</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P65" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        
                        <!-- Derecha tercer fila -->
                        
                        <g id="P71" transform="translate(210,120)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">71</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P71" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P72" transform="translate(235,120)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">72</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P72" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P73" transform="translate(260,120)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">73</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P73" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P74" transform="translate(285,120)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">74</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P74" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P75" transform="translate(310,120)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">75</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P75" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        
                        <!-- Derecha cuarta fila -->
                        
                        <g id="P31" transform="translate(210,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">31</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P31" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P32" transform="translate(235,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">32</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P32" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P33" transform="translate(260,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">33</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P33" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P34" transform="translate(285,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">34</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P34" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P35" transform="translate(310,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">35</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P35" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P36" transform="translate(335,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">36</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P36" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P37" transform="translate(360,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">37</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P37" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                        <g id="P38" transform="translate(385,180)">
                            <polygon points="5,5 	15,5 	15,15 	5,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="C" opacity="1"></polygon>
                            <polygon points="0,0 	20,0 	15,5 	5,5" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="T" opacity="1"></polygon>
                            <polygon points="5,15 	15,15 	20,20 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="B" opacity="1"></polygon>
                            <polygon points="15,5 	20,0 	20,20 	15,15" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="R" opacity="1"></polygon>
                            <polygon points="0,0 	5,5 	5,15 	0,20" fill="white" stroke="#8B4513" stroke-width="0.5" class="odontoseccion" id="L" opacity="1"></polygon>
                            <text x="6" y="30" stroke="#8B4513" fill="#8B4513" stroke-width="0.1" style="font-size: 6pt;font-weight:normal">38</text>
                            <rect x="0" y="34" width="20" height="15" 
                                stroke="black" fill="white" stroke-width="0.5" 
                                shape-rendering="crispEdges" />

                            <text id="sigla-P38" x="10" y="41.5" fill="black" font-size="6pt" 
                                font-weight="bold" text-anchor="middle" dominant-baseline="middle"></text>
                        </g>
                    </g>
                </svg>
                    
            </div>
            <!-- Contenedor de Hallazgos -->
            <div id="detalle-hallazgos" class="hallazgo-log">
            <!-- Los detalles se a√±adir√°n din√°micamente aqu√≠ -->
            </div>
        </div>
        <div class="col-12 col-sm-10 col-md-4">
            <div id="infoDiente" class="alert alert-info text-center p-2" style="font-size: 14px;">
                ü¶∑ Seleccione un diente y una zona
            </div>

            <div class="form-group">
                <label for="tratamientoSelect">Condici√≥n / Tratamiento (seg√∫n NTP):</label>
                <select id="tratamientoSelect" class="form-control select2" style="height: 45px;">
                    <option value="">-- Seleccione --</option>
                    <!-- Las opciones se llenan con JS -->
                </select>
            </div>
            <div class="form-group d-flex align-items-center" style="gap: 10px;">
                <label for="estadoSelect">Estado del Hallazgo:</label>
                <select id="estadoSelect" class="form-control select2 w-auto">
                    <option value="bueno" selected>Bueno</option>
                    <option value="malo">Malo</option>
                </select>
                <button 
                    id="btnLimpiar" 
                    class="btn btn-outline-secondary btn-sm ms-3" 
                    type="button" 
                    data-bs-toggle="tooltip" 
                    data-bs-placement="top" 
                    title="Limpiar campos" 
                    style="font-size: 1.4rem; line-height: 1;">
                    üßπ
                </button>
            </div>
            <div class="form-group">
                <input type="hidden" name="hallazgos_json" id="hallazgos_json">
                <label for="observaciones">Observaciones:</label>
                <textarea id="observaciones" class="form-control" rows="2" placeholder="üìù Escriba observaciones..."></textarea>
            </div>
            <div class="d-flex justify-content-between" style="gap: 10px; margin-top: 1rem;">
                <button class="btn btn-outline-success flex-fill" id="btnAplicar" type="button">‚úÖ Aplicar</button>
                <button class="btn btn-outline-danger flex-fill" id="btnEliminar" type="button">üóëÔ∏è Eliminar</button>
            </div>
        </div>  
    </div>
</div>
<div id="zona-tooltip" style="
    position: absolute;
    background: rgba(0, 0, 0, 0.75);
    color: #fff;
    padding: 4px 8px;
    font-size: 13px;
    border-radius: 4px;
    pointer-events: none;
    display: none;
    z-index: 9999;">
</div>


<script>
const tratamientosNTP = [
  { sigla: 'AOF', nombre: 'Aparato Ortod√≥ntico Fijo', color: 'blue', tipo: 'ortodoncia', descripcion: 'Cuadrados con cruz en √°pices unidos por l√≠nea.' },
  { sigla: 'AOR', nombre: 'Aparato Ortod√≥ntico Removible', color: 'blue', tipo: 'ortodoncia', descripcion: 'L√≠nea en zigzag de color azul.' },
  { sigla: 'CM', nombre: 'Corona Met√°lica', color: 'blue', tipo: 'corona', descripcion: 'Cuadrado azul alrededor de la corona cl√≠nica si est√° en buen estado. Puede ser dorada o plateada.' },
  { sigla: 'CF', nombre: 'Corona Fenestrada', color: 'blue', tipo: 'corona', descripcion: 'Cuadrado azul con ventana vestibular si est√° en buen estado.' },
  { sigla: 'CMC', nombre: 'Corona Metal Cer√°mica', color: 'blue', tipo: 'corona', descripcion: 'Corona con n√∫cleo met√°lico y recubrimiento est√©tico. Cuadro azul si est√° en buen estado.' },
  { sigla: 'CV', nombre: 'Corona Veneer', color: 'blue', tipo: 'corona', descripcion: 'Corona met√°lica completa con frente est√©tico. Cuadro azul si est√° en buen estado.' },
  { sigla: 'CLM', nombre: 'Corona libre de metal', color: 'blue', tipo: 'corona', descripcion: 'Corona est√©tica libre de metal. Cuadro azul si est√° en buen estado.' },
  { sigla: 'CT', nombre: 'Corona Temporal', color: 'red', tipo: 'corona', descripcion: 'Corona temporal. Cuadro rojo.' },
  { sigla: 'O', nombre: 'Opacidades del esmalte', color: 'red', tipo: 'dde', descripcion: 'Opacidades del esmalte sigla en rojo.' },
  { sigla: 'PE', nombre: 'Pigmentaci√≥n del esmalte', color: 'red', tipo: 'dde', descripcion: 'Pigmentaci√≥n del esmalte sigla en rojo.' },
  { sigla: 'FL', nombre: 'Fluorosis', color: 'red', tipo: 'dde', descripcion: 'Fluorosis se detalla en observaciones.' },
  { sigla: ')(', nombre: 'Diastema', color: 'blue', tipo: 'diastema', descripcion: 'Espacio entre dientes indicado con )(.' },
  { sigla: 'ETS', nombre: 'Ed√©ntulo Total Superior', color: 'blue', tipo: 'edentulo', descripcion: 'L√≠nea azul horizontal sobre coronas del maxilar superior' },
  { sigla: 'ETI', nombre: 'Ed√©ntulo Total Inferior', color: 'blue', tipo: 'edentulo', descripcion: 'L√≠nea azul horizontal sobre coronas del maxilar inferior' },
  {
    sigla: 'EM',
    nombre: 'Espigo ‚Äì Mu√±√≥n',
    color: 'blue',
    tipo: 'espigo',
    descripcion: 'L√≠nea vertical azul en la ra√≠z unida a un cuadrado en la corona. Si est√° en mal estado, se dibuja en rojo.'
  },
  { sigla: 'FFP', nombre: 'Fosas y Fisuras Profundas', color: 'blue', tipo: 'ffp', descripcion: 'Fosas y Fisuras Profundas.' },
  { sigla: 'FD', nombre: 'Fractura Dental', color: 'red', tipo: 'fractura', descripcion: 'Fractura Dental.' },
  { sigla: 'FUS', nombre: 'Fusi√≥n', color: 'blue', tipo: 'fusion', descripcion: 'Fusi√≥n Dental.' },
  { sigla: 'GEM', nombre: 'Geminaci√≥n', color: 'blue', tipo: 'geminacion', descripcion: 'Geminaci√≥n Dental.' },
  {
    sigla: 'GVH',
    nombre: 'Giroversi√≥n (Horario)',
    color: 'blue',
    tipo: 'giroversion',
    sentido: 'horario',
    descripcion: 'Flecha curva azul sentido horario en zona oclusal.'
},
{
    sigla: 'GVA',
    nombre: 'Giroversi√≥n (Antihorario)',
    color: 'blue',
    tipo: 'giroversion',
    sentido: 'antihorario',
    descripcion: 'Flecha curva azul sentido antihorario en zona oclusal.'
},
{ sigla: 'I', nombre: 'Impactaci√≥n', color: 'blue', tipo: 'impactacion', descripcion: 'Impactaci√≥n' },
{ sigla: 'IMP', nombre: 'Implante Dental', color: 'blue', tipo: 'imp', descripcion: 'Implante Dental' },
{
        sigla: 'MB',
        nombre: 'Mancha Blanca',
        color: 'red',
        tipo: 'caries',
        descripcion: 'Lesi√≥n de Caries: Mancha Blanca.'
    },
    {
        sigla: 'CE',
        nombre: 'Caries Esmalte',
        color: 'red',
        tipo: 'caries',
        descripcion: 'Lesi√≥n de Caries a nivel del esmalte.'
    },
    {
        sigla: 'CD',
        nombre: 'Caries Dentina',
        color: 'red',
        tipo: 'caries',
        descripcion: 'Lesi√≥n de Caries a nivel de la dentina.'
    },
    {
        sigla: 'CDP',
        nombre: 'Caries con Compromiso Pulpar',
        color: 'red',
        tipo: 'caries',
        descripcion: 'Lesi√≥n de Caries con compromiso de la pulpa.'
    },
    { sigla: 'MAC', nombre: 'Macrodoncia', color: 'blue', tipo: 'mac', descripcion: 'Macrodoncia' },
    { sigla: 'MIC', nombre: 'Microdoncia', color: 'blue', tipo: 'mic', descripcion: 'Microdoncia' },
    { sigla: 'M1', nombre: 'Movilidad Patol√≥gica G1', color: 'blue', tipo: 'mp', descripcion: 'Movilidad Patol√≥gica Grado 1' },
    { sigla: 'M2', nombre: 'Movilidad Patol√≥gica G2', color: 'blue', tipo: 'mp', descripcion: 'Movilidad Patol√≥gica Grado 2' },
    { sigla: 'M3', nombre: 'Movilidad Patol√≥gica G3', color: 'blue', tipo: 'mp', descripcion: 'Movilidad Patol√≥gica Grado 3' },
    { sigla: 'DNE', nombre: 'Diente No Erupcionado', color: 'blue', tipo: 'ausente', descripcion: 'Diente no erupcionado.' },
    { sigla: 'DEX', nombre: 'Diente Extra√≠do por Caries', color: 'blue', tipo: 'ausente', descripcion: 'Diente extra√≠do por experiencia de caries.' },
    { sigla: 'DAO', nombre: 'Diente Ausente - Otra causa', color: 'blue', tipo: 'ausente', descripcion: 'Diente ausente por otra causa.' },
    { sigla: 'CLA', nombre: 'Pieza Dentaria en Clavija', color: 'blue', tipo: 'clavija', descripcion: 'Pieza Dentaria en Clavija.' },
    { sigla: 'E', nombre: 'Pieza Dentaria Ect√≥pica', color: 'blue', tipo: 'ectopica', descripcion: 'Pieza Dentaria Ect√≥pica.' },
    { sigla: 'ERU', nombre: 'Pieza Dentaria en Erupci√≥n', color: 'blue', tipo: 'erupcion', descripcion: 'Pieza Dentaria en Erupci√≥n.' },
    { sigla: 'EXT', nombre: 'Pieza Dentaria Extruida', color: 'blue', tipo: 'extruida', descripcion: 'Pieza Dentaria Extruidda.' },
    { sigla: 'INT', nombre: 'Pieza Dentaria Intruida', color: 'blue', tipo: 'intruida', descripcion: 'Pieza Dentaria Intruidda.' },
    { sigla: 'SUP', nombre: 'Pieza Dentaria Supernumeraria', color: 'blue', tipo: 'supernumeraria', descripcion: 'Pieza Dentaria Supernumeraria.' },
    { sigla: 'PP', nombre: 'Pulpotom√≠a', color: 'blue', tipo: 'pulpotomia', descripcion: 'Pulpotom√≠a.' },
    { sigla: 'M', nombre: 'Posici√≥n Anormal Dentaria - Mesializado', color: 'blue', tipo: 'pos_anormal', descripcion: 'Posici√≥n Anormal Dentaria - Mesializado' },
    { sigla: 'D', nombre: 'Posici√≥n Anormal Dentaria - Distalizado', color: 'blue', tipo: 'pos_anormal', descripcion: 'Posici√≥n Anormal Dentaria - Distalizado' },
    { sigla: 'V', nombre: 'Posici√≥n Anormal Dentaria - Vestibularizado', color: 'blue', tipo: 'pos_anormal', descripcion: 'Posici√≥n Anormal Dentaria - Vestibularizado' },
    { sigla: 'P', nombre: 'Posici√≥n Anormal Dentaria - Palatinizado', color: 'blue', tipo: 'pos_anormal', descripcion: 'Posici√≥n Anormal Dentaria - Palatinizado' },
    { sigla: 'L', nombre: 'Posici√≥n Anormal Dentaria - Lingualizado', color: 'blue', tipo: 'pos_anormal', descripcion: 'Posici√≥n Anormal Dentaria - Lingualizado' },
    { sigla: 'PPF', nombre: 'Pr√≥tesis Parcial Fija', color: 'blue', tipo: 'protesis_parcial', descripcion: 'Pr√≥tesis Parcial Fija' },
    { sigla: 'PPR', nombre: 'Pr√≥tesis Parcial Removible', color: 'blue', tipo: 'protesis_removible', descripcion: 'Pr√≥tesis Parcial Removible' },
    { sigla: 'PTS', nombre: 'Pr√≥tesis Total Superior', color: 'blue', tipo: 'protesis_total', descripcion: 'Dooble L√≠nea azul horizontal sobre coronas del maxilar superior' },
    { sigla: 'PTI', nombre: 'Pr√≥tesis Total Inferior', color: 'blue', tipo: 'protesis_total', descripcion: 'Doble L√≠nea azul horizontal sobre coronas del maxilar inferior' },
    { sigla: 'RR', nombre: 'Remanente Radicular', color: 'red', tipo: 'remanente', descripcion: 'Remanente Radicular sigla en rojo.' },
    {
        sigla: 'AM',
        nombre: 'Amalgama Dental',
        color: 'blue',
        tipo: 'restauracion_definitiva',
        descripcion: 'Restauraci√≥n definitiva con Amalgama Dental.'
    },
    {
        sigla: 'R',
        nombre: 'Resina',
        color: 'blue',
        tipo: 'restauracion_definitiva',
        descripcion: 'Restauraci√≥n definitiva con Resina.'
    },
    {
        sigla: 'IV',
        nombre: 'Ion√≥mero de Vidrio',
        color: 'blue',
        tipo: 'restauracion_definitiva',
        descripcion: 'Restauraci√≥n definitiva con Ion√≥mero de Vidrio.'
    },
    {
        sigla: 'IM',
        nombre: 'Incrustaci√≥n Met√°lica',
        color: 'blue',
        tipo: 'restauracion_definitiva',
        descripcion: 'Restauraci√≥n definitiva con Incrustaci√≥n Met√°lica.'
    },
    {
        sigla: 'IE',
        nombre: 'Incrustaci√≥n Est√©tica',
        color: 'blue',
        tipo: 'restauracion_definitiva',
        descripcion: 'Restauraci√≥n definitiva con Incrustaci√≥n Est√©tica.'
    },
    {
        sigla: 'C',
        nombre: 'Carilla',
        color: 'blue',
        tipo: 'restauracion_definitiva',
        descripcion: 'Restauraci√≥n definitiva con Carilla.'
    },
    { sigla: 'RT', nombre: 'Restauraci√≥n Temporal', color: 'red', tipo: 'restauracion_temporal', descripcion: 'Restauraci√≥n Temporal.' },
    { sigla: 'S', nombre: 'Sellantes', color: 'blue', tipo: 'sellante', descripcion: 'Sellantes.' },
    { sigla: 'DES', nombre: 'Superficie Desgastada', color: 'red', tipo: 'desgaste', descripcion: 'Superficie Desgastada.' },
    { sigla: 'TC', nombre: 'Tratamiento de Conducto', color: 'blue', tipo: 'conducto', descripcion: 'Tratamiento de Conducto.' },
    { sigla: 'PC', nombre: 'Pulpectom√≠a', color: 'blue', tipo: 'conducto', descripcion: 'Pulpectom√≠a.' },
    { sigla: 'TD', nombre: 'Transposici√≥n Dentaria', color: 'blue', tipo: 'transposicion', descripcion: 'Transposici√≥n Dentaria.' },

];

</script>

<script>
    let hallazgosRegistrados = [];
    document.addEventListener('DOMContentLoaded', function () {
        const select = document.getElementById('tratamientoSelect');
        const infoDiente = document.getElementById('infoDiente');
        let selectedDiente = null;
        let selectedOrtodoncia = [];
        let selectedSupernumeraria = []; // Nuevo arreglo para este hallazgo

        let modoDibujoFD = false;
        let dibujoFractura = null;
        let x1Temp = 0, y1Temp = 0;
        let fracturasTemporales = []; // ‚Üê ‚úÖ Aqu√≠ la defines una sola vez

        let modoDibujoCaries = false;
        let trayectoActual = null;
        let manchasTemporales = [];

        let modoDibujoPulpotomia = false;
        let colorPulpotomia = 'blue';
        let pulpotomiasTemporales = [];

        let modoDibujoRestauracion = false;
        let restauracionesTemporales = [];
        let cursorRestauracion = null;

        let modoDibujoRestauracionTemporal = false;

        let modoDibujoSellante = false;
        let cursorSellante = null;
        let sellantesTemporales = [];

        let modoDibujoDesgaste = false;
        let cursorDesgaste = null;
        let desgasteTemporales = [];

        const svg = document.querySelector('svg');
        const ns = "http://www.w3.org/2000/svg";

        // Ordenar antes de recorrer
        tratamientosNTP.sort((a, b) => a.nombre.localeCompare(b.nombre));

        tratamientosNTP.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.sigla;
            opt.textContent = `${t.nombre} (${t.sigla})`;
            opt.dataset.color = t.color;
            opt.dataset.tipo = t.tipo;
            opt.dataset.descripcion = t.descripcion;
            opt.dataset.nombre = t.nombre;
            opt.dataset.sentido = t.sentido; // ‚úÖ esta l√≠nea FALTABA
            select.appendChild(opt);
        });
        
        let cursorCaries = null; // global

        function activarCursorCaries() {
            if (!cursorCaries) {
                cursorCaries = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                cursorCaries.setAttribute("width", 6);
                cursorCaries.setAttribute("height", 6);
                cursorCaries.setAttribute("fill", "red");
                cursorCaries.setAttribute("fill-opacity", 0.6);
                cursorCaries.setAttribute("pointer-events", "none");
                cursorCaries.setAttribute("id", "cursor-caries");
                svg.appendChild(cursorCaries);
            }
            cursorCaries.style.display = 'block';
        }

        function desactivarCursorCaries() {
            if (cursorCaries) {
                cursorCaries.style.display = 'none';
            }
        }
        
        let cursorPulpotomia = null;
        
        function activarCursorPulpotomia() {
            const estado = document.getElementById('estadoSelect').value;
            const color = estado === 'bueno' ? 'blue' : 'red';
            //console.log("color",color);
            console.log("cursorPulpotomia",cursorPulpotomia);
            if (!cursorPulpotomia) {
                cursorPulpotomia = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                cursorPulpotomia.setAttribute("width", 8);
                cursorPulpotomia.setAttribute("height", 8);
                cursorPulpotomia.setAttribute("pointer-events", "none");
                cursorPulpotomia.setAttribute("id", "cursor-pulpotomia");
                svg.appendChild(cursorPulpotomia);
                console.log("üß© Cursor pulpotom√≠a insertado:", svg.contains(cursorPulpotomia)); // debe ser true

            }

            cursorPulpotomia.setAttribute("fill", color);
            cursorPulpotomia.setAttribute("fill-opacity", "0.5");
            cursorPulpotomia.style.display = 'block';
        }

        function desactivarCursorPulpotomia() {
            if (cursorPulpotomia) {
                cursorPulpotomia.style.display = 'none';
            }
        }
        function activarCursorRestauracion() {
            const estado = document.getElementById('estadoSelect')?.value;
            const color = estado === 'bueno' ? 'blue' : 'red';
            if (!cursorRestauracion) {
                cursorRestauracion = document.createElementNS(ns, "rect");
                cursorRestauracion.setAttribute("width", 8);
                cursorRestauracion.setAttribute("height", 8);
                cursorRestauracion.setAttribute("pointer-events", "none");
                cursorRestauracion.setAttribute("id", "cursor-restauracion");
                svg.appendChild(cursorRestauracion);
            }
            cursorRestauracion.setAttribute("fill", color);
            cursorRestauracion.setAttribute("fill-opacity", "0.5");
            cursorRestauracion.style.display = 'block';
        }

        function desactivarCursorRestauracion() {
            if (cursorRestauracion) cursorRestauracion.style.display = 'none';
        }

        function activarCursorSellante() {
            const estado = document.getElementById('estadoSelect')?.value;
            const color = estado === 'bueno' ? 'blue' : 'red';

            if (!cursorSellante) {
                cursorSellante = document.createElementNS(ns, "rect");
                cursorSellante.setAttribute("width", 8);
                cursorSellante.setAttribute("height", 8);
                cursorSellante.setAttribute("pointer-events", "none");
                cursorSellante.setAttribute("id", "cursor-sellante");
                svg.appendChild(cursorSellante);
            }
            cursorSellante.setAttribute("fill", color);
            cursorSellante.setAttribute("fill-opacity", "0.5");
            cursorSellante.style.display = 'block';
        }

        function desactivarCursorSellante() {
            if (cursorSellante) cursorSellante.style.display = 'none';
        }

        function activarCursorDesgaste() {
            
            const color = 'red';

            if (!cursorDesgaste) {
                cursorDesgaste = document.createElementNS(ns, "rect");
                cursorDesgaste.setAttribute("width", 8);
                cursorDesgaste.setAttribute("height", 8);
                cursorDesgaste.setAttribute("pointer-events", "none");
                cursorDesgaste.setAttribute("id", "cursor-desgaste");
                svg.appendChild(cursorDesgaste);
            }
            cursorDesgaste.setAttribute("fill", color);
            cursorDesgaste.setAttribute("fill-opacity", "0.5");
            cursorDesgaste.style.display = 'block';
        }

        function desactivarCursorDesgaste() {
            if (cursorDesgaste) cursorDesgaste.style.display = 'none';
        }
        
        
        // üéØ Detectar cambio de opci√≥n en el select
        $('#tratamientoSelect').on('change', function () {
            const selectedOption = this.selectedOptions[0];
            const tipo = selectedOption.dataset.tipo;

            // Resetear modos
            modoDibujoFD = false;
            modoDibujoCaries = false;
            modoDibujoPulpotomia = false;
            modoDibujoRestauracion = false;
            svg.style.cursor = 'default';

            if (!selectedDiente) {
                Swal.fire('Atenci√≥n', 'Debe seleccionar un diente antes de aplicar un hallazgo.', 'warning');
                return;
            }

            if (tipo === 'fractura') {
                modoDibujoFD = true;
                svg.style.cursor = 'crosshair';
                Swal.fire('Modo dibujo activado', 'Haz clic y arrastra sobre el diente para dibujar la fractura.', 'info');
            } else if (tipo === 'restauracion_definitiva') {
                modoDibujoRestauracion = true;
                svg.style.cursor = 'default';
                activarCursorRestauracion();
                console.log("modoDibujoRestauracion",modoDibujoRestauracion);
                Swal.fire('Modo pintura activado', 'Pinta la restauraci√≥n definitiva dentro del diente.', 'info');
            } else if (tipo === 'restauracion_temporal') {
                modoDibujoRestauracionTemporal = true;
                svg.style.cursor = 'default';
                activarCursorRestauracion(); // puedes usar el mismo rect√°ngulo que para restauraci√≥n
                Swal.fire('Modo contorno activado', 'Dibuja el contorno de la restauraci√≥n temporal dentro del diente.', 'info');
            } else if (tipo === 'sellante') {
                modoDibujoSellante = true;
                svg.style.cursor = 'default';
                activarCursorSellante();
                Swal.fire('Modo pintura activado', 'Pinta la zona de desgaste dentro del diente.', 'info');
            } else if (tipo === 'desgaste') {
                modoDibujoDesgaste = true;
                svg.style.cursor = 'default';
                activarCursorDesgaste();
                Swal.fire('Modo pintura activado', 'Pinta la zona de desgaste dentro del diente.', 'info');
            }

            selectedOrtodoncia = [];
            selectedSupernumeraria = [];
        });

        document.getElementById('estadoSelect').addEventListener('change', function () {
            if (modoDibujoPulpotomia && cursorPulpotomia) {
                const color = this.value === 'bueno' ? 'blue' : 'red';
                cursorPulpotomia.setAttribute("fill", color);
            }
        });

        // Funci√≥n: verificar si un punto est√° dentro de un pol√≠gono
        function isPointInPolygon(polygonPoints, point) {
            let x = point.x, y = point.y;
            let inside = false;
            for (let i = 0, j = polygonPoints.length - 1; i < polygonPoints.length; j = i++) {
                let xi = polygonPoints[i][0], yi = polygonPoints[i][1];
                let xj = polygonPoints[j][0], yj = polygonPoints[j][1];
                let intersect = ((yi > y) !== (yj > y)) &&
                                (x < ((xj - xi) * (y - yi)) / ((yj - yi) || 1e-10) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        // Funci√≥n: extraer puntos absolutos del pol√≠gono (considerando el transform)
        function getPolygonPoints(polygon) {
            const gMain = document.getElementById('gmain');
            const scaleMatch = gMain.getAttribute('transform')?.match(/scale\(([\d.]+)\)/);
            const scale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;

            const g = polygon.closest('g');
            const transform = g?.getAttribute('transform') || '';
            const [dx, dy] = transform.match(/-?\d+\.?\d*/g)?.map(Number) || [0, 0];

            return polygon.getAttribute('points').trim().split(/\s+/).map(pt => {
                const [x, y] = pt.split(',').map(Number);
                return [(x + dx) * scale, (y + dy) * scale];
            });
        }
        function estaDentroDelDiente(coords) {
            if (!selectedDiente || !selectedDiente.diente) return false;

            const gDiente = document.getElementById(selectedDiente.diente);
            if (!gDiente) return false;

            const poligonos = gDiente.querySelectorAll('polygon');
            for (const pol of poligonos) {
                const points = getPolygonPoints(pol);
                if (isPointInPolygon(points, coords)) return true;
            }

            return false;
        }

        // === Inicio del trazo ===
        svg.addEventListener('mousedown', function (e) {
            if (!selectedDiente || !selectedDiente.diente) return;
            if (!modoDibujoFD && !modoDibujoCaries && !modoDibujoPulpotomia && !modoDibujoRestauracion && !modoDibujoRestauracionTemporal && !modoDibujoSellante && !modoDibujoDesgaste) return;
            // Dentro de mousedown:
            const targetDienteGroup = e.target.closest('g[id^="P"]');
            if (!targetDienteGroup || targetDienteGroup.id !== selectedDiente.diente) {
                console.warn('‚õî Intento de trazo fuera del diente seleccionado');
                return;
            }

            const pt = svg.createSVGPoint();
            pt.x = e.clientX;
            pt.y = e.clientY;
            const coords = pt.matrixTransform(svg.getScreenCTM().inverse());

            if (!estaDentroDelDiente(coords)) return;

            // === FRACTURA ===
            if (modoDibujoFD) {
                x1Temp = coords.x;
                y1Temp = coords.y;

                dibujoFractura = document.createElementNS(ns, 'line');
                dibujoFractura.setAttribute('x1', x1Temp);
                dibujoFractura.setAttribute('y1', y1Temp);
                dibujoFractura.setAttribute('x2', x1Temp);
                dibujoFractura.setAttribute('y2', y1Temp);
                dibujoFractura.setAttribute('stroke', 'red');
                dibujoFractura.setAttribute('stroke-width', 1.8);
                dibujoFractura.classList.add('fractura-temporal');
                svg.appendChild(dibujoFractura);
            }

            // === CARIES o PULPOTOM√çA ===
            if ((modoDibujoCaries || modoDibujoPulpotomia) && estaDentroDelDiente(coords)) {
                const color = modoDibujoCaries
                ? 'red'
                : (document.getElementById('estadoSelect')?.value === 'bueno' ? 'blue' : 'red');

                trayectoActual = document.createElementNS(ns, 'path');
                trayectoActual.setAttribute('fill', color);
                trayectoActual.setAttribute('stroke', color);
                trayectoActual.setAttribute('stroke-width', 3);
                trayectoActual.setAttribute('fill-opacity', 0.6);
                trayectoActual.setAttribute('data-diente', selectedDiente.diente);
                trayectoActual.classList.add(modoDibujoCaries ? 'caries-marca' : 'pulpotomia-marca');

                let d = `M ${coords.x} ${coords.y}`;
                trayectoActual.setAttribute('d', d);
                trayectoActual.dataset.dPath = d;

                svg.appendChild(trayectoActual);
            }

            if (modoDibujoRestauracion && estaDentroDelDiente(coords)) {
                const color = document.getElementById('estadoSelect')?.value === 'bueno' ? 'blue' : 'red';
                //console.log("color",color);
                trayectoActual = document.createElementNS(ns, 'path');
                trayectoActual.setAttribute('fill', color);
                trayectoActual.setAttribute('stroke', color);
                trayectoActual.setAttribute('stroke-width', 3);
                trayectoActual.setAttribute('fill-opacity', 0.6);
                trayectoActual.setAttribute('data-diente', selectedDiente.diente);
                trayectoActual.classList.add('restauracion-marca');

                let d = `M ${coords.x} ${coords.y}`;
                trayectoActual.setAttribute('d', d);
                trayectoActual.dataset.dPath = d;

                svg.appendChild(trayectoActual);
            }
            //console.log("modoDibujoRestauracionTemporal",modoDibujoRestauracionTemporal);
            if (modoDibujoRestauracionTemporal && estaDentroDelDiente(coords)) {
                trayectoActual = document.createElementNS(ns, 'path');
                trayectoActual.setAttribute('stroke', 'red');
                trayectoActual.setAttribute('stroke-width', 2);
                trayectoActual.setAttribute('fill', 'none'); // ‚Üê importante: sin relleno
                trayectoActual.setAttribute('data-diente', selectedDiente.diente);
                trayectoActual.classList.add('restauracion-temporal-marca');

                let d = `M ${coords.x} ${coords.y}`;
                trayectoActual.setAttribute('d', d);
                trayectoActual.dataset.dPath = d;

                svg.appendChild(trayectoActual);
            }

            if (modoDibujoSellante && estaDentroDelDiente(coords)) {
                const estado = document.getElementById('estadoSelect')?.value;
                const color = estado === 'bueno' ? 'blue' : 'red';

                trayectoActual = document.createElementNS(ns, 'path');
                trayectoActual.setAttribute('fill', 'none'); // sin relleno
                trayectoActual.setAttribute('stroke', color); // contorno visible
                trayectoActual.setAttribute('stroke-width', 1);
                trayectoActual.setAttribute('data-diente', selectedDiente.diente);
                trayectoActual.classList.add('sellante-marca');

                let d = `M ${coords.x} ${coords.y}`;
                trayectoActual.setAttribute('d', d);
                trayectoActual.dataset.dPath = d;

                svg.appendChild(trayectoActual);
            }

            if (modoDibujoDesgaste && estaDentroDelDiente(coords)) {
                
                const color = 'red';

                trayectoActual = document.createElementNS(ns, 'path');
                trayectoActual.setAttribute('fill', 'none'); // sin relleno
                trayectoActual.setAttribute('stroke', color); // contorno visible
                trayectoActual.setAttribute('stroke-width', 1);
                trayectoActual.setAttribute('data-diente', selectedDiente.diente);
                trayectoActual.classList.add('desgaste-marca');

                let d = `M ${coords.x} ${coords.y}`;
                trayectoActual.setAttribute('d', d);
                trayectoActual.dataset.dPath = d;

                svg.appendChild(trayectoActual);
            }
        });

                // === Movimiento del mouse durante el trazo
        svg.addEventListener('mousemove', function (e) {
            const pt = svg.createSVGPoint();
            pt.x = e.clientX;
            pt.y = e.clientY;
            const coords = pt.matrixTransform(svg.getScreenCTM().inverse());

            // Mostrar cursor personalizado si est√° activo
            if (modoDibujoCaries && cursorCaries) {
                if (estaDentroDelDiente(coords)) {
                    cursorCaries.setAttribute("x", coords.x - 3);
                    cursorCaries.setAttribute("y", coords.y - 3);
                    cursorCaries.style.display = 'block';
                } else {
                    cursorCaries.style.display = 'none';
                }
            }

            if (modoDibujoPulpotomia && cursorPulpotomia) {
                if (estaDentroDelDiente(coords)) {
                    cursorPulpotomia.setAttribute("x", coords.x - 4);
                    cursorPulpotomia.setAttribute("y", coords.y - 4);
                    cursorPulpotomia.style.display = 'block';
                } else {
                    cursorPulpotomia.style.display = 'none';
                }
            }

            if ((modoDibujoRestauracion || modoDibujoRestauracionTemporal) && cursorRestauracion) {
                if (estaDentroDelDiente(coords)) {
                    cursorRestauracion.setAttribute("x", coords.x - 4);
                    cursorRestauracion.setAttribute("y", coords.y - 4);
                    cursorRestauracion.style.display = 'block';
                } else {
                    cursorRestauracion.style.display = 'none';
                }
            }

            if (modoDibujoSellante && cursorSellante) {
                if (estaDentroDelDiente(coords)) {
                    cursorSellante.setAttribute("x", coords.x - 4);
                    cursorSellante.setAttribute("y", coords.y - 4);
                    cursorSellante.style.display = 'block';
                } else {
                    cursorSellante.style.display = 'none';
                }
            }

            if (modoDibujoDesgaste && cursorDesgaste) {
                if (estaDentroDelDiente(coords)) {
                    cursorDesgaste.setAttribute("x", coords.x - 4);
                    cursorDesgaste.setAttribute("y", coords.y - 4);
                    cursorDesgaste.style.display = 'block';
                } else {
                    cursorDesgaste.style.display = 'none';
                }
            }

            // Solo continuar trazado si el punto est√° dentro del diente
            if (!estaDentroDelDiente(coords)) return;

            // === FRACTURA ===
            if (modoDibujoFD && dibujoFractura) {
                dibujoFractura.setAttribute('x2', coords.x);
                dibujoFractura.setAttribute('y2', coords.y);
            }

            // === TRAZO LIBRE CARIES / PULPOTOM√çA
            if ((modoDibujoCaries || modoDibujoPulpotomia) && trayectoActual) {
                let d = trayectoActual.getAttribute('d');
                d += ` L ${coords.x} ${coords.y}`;
                trayectoActual.setAttribute('d', d);
                trayectoActual.dataset.dPath = d;
            }
            if (modoDibujoRestauracion && trayectoActual) {
                let d = trayectoActual.getAttribute('d');
                d += ` L ${coords.x} ${coords.y}`;
                trayectoActual.setAttribute('d', d);
                trayectoActual.dataset.dPath = d;
            }

            if (modoDibujoRestauracionTemporal && trayectoActual) {
                let d = trayectoActual.getAttribute('d');
                d += ` L ${coords.x} ${coords.y}`;
                trayectoActual.setAttribute('d', d);
                trayectoActual.dataset.dPath = d;
            }

            if (modoDibujoSellante && trayectoActual) {
                let d = trayectoActual.getAttribute('d');
                d += ` L ${coords.x} ${coords.y}`;
                trayectoActual.setAttribute('d', d);
                trayectoActual.dataset.dPath = d;
            }

            if (modoDibujoDesgaste && trayectoActual) {
                let d = trayectoActual.getAttribute('d');
                d += ` L ${coords.x} ${coords.y}`;
                trayectoActual.setAttribute('d', d);
                trayectoActual.dataset.dPath = d;
            }
            // Restauraci√≥n ya est√° cubierta arriba
        });

                // === Finalizar trazo
        svg.addEventListener('mouseup', function (e) {
            if (!selectedDiente || !selectedDiente.diente) return;

            const pt = svg.createSVGPoint();
            pt.x = e.clientX;
            pt.y = e.clientY;
            const coords = pt.matrixTransform(svg.getScreenCTM().inverse());

            if (!estaDentroDelDiente(coords)) return;

            // === Finalizar FRACTURA ===
            if (modoDibujoFD && dibujoFractura) {
                const x1 = parseFloat(dibujoFractura.getAttribute('x1'));
                const y1 = parseFloat(dibujoFractura.getAttribute('y1'));
                const x2 = parseFloat(dibujoFractura.getAttribute('x2'));
                const y2 = parseFloat(dibujoFractura.getAttribute('y2'));

                dibujoFractura.classList.remove('fractura-temporal');
                dibujoFractura.classList.add('fractura-dental-marca');
                dibujoFractura.setAttribute('data-diente', selectedDiente.diente);

                fracturasTemporales.push({
                    diente: selectedDiente.diente,
                    x1, y1, x2, y2
                });

                dibujoFractura = null;
                modoDibujoFD = false;
                svg.style.cursor = 'default';

                Swal.fire('Listo', 'Fractura registrada.', 'info');
            }

            // === Finalizar CARIES ===
            if (modoDibujoCaries && trayectoActual) {
                manchasTemporales.push({
                    diente: selectedDiente.diente,
                    d: trayectoActual.dataset.dPath
                });
                trayectoActual = null;
            }

            // === Finalizar PULPOTOM√çA ===
            if (modoDibujoPulpotomia && trayectoActual) {
                const estado = document.getElementById('estadoSelect')?.value || 'bueno';
                const color = estado === 'bueno' ? 'blue' : 'red';

                pulpotomiasTemporales.push({
                    diente: selectedDiente.diente,
                    d: trayectoActual.dataset.dPath,
                    color,
                    estado
                });
                trayectoActual = null;
            }

            if (modoDibujoRestauracion && trayectoActual) {
                const estado = document.getElementById('estadoSelect')?.value || 'bueno';
                const color = estado === 'bueno' ? 'blue' : 'red';

                restauracionesTemporales.push({
                    diente: selectedDiente.diente,
                    d: trayectoActual.dataset.dPath,
                    color,
                    estado
                });
                trayectoActual = null;
            }

            if (modoDibujoRestauracionTemporal && trayectoActual) {
                restauracionesTemporales.push({
                    diente: selectedDiente.diente,
                    d: trayectoActual.dataset.dPath,
                    tipo: 'restauracion_temporal'
                });
                trayectoActual = null;
            }

            if (modoDibujoSellante && trayectoActual) {
                const estado = document.getElementById('estadoSelect')?.value || 'bueno';
                const color = estado === 'bueno' ? 'blue' : 'red';

                sellantesTemporales.push({
                    diente: selectedDiente.diente,
                    d: trayectoActual.dataset.dPath,
                    color,
                    estado
                });
                trayectoActual = null;
            }

            if (modoDibujoDesgaste && trayectoActual) {
                const color = 'red';

                desgasteTemporales.push({
                    diente: selectedDiente.diente,
                    d: trayectoActual.dataset.dPath,
                    color
                });
                trayectoActual = null;
            }
        });

        document.querySelectorAll('.odontoseccion').forEach(p => {
            p.addEventListener('click', function (e) {
                const dienteGroup = this.closest('g[id^="P"]');
                if (!dienteGroup) return;

                const diente = dienteGroup.id;
                const seccion = this.id;
                 // ‚úÖ Usar correctamente la nueva funci√≥n
                const zonaTexto = zonaDescriptiva(seccion, diente);
                const numDiente = diente.replace('P', '');
                const option = select.selectedOptions[0];
                const tipo = option?.dataset?.tipo || '';
                // Asignar el tratamiento seleccionado al diente
                const tratamientoSeleccionado = option ? option.textContent : 'Sin tratamiento';
            
                console.log(`Diente: ${numDiente}, Zona: ${zonaTexto}, Tratamiento: ${tratamientoSeleccionado}`);

                // Obtener coordenadas relativas al SVG
                const svg = this.ownerSVGElement;
                const pt = svg.createSVGPoint();
                pt.x = e.clientX;
                pt.y = e.clientY;
                const coords = pt.matrixTransform(svg.getScreenCTM().inverse());

                const x = coords.x.toFixed(2);
                const y = coords.y.toFixed(2);

                console.log(`Diente: ${numDiente}, Secci√≥n: ${seccion}, Coordenadas: x=${x}, y=${y}`);

                if (tipo === 'ortodoncia' || tipo === 'diastema' || tipo === 'fusion' || tipo === 'supernumeraria' || tipo === 'protesis_parcial' || tipo === 'protesis_removible' || tipo === 'transposicion') {
                    if (selectedOrtodoncia.length < 2) {
                        // Evitar duplicados
                        const yaSeleccionado = selectedOrtodoncia.find(sel => sel.diente === diente);
                        if (yaSeleccionado) {
                            Swal.fire('Duplicado', 'Este diente ya ha sido seleccionado.', 'info');
                            return;
                        }

                        selectedOrtodoncia.push({ diente, numDiente: Number(numDiente), x: Number(x), y: Number(y) });
                        infoDiente.innerHTML = `<strong>${tipo === 'diastema' ? 'Diastema' : 'Ortodoncia'}: seleccionado diente ${numDiente}</strong>`;
                    } else {
                        Swal.fire('M√°ximo dos dientes', `Ya seleccionaste dos dientes para ${tipo}.`, 'warning');
                    }
                    //return;
                }
                
                selectedDiente = { diente, seccion, x, y };
                infoDiente.innerHTML = `<strong>Diente ${numDiente} - ${zonaTexto}</strong>`;

            });
        });

        document.getElementById('btnAplicar').addEventListener('click', function () {
            
            const option = select.selectedOptions[0];
            const { value: sigla, dataset: { color, tipo, descripcion } } = option;
            const observaciones = document.getElementById('observaciones').value.trim();
            const svg = document.querySelector('svg');

            if (tipo === 'ortodoncia') {
                if (selectedOrtodoncia.length !== 2) {
                    Swal.fire('Atenci√≥n', 'Debes seleccionar dos dientes para el aparato ortod√≥ntico.', 'warning');
                    return;
                }

                const [inicio, fin] = selectedOrtodoncia;
                const desde = Math.min(inicio.numDiente, fin.numDiente);
                const hasta = Math.max(inicio.numDiente, fin.numDiente);

                // Verificar si ya hay un hallazgo entre los dientes seleccionados
                const existe = hallazgosRegistrados.some(h =>
                    h.tipo === 'ortodoncia' &&
                    ((h.desde === desde && h.hasta === hasta) || (h.desde === hasta && h.hasta === desde))
                );

                if (existe) {
                    Swal.fire('Ya existe', 'Ya hay un hallazgo registrado para ese rango de dientes.', 'info');
                    return;
                }
                
                const cx1 = inicio.x;
                const cy1 = inicio.y;
                const cx2 = fin.x;
                const cy2 = fin.y;

                //console.log(`üìç Coordenadas ya guardadas: inicio (${cx1}, ${cy1}) - fin (${cx2}, ${cy2})`);

                let nombre = (sigla === 'AOF') ? 'Aparato Ortod√≥ntico Fijo' : 'Aparato Ortod√≥ntico Removible';

                if (sigla === 'AOF') {
                    const drawSquareWithCross = (x, y, color) => {
                        const group = document.createElementNS(ns, 'g');
                        group.classList.add('ortodoncia-marca');
                        // ‚úÖ Agregar atributos data-desde y data-hasta
                        group.setAttribute('data-desde', desde);
                        group.setAttribute('data-hasta', hasta);

                        const rect = document.createElementNS(ns, 'rect');
                        rect.setAttribute('x', x - 5);
                        rect.setAttribute('y', y - 5);
                        rect.setAttribute('width', 10);
                        rect.setAttribute('height', 10);
                        rect.setAttribute('fill', 'white');
                        rect.setAttribute('stroke', color);
                        rect.setAttribute('stroke-width', 1);
                        group.appendChild(rect);

                        const line1 = document.createElementNS(ns, 'line');
                        line1.setAttribute('x1', x - 4);
                        line1.setAttribute('y1', y - 4);
                        line1.setAttribute('x2', x + 4);
                        line1.setAttribute('y2', y + 4);
                        line1.setAttribute('stroke', color);
                        group.appendChild(line1);

                        const line2 = document.createElementNS(ns, 'line');
                        line2.setAttribute('x1', x + 4);
                        line2.setAttribute('y1', y - 4);
                        line2.setAttribute('x2', x - 4);
                        line2.setAttribute('y2', y + 4);
                        line2.setAttribute('stroke', color);
                        group.appendChild(line2);

                        svg.appendChild(group);
                        return { x, y };
                    };

                    const punto1 = drawSquareWithCross(cx1, cy1, color);
                    const punto2 = drawSquareWithCross(cx2, cy2, color);

                    const lineGroup = document.createElementNS(ns, 'g');
                    lineGroup.classList.add('ortodoncia-marca');
                    // ‚úÖ Agregar atributos data-desde y data-hasta
                    lineGroup.setAttribute('data-desde', desde);
                    lineGroup.setAttribute('data-hasta', hasta);

                    const line = document.createElementNS(ns, 'line');
                    line.setAttribute('x1', punto1.x);
                    line.setAttribute('y1', punto1.y);
                    line.setAttribute('x2', punto2.x);
                    line.setAttribute('y2', punto2.y);
                    line.setAttribute('stroke', color);
                    line.setAttribute('stroke-width', 1.5);
                    lineGroup.appendChild(line);
                    svg.appendChild(lineGroup);

                    infoDiente.innerHTML = `<strong>${nombre}</strong> aplicado de Diente ${desde} a Diente ${hasta}`;

                } else if (sigla === 'AOR') {
                    // Dibujar l√≠nea en zig-zag
                    const drawZigZagLine = (x1, y1, x2, y2, color) => {
                    const zigzag = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                    zigzag.setAttribute("fill", "none");
                    zigzag.setAttribute("stroke", color);
                    zigzag.setAttribute("stroke-width", "1.5");

                    const points = [];
                    const segments = 12;
                    const dx = (x2 - x1) / segments;
                    const dy = (y2 - y1) / segments;
                    const amplitude = 6;

                    for (let i = 0; i <= segments; i++) {
                        const x = Number(x1) + dx * i;
                        let y;
                        if (i % 2 === 0) {
                            y = Number(y1) + dy * i - amplitude;
                        } else {
                            y = Number(y1) + dy * i + amplitude;
                        }
                        points.push(`${x.toFixed(2)},${y.toFixed(2)}`);
                    }

                    zigzag.setAttribute("points", points.join(" "));
                    zigzag.classList.add("ortodoncia-marca");
                    // ‚úÖ Agregar atributos data-desde y data-hasta
                    zigzag.setAttribute("data-desde", desde);
                    zigzag.setAttribute("data-hasta", hasta);
                    svg.appendChild(zigzag);
                };



                    drawZigZagLine(cx1, cy1, cx2, cy2, color);
                    infoDiente.innerHTML = `<strong>${nombre}</strong> aplicado de Diente ${desde} a Diente ${hasta}`;
                }

                // Agregar a la lista visual de hallazgos
                registrarHallazgoDetalle('ortodoncia', `Ortodoncia ${sigla} aplicada de diente ${desde} a ${hasta}`);
                // Agregar al arreglo de hallazgos
                hallazgosRegistrados.push({
                    tipo,
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    desde,
                    hasta,
                    coordenadas: {
                        diente1: { x: inicio.x, y: inicio.y },
                        diente2: { x: fin.x, y: fin.y }
                    }
                });
                // Reset
                //console.log("hallazgosRegistrados", hallazgosRegistrados);
                selectedOrtodoncia = [];
                return;
            } else if (tipo === 'edentulo') {
                const ns = "http://www.w3.org/2000/svg";
                const dientesGrupo = [];

                const esSuperior = sigla === 'ETS';
                const ajusteVertical = esSuperior ? 5 : 95;

                if (esSuperior) {
                    // Dientes superiores: P18 ‚Üí P11, luego P21 ‚Üí P28
                    for (let i = 18; i >= 11; i--) dientesGrupo.push(document.getElementById(`P${i}`));
                    for (let i = 21; i <= 28; i++) dientesGrupo.push(document.getElementById(`P${i}`));
                } else {
                    // Dientes inferiores: P48 ‚Üí P41, luego P31 ‚Üí P38
                    for (let i = 48; i >= 41; i--) dientesGrupo.push(document.getElementById(`P${i}`));
                    for (let i = 31; i <= 38; i++) dientesGrupo.push(document.getElementById(`P${i}`));
                }

                const dientesValidos = dientesGrupo.filter(d => d && d.querySelector('polygon#C'));
                if (dientesValidos.length < 2) {
                    Swal.fire('Error', 'No se encontraron suficientes dientes con pol√≠gono C.', 'error');
                    return;
                }

                //console.log("‚úÖ Dientes v√°lidos:", dientesValidos.map(d => d.id));

                function obtenerCentroAbsoluto(g) {
                    const poly = g.querySelector('polygon#C');
                    const puntos = poly.getAttribute('points').trim().split(/\s+/);
                    let sumX = 0, sumY = 0;
                    puntos.forEach(pt => {
                        const [x, y] = pt.split(',').map(Number);
                        sumX += x;
                        sumY += y;
                    });
                    const cx = sumX / puntos.length;
                    const cy = sumY / puntos.length;

                    let tx = 0, ty = 0;
                    const transform = g.getAttribute('transform');
                    if (transform?.includes('translate')) {
                        const match = transform.match(/translate\(([^,]+),?([^\)]+)?\)/);
                        if (match) {
                            tx = parseFloat(match[1]) || 0;
                            ty = parseFloat(match[2]) || 0;
                        }
                    }

                    return { x: cx + tx, y: cy + ty };
                }

                const centroInicio = obtenerCentroAbsoluto(dientesValidos[0]);
                const inicio = {
                    x: centroInicio.x,
                    y: centroInicio.y + ajusteVertical
                };

                // Coordenada exacta del diente final (28 o 38)
                const fin = esSuperior
                    ? { x: 592.90, y: 15.20 }   // P28
                    : { x: 592.90, y: 284.95 }; // P38 (ajustar si tienes otra coordenada real)

                //console.log(`üéØ L√≠nea desde (${inicio.x}, ${inicio.y}) hasta (${fin.x}, ${fin.y})`);

                const linea = document.createElementNS(ns, 'line');
                linea.setAttribute('x1', inicio.x);
                linea.setAttribute('y1', inicio.y);
                linea.setAttribute('x2', fin.x);
                linea.setAttribute('y2', fin.y);
                linea.setAttribute('stroke', color);
                linea.setAttribute('stroke-width', 2);
                linea.classList.add('edentulo-marca');
                svg.appendChild(linea);

                registrarHallazgoDetalle('edentulo', `${esSuperior ? 'Ed√©ntulo Total Superior' : 'Ed√©ntulo Total Inferior'}`, observaciones);

                hallazgosRegistrados.push({
                    tipo,
                    sigla,
                    color,
                    nombre: esSuperior ? 'Ed√©ntulo Total Superior' : 'Ed√©ntulo Total Inferior',
                    descripcion,
                    observaciones,
                    desde: esSuperior ? 18 : 48, // diente inicial anat√≥mico
                    hasta: esSuperior ? 28 : 38, // diente final anat√≥mico
                    coordenadas: {
                        diente1: { x: inicio.x, y: inicio.y },
                        diente2: { x: fin.x, y: fin.y }
                    }
                });

                infoDiente.innerHTML = `<strong>${sigla}</strong> aplicado al maxilar ${esSuperior ? 'superior' : 'inferior'}`;
                return;
            
            } else if (tipo === 'protesis_total') {
                const ns = "http://www.w3.org/2000/svg";
                const dientesGrupo = [];

                const esSuperior = sigla === 'PTS';
                const ajusteVertical = esSuperior ? 5 : 95;

                if (esSuperior) {
                    // Dientes superiores: P18 ‚Üí P11, luego P21 ‚Üí P28
                    for (let i = 18; i >= 11; i--) dientesGrupo.push(document.getElementById(`P${i}`));
                    for (let i = 21; i <= 28; i++) dientesGrupo.push(document.getElementById(`P${i}`));
                } else {
                    // Dientes inferiores: P48 ‚Üí P41, luego P31 ‚Üí P38
                    for (let i = 48; i >= 41; i--) dientesGrupo.push(document.getElementById(`P${i}`));
                    for (let i = 31; i <= 38; i++) dientesGrupo.push(document.getElementById(`P${i}`));
                }

                const dientesValidos = dientesGrupo.filter(d => d && d.querySelector('polygon#C'));
                if (dientesValidos.length < 2) {
                    Swal.fire('Error', 'No se encontraron suficientes dientes con pol√≠gono C.', 'error');
                    return;
                }

                //console.log("‚úÖ Dientes v√°lidos:", dientesValidos.map(d => d.id));

                function obtenerCentroAbsoluto(g) {
                    const poly = g.querySelector('polygon#C');
                    const puntos = poly.getAttribute('points').trim().split(/\s+/);
                    let sumX = 0, sumY = 0;
                    puntos.forEach(pt => {
                        const [x, y] = pt.split(',').map(Number);
                        sumX += x;
                        sumY += y;
                    });
                    const cx = sumX / puntos.length;
                    const cy = sumY / puntos.length;

                    let tx = 0, ty = 0;
                    const transform = g.getAttribute('transform');
                    if (transform?.includes('translate')) {
                        const match = transform.match(/translate\(([^,]+),?([^\)]+)?\)/);
                        if (match) {
                            tx = parseFloat(match[1]) || 0;
                            ty = parseFloat(match[2]) || 0;
                        }
                    }

                    return { x: cx + tx, y: cy + ty };
                }

                const centroInicio = obtenerCentroAbsoluto(dientesValidos[0]);
                const inicio = {
                    x: centroInicio.x,
                    y: centroInicio.y + ajusteVertical
                };

                // Coordenada exacta del diente final (28 o 38)
                const fin = esSuperior
                    ? { x: 592.90, y: 15.20 }   // P28
                    : { x: 592.90, y: 284.95 }; // P38 (ajustar si tienes otra coordenada real)

                console.log(`üéØ L√≠nea desde (${inicio.x}, ${inicio.y}) hasta (${fin.x}, ${fin.y})`);

                for (let i = 0; i < 2; i++) {
                    const yOffset = esSuperior ? -i * 4 : i * 4; // separaci√≥n hacia arriba o abajo
                    const linea = document.createElementNS(ns, 'line');
                    linea.setAttribute('x1', inicio.x);
                    linea.setAttribute('y1', inicio.y + yOffset - (esSuperior ? 15 : -15)); // subir o bajar +5
                    linea.setAttribute('x2', fin.x);
                    linea.setAttribute('y2', fin.y + yOffset - (esSuperior ? 15 : -15));
                    linea.setAttribute('stroke', color);
                    linea.setAttribute('stroke-width', 2);
                    linea.classList.add('protesis_total-marca');
                    svg.appendChild(linea);
                }

                registrarHallazgoDetalle('protesis_total', `${esSuperior ? 'Pr√≥tesis Total Superior' : 'Pr√≥tesis Total Inferior'}`, observaciones);

                hallazgosRegistrados.push({
                    tipo,
                    sigla,
                    color,
                    nombre: esSuperior ? 'Pr√≥tesis Total Superior' : 'Pr√≥tesis Total Inferior',
                    descripcion,
                    observaciones,
                    desde: esSuperior ? 18 : 48, // diente inicial anat√≥mico
                    hasta: esSuperior ? 28 : 38, // diente final anat√≥mico
                    coordenadas: {
                        diente1: { x: inicio.x, y: inicio.y },
                        diente2: { x: fin.x, y: fin.y }
                    }
                });

                infoDiente.innerHTML = `<strong>${sigla}</strong> aplicado al maxilar ${esSuperior ? 'superior' : 'inferior'}`;
                return;
            } else if (tipo === 'transposicion') {
                if (selectedOrtodoncia.length !== 2) {
                    Swal.fire('Atenci√≥n', 'Debe seleccionar dos dientes adyacentes para transposici√≥n.', 'warning');
                    return;
                }

                const [d1, d2] = selectedOrtodoncia;
                const num1 = parseInt(d1.numDiente);
                const num2 = parseInt(d2.numDiente);

                if (Math.abs(num1 - num2) !== 1) {
                    Swal.fire('Error', 'Los dientes seleccionados deben ser adyacentes.', 'error');
                    return;
                }

                const color = 'blue';
                const svg = document.querySelector("svg");
                const ns = "http://www.w3.org/2000/svg";

                const dienteIzq = num1 < num2 ? d1 : d2;
                const dienteDer = num1 < num2 ? d2 : d1;

                // === Coordenadas base
                // === Calcular punto medio y base
                const yBase = Math.min(dienteIzq.y, dienteDer.y) - 9; // Altura uniforme para ambas flechas
                const offset = 9; // Separaci√≥n horizontal desde el centro del diente

                // === Flecha 1: izquierda ‚Üí derecha
                const xInicio1 = dienteIzq.x - offset; // borde izquierdo del diente izquierdo
                const xFin1    = dienteDer.x - offset; // borde izquierdo del diente derecho

                // === Flecha 2: derecha ‚Üí izquierda
                const xInicio2 = dienteDer.x + offset; // borde derecho del diente derecho
                const xFin2    = dienteIzq.x + offset; // borde derecho del diente izquierdo

                // Altura es la misma para ambos
                const yBase1 = yBase2 = yBase + 1;

                // === Flecha 1: izquierda a derecha
                const path1 = document.createElementNS(ns, "path");
                path1.setAttribute("d", `M ${xInicio1} ${yBase1} C ${xInicio1 + 10} ${yBase1 - 12}, ${xFin1 - 10} ${yBase1 - 12}, ${xFin1} ${yBase1}`);
                path1.setAttribute("stroke", color);
                path1.setAttribute("stroke-width", 2);
                path1.setAttribute("fill", "none");
                path1.setAttribute("marker-end", "url(#flecha-fin)");
                path1.classList.add("transposicion-marca");
                path1.setAttribute("data-desde", dienteIzq.numDiente);
                path1.setAttribute("data-hasta", dienteDer.numDiente);
                svg.appendChild(path1);

                // === Flecha 2: derecha a izquierda
                const path2 = document.createElementNS(ns, "path");
                path2.setAttribute("d", `M ${xInicio2} ${yBase2} C ${xInicio2 - 10} ${yBase2 - 10}, ${xFin2 + 10} ${yBase2 - 10}, ${xFin2} ${yBase2}`);
                path2.setAttribute("stroke", color);
                path2.setAttribute("stroke-width", 2);
                path2.setAttribute("fill", "none");
                path2.setAttribute("marker-end", "url(#flecha-fin)");
                path2.classList.add("transposicion-marca");
                path2.setAttribute("data-desde", dienteIzq.numDiente);
                path2.setAttribute("data-hasta", dienteDer.numDiente);
                svg.appendChild(path2);

                // Crear marcador si no existe
                if (!document.getElementById("flecha-fin")) {
                    const defs = document.createElementNS(ns, "defs");

                    const markerFin = document.createElementNS(ns, "marker");
                    markerFin.setAttribute("id", "flecha-fin");
                    markerFin.setAttribute("markerWidth", "5");
                    markerFin.setAttribute("markerHeight", "5");
                    markerFin.setAttribute("refX", "2.5");
                    markerFin.setAttribute("refY", "2.5");
                    markerFin.setAttribute("orient", "auto");
                    markerFin.setAttribute("markerUnits", "strokeWidth");

                    const arrow = document.createElementNS(ns, "path");
                    arrow.setAttribute("d", "M0,0 L5,2.5 L0,5 Z");
                    arrow.setAttribute("fill", color);

                    markerFin.appendChild(arrow);
                    defs.appendChild(markerFin);
                    svg.prepend(defs);
                }

                const centerX = (dienteIzq.x + dienteDer.x) / 2; // ‚Üê ahora s√≠ existe centerX

                hallazgosRegistrados.push({
                    tipo: 'transposicion',
                    sigla: 'TP',
                    color,
                    nombre: 'Transposici√≥n Dentaria',
                    descripcion: 'Flechas cruzadas entre dientes adyacentes',
                    observaciones: '',
                    diente: `${dienteIzq.diente}-${dienteDer.diente}`,
                    desde: dienteIzq.numDiente,
                    hasta: dienteDer.numDiente,
                    coordenadas: {
                        centro_texto: { x: centerX, y: yBase1 - 6 },
                        flecha1: {
                            x1: xInicio1,
                            x2: xFin1,
                            y: yBase1
                        },
                        flecha2: {
                            x1: xInicio2,
                            x2: xFin2,
                            y: yBase2
                        }
                    }
                });

                registrarHallazgoDetalle('transposicion', `Transposici√≥n entre ${dienteIzq.numDiente} y ${dienteDer.numDiente}`, '');
                selectedOrtodoncia = [];
            
                return;
            }

            // === OTROS TIPOS DE TRATAMIENTO ===
            if (!selectedDiente) {
                Swal.fire('Error', 'Seleccione un diente y una zona primero.', 'error');
                return;
            }
            const zonaId = `${selectedDiente.diente}-${selectedDiente.seccion || tipo}`;
            const yaExiste = hallazgosRegistrados.some(h => h.zonaId === zonaId);
            if (yaExiste) {
                Swal.fire('Zona ocupada', 'Ya existe un hallazgo en esa zona.', 'warning');
                return;
            }
            const g = document.getElementById(selectedDiente.diente);
            //console.log("selectedDiente.diente",selectedDiente.diente);
            //console.log("g",g);
            const numPieza = selectedDiente.diente.replace(/\D/g, '');

            if (!g) {
                Swal.fire('Error', 'No se encontr√≥ el diente seleccionado en el SVG.', 'error');
                return;
            }

            if (tipo === 'fractura') {
                if (!selectedDiente) {
                    Swal.fire('Atenci√≥n', 'Debe seleccionar un diente antes de aplicar el hallazgo.', 'warning');
                    return;
                }

                //console.log("selectedDiente.diente",selectedDiente.diente);
                const dienteSeleccionado = selectedDiente.diente;
                const fracturasDiente = fracturasTemporales.filter(f => f.diente === dienteSeleccionado);
                //console.log("dienteSeleccionado",dienteSeleccionado);
                //console.log("fracturasTemporales",fracturasTemporales);
                if (fracturasDiente.length === 0) {
                    Swal.fire('Atenci√≥n', 'Debe dibujar al menos una l√≠nea de fractura sobre el diente.', 'warning');
                    return;
                }

                const zonaId = `FD-${dienteSeleccionado}`;
                const yaExiste = hallazgosRegistrados.some(h => h.zonaId === zonaId && h.tipo === 'fractura');
                let nombre = 'Fractura Dental';
                
                if (yaExiste) {
                    Swal.fire('Ya registrado', 'Ya existe una fractura dental en este diente.', 'info');
                    return;
                }
                
                registrarHallazgoDetalle('FD', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);
                
                fracturasDiente.forEach((fx, index) => {
                    hallazgosRegistrados.push({
                        tipo,
                        sigla,
                        color,
                        nombre,
                        descripcion,
                        observaciones,
                        diente: numPieza,
                        zonaId: `${zonaId}-${index + 1}`,
                        coordenadas: {
                            x1: fx.x1,
                            y1: fx.y1,
                            x2: fx.x2,
                            y2: fx.y2
                        }
                    });
                });

                infoDiente.innerHTML = `<strong>${descripcion}</strong> aplicado en diente ${numPieza}`;

                // Limpiar solo las fracturas del diente actual
                fracturasTemporales = fracturasTemporales.filter(f => f.diente !== dienteSeleccionado);
                // ‚úÖ Restablecer cursor y estado
                modoDibujoFD = false;
                svg.style.cursor = 'default';

                // (Opcional) Deseleccionar diente
                // selectedDiente = null;
            }

            if (tipo === 'caries') {
                if (!selectedDiente) {
                    Swal.fire('Atenci√≥n', 'Debe seleccionar un diente.', 'warning');
                    return;
                }

                const dienteSeleccionado = selectedDiente.diente;
                const seccion = selectedDiente.seccion;
                const zonaId = `CA-${dienteSeleccionado}-${seccion}`;
                const yaExiste = hallazgosRegistrados.some(h => h.zonaId === zonaId && h.tipo === 'caries');

                if (yaExiste) {
                    Swal.fire('Ya registrado', 'Ya existe una caries en esa secci√≥n del diente.', 'info');
                    return;
                }

                const nombre = 'Lesi√≥n de Caries Dental';

                // Pintar directamente el pol√≠gono de la secci√≥n seleccionada
                const poligono = document.querySelector(`#${dienteSeleccionado} > polygon[id="${seccion}"]`);
                if (poligono) {
                    poligono.setAttribute('fill', 'red');
                }

                registrarHallazgoDetalle('CA', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                hallazgosRegistrados.push({
                    tipo,
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: numPieza,
                    zonaId
                });

                const siglaText = document.getElementById(`sigla-${dienteSeleccionado}`);
                if (siglaText) {
                    siglaText.textContent = sigla;
                    siglaText.setAttribute('fill', 'red');
                }

                infoDiente.innerHTML = `<strong>${descripcion}</strong> aplicado en diente ${numPieza}`;
                selectedDiente = null;
            }

            if (tipo === 'pulpotomia') {
                if (!selectedDiente) {
                    Swal.fire('Atenci√≥n', 'Debe seleccionar un diente.', 'warning');
                    return;
                }

                const dienteSeleccionado = selectedDiente.diente;
                const seccion = selectedDiente.seccion;
                const zonaId = `PP-${dienteSeleccionado}-${seccion}`;
                const yaExiste = hallazgosRegistrados.some(h => h.zonaId === zonaId && h.tipo === 'pulpotomia');

                if (yaExiste) {
                    Swal.fire('Ya registrado', 'Ya existe una pulpotom√≠a en esa secci√≥n.', 'info');
                    return;
                }

                const nombre = 'Pulpotom√≠a';
                const estado = document.getElementById('estadoSelect').value;
                const color = estado === 'bueno' ? 'blue' : 'red';

                const poligono = document.querySelector(`#${dienteSeleccionado} > polygon[id="${seccion}"]`);
                if (poligono) {
                    poligono.setAttribute('fill', color);
                }

                registrarHallazgoDetalle('PP', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                hallazgosRegistrados.push({
                    tipo,
                    sigla,
                    color,
                    estado,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: numPieza,
                    zonaId
                });

                const siglaText = document.getElementById(`sigla-${dienteSeleccionado}`);
                if (siglaText) {
                    siglaText.textContent = sigla;
                    siglaText.setAttribute('fill', color);
                }

                infoDiente.innerHTML = `<strong>${descripcion}</strong> aplicado en diente ${numPieza}`;
                selectedDiente = null;
            } else if (tipo === 'restauracion_definitiva') {
                if (!selectedDiente) {
                    Swal.fire('Atenci√≥n', 'Debe seleccionar un diente.', 'warning');
                    return;
                }

                const dienteSeleccionado = selectedDiente.diente;
                const restauraciones = restauracionesTemporales.filter(r => r.diente === dienteSeleccionado);
                if (restauraciones.length === 0) {
                    Swal.fire('Atenci√≥n', 'Debe dibujar al menos una restauraci√≥n dentro del diente.', 'warning');
                    return;
                }

                const zonaId = `RD-${dienteSeleccionado}`;
                const yaExiste = hallazgosRegistrados.some(h => h.zonaId === zonaId && h.tipo === 'restauracion_definitiva');
                if (yaExiste) {
                    Swal.fire('Ya registrado', 'Ya existe una restauraci√≥n en este diente.', 'info');
                    return;
                }
                const nombre = 'Restauraci√≥n Definitiva';
                registrarHallazgoDetalle('RD', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);
                const estado = document.getElementById('estadoSelect').value;
                const color = estado === 'bueno' ? 'blue' : 'red';

                const siglaText = document.getElementById(`sigla-${dienteSeleccionado}`);
                if (siglaText) {
                    siglaText.textContent = sigla;
                    siglaText.setAttribute('fill', color);
                }

                restauraciones.forEach((r, index) => {
                    hallazgosRegistrados.push({
                        tipo,
                        sigla,
                        color,
                        nombre,
                        descripcion,
                        observaciones,
                        diente: numPieza,
                        zonaId: `${zonaId}-${index + 1}`,
                        path_svg: r.d
                    });
                });

                infoDiente.innerHTML = `<strong>${descripcion}</strong> aplicado en diente ${numPieza}`;
                restauracionesTemporales = restauracionesTemporales.filter(r => r.diente !== dienteSeleccionado);

                modoDibujoRestauracion = false;
                svg.style.cursor = 'default';
                desactivarCursorRestauracion();
            } else if (tipo === 'restauracion_temporal') {
                if (!selectedDiente) {
                    Swal.fire('Atenci√≥n', 'Debe seleccionar un diente.', 'warning');
                    return;
                }

                const dienteSeleccionado = selectedDiente.diente;
                const numPieza = dienteSeleccionado.replace('P', '');
                const restauraciones = document.querySelectorAll(`.restauracion-temporal-marca[data-diente="${dienteSeleccionado}"]`);

                if (restauraciones.length === 0) {
                    Swal.fire('Atenci√≥n', 'Debe dibujar al menos un trazo de restauraci√≥n temporal.', 'warning');
                    return;
                }

                const zonaId = `RT-${dienteSeleccionado}`;
                const yaExiste = hallazgosRegistrados.some(h => h.zonaId === zonaId && h.tipo === 'restauracion_temporal');
                if (yaExiste) {
                    Swal.fire('Ya registrado', 'Ya existe una restauraci√≥n temporal en este diente.', 'info');
                    return;
                }

                const nombre = 'Restauraci√≥n Temporal';
                const estado = 'malo'; // por defecto siempre rojo
                const color = 'red';

                registrarHallazgoDetalle('RT', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                restauraciones.forEach((path, index) => {
                    hallazgosRegistrados.push({
                        tipo,
                        sigla,
                        color,
                        nombre,
                        descripcion,
                        observaciones,
                        estado,
                        diente: numPieza,
                        zonaId: `${zonaId}-${index + 1}`,
                        path_svg: path.getAttribute('d')
                    });
                });

                infoDiente.innerHTML = `<strong>${descripcion}</strong> aplicado en diente ${numPieza}`;

                // Eliminar marcas temporales
                document.querySelectorAll(`.restauracion-temporal-marca[data-diente="${dienteSeleccionado}"]`).forEach(p => p.classList.remove('restauracion-temporal-marca'));

                modoDibujoRestauracionTemporal = false;
                svg.style.cursor = 'default';
                desactivarCursorRestauracion();
            } else if (tipo === 'sellante') {
                if (!selectedDiente) {
                    Swal.fire('Atenci√≥n', 'Debe seleccionar un diente.', 'warning');
                    return;
                }

                const dienteSeleccionado = selectedDiente.diente;
                const numPieza = dienteSeleccionado.replace('P', '');
                const sellantes = sellantesTemporales.filter(r => r.diente === dienteSeleccionado);
                if (sellantes.length === 0) {
                    Swal.fire('Atenci√≥n', 'Debe dibujar al menos un trazo de sellante.', 'warning');
                    return;
                }

                const zonaId = `SE-${dienteSeleccionado}`;
                const yaExiste = hallazgosRegistrados.some(h => h.zonaId === zonaId && h.tipo === 'sellante');
                if (yaExiste) {
                    Swal.fire('Ya registrado', 'Ya existe un sellante en este diente.', 'info');
                    return;
                }

                const nombre = 'Sellante';
                const estado = document.getElementById('estadoSelect').value;
                const color = estado === 'bueno' ? 'blue' : 'red';

                registrarHallazgoDetalle('SE', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                const siglaText = document.getElementById(`sigla-${dienteSeleccionado}`);
                if (siglaText) {
                    siglaText.textContent = sigla;
                    siglaText.setAttribute('fill', color);
                }

                sellantes.forEach((r, index) => {
                    hallazgosRegistrados.push({
                        tipo,
                        sigla,
                        color,
                        nombre,
                        descripcion,
                        observaciones,
                        estado,
                        diente: numPieza,
                        zonaId: `${zonaId}-${index + 1}`,
                        path_svg: r.d
                    });
                });

                infoDiente.innerHTML = `<strong>${descripcion}</strong> aplicado en diente ${numPieza}`;
                sellantesTemporales = sellantesTemporales.filter(r => r.diente !== dienteSeleccionado);

                modoDibujoSellante = false;
                svg.style.cursor = 'default';
                desactivarCursorSellante();
            } else if (tipo === 'desgaste') {
                if (!selectedDiente) {
                    Swal.fire('Atenci√≥n', 'Debe seleccionar un diente.', 'warning');
                    return;
                }

                const dienteSeleccionado = selectedDiente.diente;
                const numPieza = dienteSeleccionado.replace('P', '');
                const desgaste = desgasteTemporales.filter(r => r.diente === dienteSeleccionado);
                if (desgaste.length === 0) {
                    Swal.fire('Atenci√≥n', 'Debe dibujar al menos un trazo de desgaste.', 'warning');
                    return;
                }

                const zonaId = `DES-${dienteSeleccionado}`;
                const yaExiste = hallazgosRegistrados.some(h => h.zonaId === zonaId && h.tipo === 'desgaste');
                if (yaExiste) {
                    Swal.fire('Ya registrado', 'Ya existe un desgaste en este diente.', 'info');
                    return;
                }

                const nombre = 'Superficie Desgastada';
                const color = 'red';

                registrarHallazgoDetalle('DES', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                const siglaText = document.getElementById(`sigla-${dienteSeleccionado}`);
                if (siglaText) {
                    siglaText.textContent = sigla;
                    siglaText.setAttribute('fill', color);
                }

                desgaste.forEach((r, index) => {
                    hallazgosRegistrados.push({
                        tipo,
                        sigla,
                        color,
                        nombre,
                        descripcion,
                        observaciones,
                        
                        diente: numPieza,
                        zonaId: `${zonaId}-${index + 1}`,
                        path_svg: r.d
                    });
                });

                infoDiente.innerHTML = `<strong>${descripcion}</strong> aplicado en diente ${numPieza}`;
                desgasteTemporales = desgasteTemporales.filter(r => r.diente !== dienteSeleccionado);

                modoDibujoDesgaste = false;
                svg.style.cursor = 'default';
                desactivarCursorDesgaste();
            }


            if (tipo === 'corona') {
                // Si es CT (Corona Temporal), color siempre rojo
                const isTemporal = sigla === 'CT';
                const estado = document.getElementById('estadoSelect').value;
                const color = isTemporal ? 'red' : (estado === 'bueno' ? 'blue' : 'red');

                // Buscar el tratamiento por sigla
                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla);

                if (!tratamientoSeleccionado && !isTemporal) {
                    console.warn("Tratamiento no encontrado:", sigla);
                    return;
                }
                // Asignar el nombre del tratamiento a la nueva constante
                const nombreSeleccionado = isTemporal 
                    ? 'Corona Temporal' 
                    : tratamientoSeleccionado.nombre;

                const descripcion = isTemporal
                    ? 'Corona temporal (material y caracter√≠sticas espec√≠ficas a detallar)'
                    : tratamientoSeleccionado.descripcion;

                // Remover cualquier borde anterior
                const existingRect = g.querySelector('rect.borde-corona');
                if (existingRect) {
                    existingRect.remove();
                }

                // Calcular los l√≠mites de los pol√≠gonos para el borde general
                const polygons = Array.from(g.querySelectorAll('polygon'));
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

                polygons.forEach(p => {
                    const points = p.getAttribute('points').trim().split(/\s+/);
                    points.forEach(pt => {
                        const [x, y] = pt.split(',').map(Number);
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    });
                });

                // Dibujar borde rectangular general
                const padding = 1.5;
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', minX - padding);
                rect.setAttribute('y', minY - padding);
                rect.setAttribute('width', (maxX - minX) + padding * 2);
                rect.setAttribute('height', (maxY - minY) + padding * 2);
                rect.setAttribute('stroke', color);
                rect.setAttribute('fill', 'none');
                rect.setAttribute('stroke-width', '1.5');
                rect.setAttribute('class', 'borde-corona');
                g.appendChild(rect);

                // Pintar los pol√≠gonos de blanco
                polygons.forEach(p => {
                    p.setAttribute('fill', 'white');
                    p.setAttribute('stroke', '#8B4513');
                    p.setAttribute('stroke-width', '0.5');
                });

                // Asignar sigla al <text id="sigla-P##">
                const textElement = document.querySelector(`#sigla-P${numPieza}`);
                if (textElement) {
                    textElement.textContent = sigla;
                    textElement.setAttribute("fill", color);
                    textElement.setAttribute("title", `${observaciones} - ${descripcion}`);
                }
                registrarHallazgoDetalle('corona', `${nombreSeleccionado} ${sigla} aplicada a diente ${numPieza}`, observaciones);

                const coordenadasCorona = {
                    diente: {
                        x1: minX,
                        y1: minY,
                        x2: maxX,
                        y2: maxY
                    },
                    centro_texto: {
                        x: (minX + maxX) / 2,
                        y: (minY + maxY) / 2
                    }
                };
                
                // Guardar en arreglo
                hallazgosRegistrados.push({
                    tipo,
                    sigla,
                    color,
                    nombre: nombreSeleccionado,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    seccion: selectedDiente.seccion,
                    zonaId,
                    coordenadas: coordenadasCorona
                });
            } else if (tipo === 'dde') {
                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla && t.tipo === 'dde');

                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento DDE no encontrado para sigla:", sigla);
                    return;
                }

                const { nombre, descripcion, color } = tratamientoSeleccionado;

                // Asignar texto de la sigla en el centro del diente
                const siglaId = `sigla-P${numPieza}`;
                let textElement = document.querySelector(`#${siglaId}`);

                if (!textElement) {
                    // Crear si no existe
                    const centroX = selectedDiente.centroX || 10;
                    const centroY = selectedDiente.centroY || 10;
                    textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textElement.setAttribute('id', siglaId);
                    textElement.setAttribute('x', centroX);
                    textElement.setAttribute('y', centroY);
                    textElement.setAttribute('text-anchor', 'middle');
                    textElement.setAttribute('dominant-baseline', 'middle');
                    textElement.setAttribute('font-size', '10');
                    textElement.setAttribute('font-weight', 'bold');
                    g.appendChild(textElement);
                }

                textElement.textContent = sigla;
                textElement.setAttribute("fill", color);
                textElement.setAttribute("title", `${observaciones} - ${descripcion}`);

                registrarHallazgoDetalle('DDE', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                hallazgosRegistrados.push({
                    tipo: 'dde',
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    seccion: selectedDiente.seccion,
                    zonaId
                });
            } else if (tipo === 'diastema') {
                if (selectedOrtodoncia.length !== 2) {
                    Swal.fire('Atenci√≥n', 'Debes seleccionar dos dientes adyacentes para el diastema.', 'warning');
                    return;
                }

                const [inicio, fin] = selectedOrtodoncia;
                const desde = Math.min(inicio.numDiente, fin.numDiente);
                const hasta = Math.max(inicio.numDiente, fin.numDiente);

                // Validar que est√©n juntos
                if (Math.abs(desde - hasta) !== 1) {
                    Swal.fire('Error', 'Los dientes seleccionados deben ser consecutivos para el diastema.', 'warning');
                    return;
                }

                const x1 = parseFloat(inicio.x);
                const y1 = parseFloat(inicio.y);
                const x2 = parseFloat(fin.x);
                const y2 = parseFloat(fin.y);

                const yTop = Math.min(y1, y2) - 10;
                const yBottom = Math.max(y1, y2) + 10;
                const yMid = (yTop + yBottom) / 2;

                const svgGroup = document.createElementNS(ns, 'g');
                svgGroup.classList.add('ortodoncia-marca');
                svgGroup.setAttribute('data-desde', desde);
                svgGroup.setAttribute('data-hasta', hasta);

                // Par√©ntesis cerrado ")" para el diente izquierdo
                const path1 = document.createElementNS(ns, 'path');
                path1.setAttribute('d', `M ${x1 + 5},${yTop} Q ${x1 + 10},${yMid} ${x1 + 5},${yBottom}`);
                path1.setAttribute('stroke', 'blue');
                path1.setAttribute('stroke-width', 2);
                path1.setAttribute('fill', 'none');

                // Par√©ntesis abierto "(" para el diente derecho
                const path2 = document.createElementNS(ns, 'path');
                path2.setAttribute('d', `M ${x2 - 3},${yTop} Q ${x2 - 10},${yMid} ${x2 - 3},${yBottom}`);
                path2.setAttribute('stroke', 'blue');
                path2.setAttribute('stroke-width', 2);
                path2.setAttribute('fill', 'none');

                svgGroup.appendChild(path1);
                svgGroup.appendChild(path2);
                svg.appendChild(svgGroup);

                // Guardar en arreglo
                hallazgosRegistrados.push({
                    tipo: 'diastema',
                    sigla: 'DIA',
                    color: 'blue',
                    nombre: 'Diastema',
                    descripcion: 'Par√©ntesis invertidos entre dientes adyacentes',
                    observaciones: '',
                    desde,
                    hasta,
                    coordenadas: {
                        x1, y1, x2, y2
                    }
                });

                registrarHallazgoDetalle('diastema', `Diastema entre dientes ${desde} y ${hasta}`, '');
                selectedOrtodoncia = [];
            } else if (tipo === 'espigo') {
                const estado = document.getElementById('estadoSelect').value;
                const color = estado === 'bueno' ? 'blue' : 'red';

                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla);
                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento ESPIGO no encontrado:", sigla);
                    return;
                }

                const nombre = tratamientoSeleccionado.nombre;
                const descripcion = tratamientoSeleccionado.descripcion;

                const polygons = Array.from(g.querySelectorAll('polygon'));
                if (polygons.length === 0) {
                    Swal.fire('Error', 'Este diente no tiene pol√≠gonos.', 'warning');
                    return;
                }

                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                polygons.forEach(p => {
                    const points = p.getAttribute('points').trim().split(/\s+/);
                    points.forEach(pt => {
                        const [x, y] = pt.split(',').map(Number);
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    });
                });

                // Obtener translate(x, y) del diente
                let tx = 0, ty = 0;
                const transform = g.getAttribute('transform');
                if (transform?.includes('translate')) {
                    const match = transform.match(/translate\(([^,]+),\s*([^)]+)\)/);
                    if (match) {
                        tx = parseFloat(match[1]) || 0;
                        ty = parseFloat(match[2]) || 0;
                    }
                }

                // Calcular centro en coordenadas locales
                const centroLocal = {
                    x: (minX + maxX) / 2,
                    y: (minY + maxY) / 2
                };

                // Aplicar translate del diente
                const centroDiente = {
                    x: centroLocal.x + tx,
                    y: centroLocal.y + ty
                };

                // Aplicar escala del grupo padre <g transform="scale(1.5)">
                const scale = 1.5;
                const centroEscalado = {
                    x: centroDiente.x * scale,
                    y: centroDiente.y * scale
                };

                const ySuperior = centroEscalado.y - 15;

                console.log({
                    diente: selectedDiente.diente,
                    centroLocal,
                    centroDiente,
                    centroEscalado,
                    scale
                });

                // üîπ Remover anteriores
                svg.querySelectorAll(`.espigo-munon-marca[data-diente="P${numPieza}"]`).forEach(el => el.remove());

                // üîπ Dibujar l√≠nea
                const linea = document.createElementNS(ns, 'line');
                linea.setAttribute('x1', centroEscalado.x);
                linea.setAttribute('y1', centroEscalado.y);
                linea.setAttribute('x2', centroEscalado.x);
                linea.setAttribute('y2', ySuperior);
                linea.setAttribute('stroke', color);
                linea.setAttribute('stroke-width', 1.5);
                linea.classList.add('espigo-munon-marca');
                linea.setAttribute('data-diente', `P${numPieza}`); // ‚úÖ A√±adir identificador
                svg.appendChild(linea);

                // üîπ Dibujar cuadrado
                const size = 8;
                const square = document.createElementNS(ns, 'rect');
                square.setAttribute('x', centroEscalado.x - size / 2);
                square.setAttribute('y', centroEscalado.y - size / 2);
                square.setAttribute('width', size);
                square.setAttribute('height', size);
                square.setAttribute('fill', 'white');
                square.setAttribute('stroke', color);
                square.setAttribute('stroke-width', 1.5);
                square.classList.add('espigo-munon-marca');
                square.setAttribute('data-diente', `P${numPieza}`); // ‚úÖ Igual aqu√≠
                svg.appendChild(square);

                // Asignar sigla
                const textElement = document.querySelector(`#sigla-P${numPieza}`);
                if (textElement) {
                    textElement.textContent = sigla;
                    textElement.setAttribute("fill", color);
                    textElement.setAttribute("title", `${observaciones} - ${descripcion}`);
                }

                registrarHallazgoDetalle('espigo', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                hallazgosRegistrados.push({
                    tipo,
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    desde: numPieza,
                    hasta: numPieza,
                    seccion: selectedDiente.seccion,
                    zonaId,
                    coordenadas: {
                        diente: {
                            x1: centroEscalado.x,
                            y1: centroEscalado.y,
                            x2: centroEscalado.x,
                            y2: ySuperior
                        },
                        centro_texto: {
                            x: centroEscalado.x,
                            y: (centroEscalado.y + ySuperior) / 2
                        }
                    }
                });
            } else if (tipo === 'ffp') {
                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla && t.tipo === 'ffp');

                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento DDE no encontrado para sigla:", sigla);
                    return;
                }

                const { nombre, descripcion, color } = tratamientoSeleccionado;

                // Asignar texto de la sigla en el centro del diente
                const siglaId = `sigla-P${numPieza}`;
                let textElement = document.querySelector(`#${siglaId}`);

                if (!textElement) {
                    // Crear si no existe
                    const centroX = selectedDiente.centroX || 10;
                    const centroY = selectedDiente.centroY || 10;
                    textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textElement.setAttribute('id', siglaId);
                    textElement.setAttribute('x', centroX);
                    textElement.setAttribute('y', centroY);
                    textElement.setAttribute('text-anchor', 'middle');
                    textElement.setAttribute('dominant-baseline', 'middle');
                    textElement.setAttribute('font-size', '10');
                    textElement.setAttribute('font-weight', 'bold');
                    g.appendChild(textElement);
                }

                textElement.textContent = sigla;
                textElement.setAttribute("fill", color);
                textElement.setAttribute("title", `${observaciones} - ${descripcion}`);

                registrarHallazgoDetalle('FFP', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                hallazgosRegistrados.push({
                    tipo: 'ffp',
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    seccion: selectedDiente.seccion,
                    zonaId
                });
            } else if (tipo === 'fusion') {
                if (selectedOrtodoncia.length !== 2) {
                    Swal.fire('Atenci√≥n', 'Debes seleccionar dos dientes contiguos para Fusi√≥n.', 'warning');
                    return;
                }

                const [inicio, fin] = selectedOrtodoncia;
                const desde = Math.min(inicio.numDiente, fin.numDiente);
                const hasta = Math.max(inicio.numDiente, fin.numDiente);

                if (Math.abs(desde - hasta) !== 1) {
                    Swal.fire('Error', 'Los dientes seleccionados deben ser consecutivos.', 'warning');
                    return;
                }

                const obtenerPosTextoNumero = (numDiente) => {
                    const grupo = document.querySelector(`#P${numDiente}`);
                    if (!grupo) {
                        console.warn(`‚ùå No se encontr√≥ el grupo #P${numDiente}`);
                        return null;
                    }

                    // Buscar el <text> cuyo contenido es el n√∫mero del diente
                    const textos = grupo.querySelectorAll('text');
                    let textoNumero = null;

                    textos.forEach(t => {
                        const contenido = t.textContent.trim();
                        if (contenido === String(numDiente)) {
                            textoNumero = t;
                        }
                    });

                    if (!textoNumero) {
                        console.warn(`‚ùå No se encontr√≥ el texto con el n√∫mero ${numDiente} en #P${numDiente}`);
                        return null;
                    }

                    const x = parseFloat(textoNumero.getAttribute('x'));
                    const y = parseFloat(textoNumero.getAttribute('y'));

                    // Extraer translate del grupo
                    const transform = grupo.getAttribute('transform');
                    let offsetX = 0, offsetY = 0;
                    if (transform && transform.includes('translate')) {
                        const match = transform.match(/translate\(([\d.-]+),\s*([\d.-]+)\)/);
                        if (match) {
                            offsetX = parseFloat(match[1]);
                            offsetY = parseFloat(match[2]);
                        }
                    }

                    // Escala global aplicada en <g id="gmain">
                    const escala = 1.5;
                    const absX = (x + offsetX) * escala;
                    const absY = (y + offsetY) * escala;

                    console.log(`üìç Diente ${numDiente}: x=${x}, y=${y}, offset=(${offsetX},${offsetY}) ‚Üí abs=(${absX}, ${absY}) con escala ${escala}`);
                    return { x: absX, y: absY };
                };

                const pos1 = obtenerPosTextoNumero(desde);
                const pos2 = obtenerPosTextoNumero(hasta);


                if (!pos1 || !pos2) {
                    Swal.fire('Error', 'No se pudo obtener la posici√≥n de los n√∫meros de los dientes.', 'error');
                    return;
                }

                const ns = "http://www.w3.org/2000/svg";
                const svgGroup = document.createElementNS(ns, "g");
                svgGroup.classList.add('ortodoncia-marca');
                svgGroup.setAttribute('data-desde', desde);
                svgGroup.setAttribute('data-hasta', hasta);

                const radio = 10;
                const interseccion = 5;

                // Dibujar dos c√≠rculos interceptados
                const ellipse1 = document.createElementNS(ns, 'ellipse');
                ellipse1.setAttribute('cx', pos1.x + 9);      // mueve a la derecha
                ellipse1.setAttribute('cy', pos1.y - 5);      // baja un poco menos
                ellipse1.setAttribute('rx', 18);              // ancho
                ellipse1.setAttribute('ry', 8);               // alto
                ellipse1.setAttribute('stroke', 'blue');
                ellipse1.setAttribute('stroke-width', 1.5);
                ellipse1.setAttribute('fill', 'none');

                const ellipse2 = document.createElementNS(ns, 'ellipse');
                ellipse2.setAttribute('cx', pos2.x + 2);      // ya est√° m√°s a la derecha
                ellipse2.setAttribute('cy', pos2.y - 5);      // misma altura que el otro
                ellipse2.setAttribute('rx', 18);
                ellipse2.setAttribute('ry', 8);
                ellipse2.setAttribute('stroke', 'blue');
                ellipse2.setAttribute('stroke-width', 1.5);
                ellipse2.setAttribute('fill', 'none');

                svgGroup.appendChild(ellipse1);
                svgGroup.appendChild(ellipse2);

                document.querySelector('svg').appendChild(svgGroup);

                // Registrar hallazgo
                hallazgosRegistrados.push({
                    tipo: 'fusion',
                    sigla: 'FUS',
                    color: 'blue',
                    nombre: 'Fusi√≥n',
                    descripcion: 'Dos dientes con circunferencias interceptadas (fusi√≥n)',
                    observaciones: '',
                    desde,
                    hasta,
                    coordenadas: {
                        x1: pos1.x,
                        y1: pos1.y,
                        x2: pos2.x,
                        y2: pos2.y
                    }
                });

                registrarHallazgoDetalle('fusion', `Fusi√≥n entre dientes ${desde} y ${hasta}`, '');
                selectedOrtodoncia = [];
            } else if (tipo === 'geminacion') {
                if (!selectedDiente || !selectedDiente.diente) {
                    console.warn("‚ö†Ô∏è selectedDiente no v√°lido:", selectedDiente);
                    Swal.fire('Atenci√≥n', 'Debes seleccionar un solo diente para Geminaci√≥n.', 'warning');
                    return;
                }

                const numDiente = parseInt(selectedDiente.diente.replace('P', '')); // convierte 'P21' ‚Üí 21

                const obtenerPosTextoNumero = (numDiente) => {
                    const grupo = document.querySelector(`#P${numDiente}`);
                    if (!grupo) {
                        console.warn(`‚ùå No se encontr√≥ el grupo #P${numDiente}`);
                        return null;
                    }

                    const textos = grupo.querySelectorAll('text');
                    let textoNumero = null;

                    textos.forEach(t => {
                        const contenido = t.textContent.trim();
                        if (contenido === String(numDiente)) {
                            textoNumero = t;
                        }
                    });

                    if (!textoNumero) {
                        console.warn(`‚ùå No se encontr√≥ el n√∫mero ${numDiente} en #P${numDiente}`);
                        return null;
                    }

                    const x = parseFloat(textoNumero.getAttribute('x'));
                    const y = parseFloat(textoNumero.getAttribute('y'));

                    const transform = grupo.getAttribute('transform');
                    let offsetX = 0, offsetY = 0;
                    if (transform && transform.includes('translate')) {
                        const match = transform.match(/translate\(([\d.-]+),\s*([\d.-]+)\)/);
                        if (match) {
                            offsetX = parseFloat(match[1]);
                            offsetY = parseFloat(match[2]);
                        }
                    }

                    const escala = 1.5;
                    const absX = (x + offsetX) * escala;
                    const absY = (y + offsetY) * escala;

                    console.log(`üîµ GEMINACI√ìN P${numDiente}: x=${x}, y=${y}, offset=(${offsetX},${offsetY}) ‚Üí abs=(${absX}, ${absY})`);
                    return { x: absX, y: absY };
                };

                const pos = obtenerPosTextoNumero(numDiente);
                if (!pos) {
                    Swal.fire('Error', 'No se pudo obtener la posici√≥n del n√∫mero del diente.', 'error');
                    return;
                }

                const ns = "http://www.w3.org/2000/svg";
                const svgGroup = document.createElementNS(ns, "g");
                svgGroup.classList.add('ortodoncia-marca');
                svgGroup.setAttribute('data-diente', numDiente);

                const elipse = document.createElementNS(ns, 'ellipse');
                elipse.setAttribute('cx', pos.x + 6); // ajustar horizontalmente
                elipse.setAttribute('cy', pos.y - 4); // bajar un poquito
                elipse.setAttribute('rx', 12);
                elipse.setAttribute('ry', 8);
                elipse.setAttribute('stroke', 'blue');
                elipse.setAttribute('stroke-width', 1.5);
                elipse.setAttribute('fill', 'none');

                svgGroup.appendChild(elipse);
                document.querySelector('svg').appendChild(svgGroup);

                hallazgosRegistrados.push({
                    tipo: 'geminacion',
                    sigla: 'GEM',
                    color: 'blue',
                    nombre: 'Geminaci√≥n',
                    descripcion: 'Una pieza dentaria con circunferencia azul que encierra su n√∫mero',
                    observaciones: '',
                    diente: numDiente,
                    coordenadas: {
                        x: pos.x,
                        y: pos.y
                    }
                });

                registrarHallazgoDetalle('geminacion', `Geminaci√≥n en diente ${numDiente}`, '');
                //selectedDiente = null;

            } else if (tipo === 'giroversion') {
                if (!selectedDiente || !selectedDiente.diente) {
                    Swal.fire('Atenci√≥n', 'Debes seleccionar un diente para aplicar Giroversi√≥n.', 'warning');
                    return;
                }

                const numDiente = parseInt(selectedDiente.diente.replace('P', ''));

                const select = document.getElementById('tratamientoSelect');
                const selectedOption = select.options[select.selectedIndex];
                const sentido = selectedOption.dataset.sentido || 'horario';
                console.log("sentido",sentido);

                const g = document.getElementById(`P${numDiente}`);
                if (!g) {
                    Swal.fire('Error', 'No se encontr√≥ el diente seleccionado.', 'error');
                    return;
                }

                // Buscar la posici√≥n Y m√°s baja del pol√≠gono (para colocar la flecha debajo del diente)
                let yMax = -Infinity;
                g.querySelectorAll('polygon').forEach(pol => {
                    const points = pol.getAttribute('points').trim().split(/\s+/);
                    points.forEach(pt => {
                        const [x, y] = pt.split(',').map(Number);
                        const transform = g.getAttribute('transform');
                        const [dx, dy] = transform.match(/-?\d+\.?\d*/g)?.map(Number) || [0, 0];
                        const globalY = (y + dy) * 1.5;
                        if (globalY > yMax) yMax = globalY;
                    });
                });

                const centerX = parseFloat(selectedDiente.x);
                const baseY = yMax + 4; // posici√≥n ligeramente debajo del diente

                const radiusX = 10; // üîπ Aumentado para mayor anchura horizontal
                const radiusY = 4;  // üîπ Mantiene la curvatura suave

                const x1 = sentido === 'horario' ? centerX - radiusX : centerX + radiusX;
                const x2 = sentido === 'horario' ? centerX + radiusX : centerX - radiusX;

                const y = baseY;

                const sweepFlag = sentido === 'horario' ? 0 : 1; // curva hacia abajo

                const pathData = `M ${x1} ${y} A ${radiusX} ${radiusY} 0 0 ${sweepFlag} ${x2} ${y}`;


                const ns = "http://www.w3.org/2000/svg";
                const path = document.createElementNS(ns, "path");
                path.setAttribute("d", pathData);
                path.setAttribute("stroke", "blue");
                path.setAttribute("stroke-width", 2.1);
                path.setAttribute("fill", "none");
                if (sentido === 'horario') {
                    path.setAttribute("marker-start", "url(#flecha-inicio)");
                    console.log("horario");
                } else {
                    path.setAttribute("marker-start", "url(#flecha-fin)");
                    console.log("antihorario");
                }

                path.classList.add("giroversion-marca");
                path.setAttribute("data-diente", `P${numDiente}`);
                path.setAttribute("data-sentido", sentido);

                const svg = document.querySelector("svg");
                svg.appendChild(path);

                // Asegurarse que el marcador exista
                if (!document.getElementById("flecha-inicio")) {
                    const defs = document.createElementNS(ns, "defs");

                    // ‚¨ÖÔ∏è Flecha para el inicio (m√°s a la izquierda)
                    const markerInicio = document.createElementNS(ns, "marker");
                    markerInicio.setAttribute("id", "flecha-inicio");
                    markerInicio.setAttribute("markerWidth", "5");
                    markerInicio.setAttribute("markerHeight", "5");
                    markerInicio.setAttribute("refX", "0.5"); // üîπ M√°s a la izquierda
                    markerInicio.setAttribute("refY", "2.5");
                    markerInicio.setAttribute("orient", "auto");
                    markerInicio.setAttribute("markerUnits", "strokeWidth");

                    const arrowInicio = document.createElementNS(ns, "path");
                    arrowInicio.setAttribute("d", "M0,0 L5,2.5 L0,5 Z");
                    arrowInicio.setAttribute("fill", "blue");
                    markerInicio.appendChild(arrowInicio);
                    defs.appendChild(markerInicio);

                    // ‚û°Ô∏è Flecha para el final
                    const markerFin = document.createElementNS(ns, "marker");
                    markerFin.setAttribute("id", "flecha-fin");
                    markerFin.setAttribute("markerWidth", "5");
                    markerFin.setAttribute("markerHeight", "5");
                    markerFin.setAttribute("refX", "2.5"); // Valor est√°ndar
                    markerFin.setAttribute("refY", "2.5");
                    markerFin.setAttribute("orient", "auto");
                    markerFin.setAttribute("markerUnits", "strokeWidth");

                    const arrowFin = document.createElementNS(ns, "path");
                    arrowFin.setAttribute("d", "M0,0 L5,2.5 L0,5 Z");
                    arrowFin.setAttribute("fill", "blue");
                    markerFin.appendChild(arrowFin);
                    defs.appendChild(markerFin);

                    svg.prepend(defs);
                }

                // Registrar en el array
                hallazgosRegistrados.push({
                    tipo: 'giroversion',
                    sigla: sentido === 'horario' ? 'GVH' : 'GVA',
                    color: 'blue',
                    nombre: 'Giroversi√≥n',
                    descripcion: `Flecha curva azul sentido ${sentido}`,
                    observaciones: '',
                    diente: numDiente,
                    coordenadas: {
                        x1, y1: y,
                        x2, y2: y
                    },
                    sentido: sentido
                });

                registrarHallazgoDetalle('giroversion', `Giroversi√≥n (${sentido}) en diente ${numDiente}`, '');

            } else if (tipo === 'impactacion') {
                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla && t.tipo === 'impactacion');

                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento DDE no encontrado para sigla:", sigla);
                    return;
                }

                const { nombre, descripcion, color } = tratamientoSeleccionado;

                // Asignar texto de la sigla en el centro del diente
                const siglaId = `sigla-P${numPieza}`;
                let textElement = document.querySelector(`#${siglaId}`);

                if (!textElement) {
                    // Crear si no existe
                    const centroX = selectedDiente.centroX || 10;
                    const centroY = selectedDiente.centroY || 10;
                    textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textElement.setAttribute('id', siglaId);
                    textElement.setAttribute('x', centroX);
                    textElement.setAttribute('y', centroY);
                    textElement.setAttribute('text-anchor', 'middle');
                    textElement.setAttribute('dominant-baseline', 'middle');
                    textElement.setAttribute('font-size', '10');
                    textElement.setAttribute('font-weight', 'bold');
                    g.appendChild(textElement);
                }

                textElement.textContent = sigla;
                textElement.setAttribute("fill", color);
                textElement.setAttribute("title", `${observaciones} - ${descripcion}`);

                registrarHallazgoDetalle('I', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                hallazgosRegistrados.push({
                    tipo: 'impactacion',
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    seccion: selectedDiente.seccion,
                    zonaId
                });
            } else if (tipo === 'imp') {

                const estado = document.getElementById('estadoSelect').value;
                const color = estado === 'bueno' ? 'blue' : 'red';
                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla && t.tipo === 'imp');

                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento IMP no encontrado para sigla:", sigla);
                    return;
                }

                const { nombre, descripcion } = tratamientoSeleccionado;

                // Asignar texto de la sigla en el centro del diente
                const siglaId = `sigla-P${numPieza}`;
                let textElement = document.querySelector(`#${siglaId}`);

                if (!textElement) {
                    // Crear si no existe
                    const centroX = selectedDiente.centroX || 10;
                    const centroY = selectedDiente.centroY || 10;
                    textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textElement.setAttribute('id', siglaId);
                    textElement.setAttribute('x', centroX);
                    textElement.setAttribute('y', centroY);
                    textElement.setAttribute('text-anchor', 'middle');
                    textElement.setAttribute('dominant-baseline', 'middle');
                    textElement.setAttribute('font-size', '10');
                    textElement.setAttribute('font-weight', 'bold');
                    g.appendChild(textElement);
                }

                textElement.textContent = sigla;
                textElement.setAttribute("fill", color);
                textElement.setAttribute("title", `${observaciones} - ${descripcion}`);

                registrarHallazgoDetalle('I', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                hallazgosRegistrados.push({
                    tipo: 'imp',
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    seccion: selectedDiente.seccion,
                    zonaId
                });
            } else if (tipo === 'mac') {
                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla && t.tipo === 'mac');

                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento IMP no encontrado para sigla:", sigla);
                    return;
                }

                const { nombre, descripcion, color } = tratamientoSeleccionado;

                // Asignar texto de la sigla en el centro del diente
                const siglaId = `sigla-P${numPieza}`;
                let textElement = document.querySelector(`#${siglaId}`);

                if (!textElement) {
                    // Crear si no existe
                    const centroX = selectedDiente.centroX || 10;
                    const centroY = selectedDiente.centroY || 10;
                    textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textElement.setAttribute('id', siglaId);
                    textElement.setAttribute('x', centroX);
                    textElement.setAttribute('y', centroY);
                    textElement.setAttribute('text-anchor', 'middle');
                    textElement.setAttribute('dominant-baseline', 'middle');
                    textElement.setAttribute('font-size', '10');
                    textElement.setAttribute('font-weight', 'bold');
                    g.appendChild(textElement);
                }

                textElement.textContent = sigla;
                textElement.setAttribute("fill", color);
                textElement.setAttribute("title", `${observaciones} - ${descripcion}`);

                registrarHallazgoDetalle('MAC', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                hallazgosRegistrados.push({
                    tipo: 'mac',
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    seccion: selectedDiente.seccion,
                    zonaId
                });
            } else if (tipo === 'mic') {
                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla && t.tipo === 'mic');

                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento IMP no encontrado para sigla:", sigla);
                    return;
                }

                const { nombre, descripcion, color } = tratamientoSeleccionado;

                // Asignar texto de la sigla en el centro del diente
                const siglaId = `sigla-P${numPieza}`;
                let textElement = document.querySelector(`#${siglaId}`);

                if (!textElement) {
                    // Crear si no existe
                    const centroX = selectedDiente.centroX || 10;
                    const centroY = selectedDiente.centroY || 10;
                    textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textElement.setAttribute('id', siglaId);
                    textElement.setAttribute('x', centroX);
                    textElement.setAttribute('y', centroY);
                    textElement.setAttribute('text-anchor', 'middle');
                    textElement.setAttribute('dominant-baseline', 'middle');
                    textElement.setAttribute('font-size', '10');
                    textElement.setAttribute('font-weight', 'bold');
                    g.appendChild(textElement);
                }

                textElement.textContent = sigla;
                textElement.setAttribute("fill", color);
                textElement.setAttribute("title", `${observaciones} - ${descripcion}`);

                registrarHallazgoDetalle('MIC', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                hallazgosRegistrados.push({
                    tipo: 'mic',
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    seccion: selectedDiente.seccion,
                    zonaId
                });
            } else if (tipo === 'mp') {
                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla && t.tipo === 'mp');

                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento IMP no encontrado para sigla:", sigla);
                    return;
                }

                const { nombre, descripcion, color } = tratamientoSeleccionado;

                // Asignar texto de la sigla en el centro del diente
                const siglaId = `sigla-P${numPieza}`;
                let textElement = document.querySelector(`#${siglaId}`);

                if (!textElement) {
                    // Crear si no existe
                    const centroX = selectedDiente.centroX || 10;
                    const centroY = selectedDiente.centroY || 10;
                    textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textElement.setAttribute('id', siglaId);
                    textElement.setAttribute('x', centroX);
                    textElement.setAttribute('y', centroY);
                    textElement.setAttribute('text-anchor', 'middle');
                    textElement.setAttribute('dominant-baseline', 'middle');
                    textElement.setAttribute('font-size', '10');
                    textElement.setAttribute('font-weight', 'bold');
                    g.appendChild(textElement);
                }

                textElement.textContent = sigla;
                textElement.setAttribute("fill", color);
                textElement.setAttribute("title", `${observaciones} - ${descripcion}`);

                registrarHallazgoDetalle('MP', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                hallazgosRegistrados.push({
                    tipo: 'mp',
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    seccion: selectedDiente.seccion,
                    zonaId
                });
            } else if (tipo === 'ausente') {
                const color = 'blue';

                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla);
                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento AUSENTE no encontrado:", sigla);
                    return;
                }

                const nombre = tratamientoSeleccionado.nombre;
                const descripcion = tratamientoSeleccionado.descripcion;

                const polygons = Array.from(g.querySelectorAll('polygon'));
                if (polygons.length === 0) {
                    Swal.fire('Error', 'Este diente no tiene pol√≠gonos.', 'warning');
                    return;
                }

                // Obtener bounding box local del diente
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                polygons.forEach(p => {
                    const points = p.getAttribute('points').trim().split(/\s+/);
                    points.forEach(pt => {
                        const [x, y] = pt.split(',').map(Number);
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    });
                });

                // Obtener transform (translate) del diente
                let tx = 0, ty = 0;
                const transform = g.getAttribute('transform');
                if (transform?.includes('translate')) {
                    const match = transform.match(/translate\(([^,]+),\s*([^)]+)\)/);
                    if (match) {
                        tx = parseFloat(match[1]) || 0;
                        ty = parseFloat(match[2]) || 0;
                    }
                }

                const scale = 1.5;
                const x1 = (minX + tx) * scale;
                const y1 = (minY + ty) * scale;
                const x2 = (maxX + tx) * scale;
                const y2 = (maxY + ty) * scale;

                // üîπ Remover anteriores
                svg.querySelectorAll(`.ausente-marca[data-diente="P${numPieza}"]`).forEach(el => el.remove());

                // üîπ Dibujar cruz (aspa)
                const line1 = document.createElementNS(ns, 'line');
                line1.setAttribute('x1', x1);
                line1.setAttribute('y1', y1);
                line1.setAttribute('x2', x2);
                line1.setAttribute('y2', y2);
                line1.setAttribute('stroke', color);
                line1.setAttribute('stroke-width', 2);
                line1.classList.add('ausente-marca');
                line1.setAttribute('data-diente', `P${numPieza}`);
                svg.appendChild(line1);

                const line2 = document.createElementNS(ns, 'line');
                line2.setAttribute('x1', x2);
                line2.setAttribute('y1', y1);
                line2.setAttribute('x2', x1);
                line2.setAttribute('y2', y2);
                line2.setAttribute('stroke', color);
                line2.setAttribute('stroke-width', 2);
                line2.classList.add('ausente-marca');
                line2.setAttribute('data-diente', `P${numPieza}`);
                svg.appendChild(line2);

                // üîπ Agregar sigla
                const textElement = document.querySelector(`#sigla-P${numPieza}`);
                if (textElement) {
                    textElement.textContent = sigla;
                    textElement.setAttribute("fill", color);
                    textElement.setAttribute("title", `${observaciones} - ${descripcion}`);
                }

                registrarHallazgoDetalle('ausente', `${nombre} (${sigla}) aplicada a diente ${numPieza}`, observaciones);

                // Guardar coordenadas
                const coordenadas = {
                    diente: {
                        x1, y1, x2, y2
                    },
                    centro_texto: {
                        x: (x1 + x2) / 2,
                        y: (y1 + y2) / 2
                    }
                };

                hallazgosRegistrados.push({
                    tipo,
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    desde: numPieza,
                    hasta: numPieza,
                    seccion: selectedDiente.seccion,
                    zonaId,
                    coordenadas
                });
            } else if (tipo === 'clavija') {
                const color = 'blue';

                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla);
                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento CLAVIJA no encontrado:", sigla);
                    return;
                }

                const nombre = tratamientoSeleccionado.nombre;
                const descripcion = tratamientoSeleccionado.descripcion;

                const polygons = Array.from(g.querySelectorAll('polygon'));
                if (polygons.length === 0) {
                    Swal.fire('Error', 'Este diente no tiene pol√≠gonos.', 'warning');
                    return;
                }

                // Calcular bounding box local del diente
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                polygons.forEach(p => {
                    const points = p.getAttribute('points').trim().split(/\s+/);
                    points.forEach(pt => {
                        const [x, y] = pt.split(',').map(Number);
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    });
                });

                // Obtener translate(x, y)
                let tx = 0, ty = 0;
                const transform = g.getAttribute('transform');
                if (transform?.includes('translate')) {
                    const match = transform.match(/translate\(([^,]+),\s*([^)]+)\)/);
                    if (match) {
                        tx = parseFloat(match[1]) || 0;
                        ty = parseFloat(match[2]) || 0;
                    }
                }

                const scale = 1.5;
                const numPieza = parseInt(selectedDiente.diente.replace('P', ''), 10);

                // Coordenadas para tri√°ngulo superior centrado
                const offsetX = (minX + maxX) / 2;
                const topY = minY;

                const cx = (offsetX + tx) * scale;
                const cy = (topY + ty) * scale - 8; // subir el tri√°ngulo sobre la corona
                const size = 6;

                // Remover anteriores
                svg.querySelectorAll(`.clavija-marca[data-diente="P${numPieza}"]`).forEach(el => el.remove());

                // Dibujar tri√°ngulo
                const triangle = document.createElementNS(ns, 'polygon');
                const points = [
                    `${cx},${cy}`,                          // v√©rtice superior
                    `${cx - size},${cy + size}`,           // esquina inferior izquierda
                    `${cx + size},${cy + size}`            // esquina inferior derecha
                ].join(' ');
                triangle.setAttribute('points', points);
                triangle.setAttribute('stroke', color);
                triangle.setAttribute('fill', 'none');
                triangle.setAttribute('stroke-width', 1.5);
                triangle.classList.add('clavija-marca');
                triangle.setAttribute('data-diente', `P${numPieza}`);
                svg.appendChild(triangle);

                // Agregar sigla
                const textElement = document.querySelector(`#sigla-P${numPieza}`);
                if (textElement) {
                    textElement.textContent = sigla;
                    textElement.setAttribute("fill", color);
                    textElement.setAttribute("title", `${observaciones} - ${descripcion}`);
                }

                registrarHallazgoDetalle('clavija', `${nombre} (${sigla}) aplicada a diente ${numPieza}`, observaciones);

                const coordenadas = {
                    diente: {
                        cx, cy
                    },
                    centro_texto: {
                        x: cx,
                        y: cy + size / 2
                    }
                };

                hallazgosRegistrados.push({
                    tipo,
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    desde: numPieza,
                    hasta: numPieza,
                    seccion: selectedDiente.seccion,
                    zonaId,
                    coordenadas
                });
            } else if (tipo === 'ectopica') {
                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla && t.tipo === 'ectopica');

                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento IMP no encontrado para sigla:", sigla);
                    return;
                }

                const { nombre, descripcion, color } = tratamientoSeleccionado;

                // Asignar texto de la sigla en el centro del diente
                const siglaId = `sigla-P${numPieza}`;
                let textElement = document.querySelector(`#${siglaId}`);

                if (!textElement) {
                    // Crear si no existe
                    const centroX = selectedDiente.centroX || 10;
                    const centroY = selectedDiente.centroY || 10;
                    textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textElement.setAttribute('id', siglaId);
                    textElement.setAttribute('x', centroX);
                    textElement.setAttribute('y', centroY);
                    textElement.setAttribute('text-anchor', 'middle');
                    textElement.setAttribute('dominant-baseline', 'middle');
                    textElement.setAttribute('font-size', '10');
                    textElement.setAttribute('font-weight', 'bold');
                    g.appendChild(textElement);
                }

                textElement.textContent = sigla;
                textElement.setAttribute("fill", color);
                textElement.setAttribute("title", `${observaciones} - ${descripcion}`);

                registrarHallazgoDetalle('ECT', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                hallazgosRegistrados.push({
                    tipo: 'ectopica',
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    seccion: selectedDiente.seccion,
                    zonaId
                });
            } else if (tipo === 'erupcion') {
                const color = 'blue';

                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla);
                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento ERUPCI√ìN no encontrado:", sigla);
                    return;
                }

                const nombre = tratamientoSeleccionado.nombre;
                const descripcion = tratamientoSeleccionado.descripcion;

                const polygons = Array.from(g.querySelectorAll('polygon'));
                if (polygons.length === 0) {
                    Swal.fire('Error', 'Este diente no tiene pol√≠gonos.', 'warning');
                    return;
                }

                // Calcular el bounding box del diente
                let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                polygons.forEach(p => {
                    const points = p.getAttribute('points').trim().split(/\s+/);
                    points.forEach(pt => {
                        const [x, y] = pt.split(',').map(Number);
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    });
                });

                // Obtener transformaciones del diente
                const transform = g.getAttribute('transform');
                let tx = 0, ty = 0;
                if (transform?.includes('translate')) {
                    const match = transform.match(/translate\(([^,]+),\s*([^)]+)\)/);
                    if (match) {
                        tx = parseFloat(match[1]) || 0;
                        ty = parseFloat(match[2]) || 0;
                    }
                }

                const scale = 1.5;
                const cx = (minX + maxX) / 2; // centro X
                const startX = (cx + tx) * scale;
                const baseY = (maxY + ty + 2) * scale;     // parte inferior del diente
                const topY = (minY + ty - 4) * scale;      // parte superior del diente

                // Construir puntos en zigzag desde abajo hacia arriba
                const zigzagPoints = [
                    [startX, baseY],
                    [startX - 4, baseY - 6],
                    [startX + 4, baseY - 12],
                    [startX - 4, baseY - 18],
                    [startX + 4, baseY - 24],
                    [startX, topY]
                ];

                const ns = "http://www.w3.org/2000/svg";
                const zigzag = document.createElementNS(ns, 'polyline');
                zigzag.setAttribute('points', zigzagPoints.map(p => p.join(',')).join(' '));
                zigzag.setAttribute('stroke', color);
                zigzag.setAttribute('stroke-width', 2);
                zigzag.setAttribute('fill', 'none');
                zigzag.classList.add('erupcion-marca');
                zigzag.setAttribute('data-diente', `P${numPieza}`);
                svg.appendChild(zigzag);

                // Agregar sigla
                const textElement = document.querySelector(`#sigla-P${numPieza}`);
                if (textElement) {
                    textElement.textContent = sigla;
                    textElement.setAttribute("fill", color);
                    textElement.setAttribute("title", `${observaciones} - ${descripcion}`);
                }

                registrarHallazgoDetalle('erupcion', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                hallazgosRegistrados.push({
                    tipo,
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    desde: numPieza,
                    hasta: numPieza,
                    seccion: selectedDiente.seccion,
                    zonaId,
                    coordenadas: {
                        diente: {}, // opcional
                        centro_texto: { x: startX, y: baseY } // punto base
                    }
                });
            } else if (tipo === 'extruida') {
                const color = 'blue';
                const numDiente = selectedDiente?.diente?.replace('P', '');
                const dienteId = `P${numDiente}`;
                const g = document.getElementById(dienteId);

                if (!g) {
                    Swal.fire('Error', 'Diente no encontrado en el SVG.', 'error');
                    return;
                }

                // Rango de dientes superiores (flecha hacia arriba)
                const dientesSuperiores = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28,55,54,53,52,51,61,62,63,64,65];
                const esSuperior = dientesSuperiores.includes(parseInt(numDiente));

                // Calcular bounding box del grupo del diente
                const polygons = Array.from(g.querySelectorAll('polygon'));
                if (polygons.length === 0) return;

                let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                polygons.forEach(p => {
                    const puntos = p.getAttribute('points').trim().split(/\s+/);
                    puntos.forEach(pt => {
                        const [x, y] = pt.split(',').map(Number);
                        minX = Math.min(minX, x);
                        maxX = Math.max(maxX, x);
                        minY = Math.min(minY, y);
                        maxY = Math.max(maxY, y);
                    });
                });

                const scale = 1.5;
                const tx = parseFloat(g.getAttribute('transform')?.match(/translate\(([^,]+),\s*([^)]+)\)/)?.[1]) || 0;
                const ty = parseFloat(g.getAttribute('transform')?.match(/translate\(([^,]+),\s*([^)]+)\)/)?.[2]) || 0;

                const centerX = ((minX + maxX) / 2 + tx) * scale;

                // Flecha m√°s corta: 14px en lugar de 20
                const longFlecha = 14;
                const baseY = esSuperior
                ? (maxY + ty - 15) * scale   // m√°s abajo en dientes superiores
                : (minY + ty + 15) * scale;  // m√°s arriba en dientes inferiores

                const endY = esSuperior ? baseY - longFlecha : baseY + longFlecha;

                const ns = "http://www.w3.org/2000/svg";
                const svg = document.querySelector('svg');

                // L√≠nea principal
                const line = document.createElementNS(ns, 'line');
                line.setAttribute('x1', centerX);
                line.setAttribute('y1', baseY);
                line.setAttribute('x2', centerX);
                line.setAttribute('y2', endY);
                line.setAttribute('stroke', color);
                line.setAttribute('stroke-width', 2);
                line.classList.add('extruida-marca');
                line.setAttribute('data-diente', dienteId);
                svg.appendChild(line);

                // Puntas
                const arrowOffset = 4;
                const puntaY = esSuperior ? endY + 5 : endY - 5;

                const arrow1 = document.createElementNS(ns, 'line');
                arrow1.setAttribute('x1', centerX - arrowOffset);
                arrow1.setAttribute('y1', puntaY);
                arrow1.setAttribute('x2', centerX);
                arrow1.setAttribute('y2', endY);
                arrow1.setAttribute('stroke', color);
                arrow1.setAttribute('stroke-width', 2);
                arrow1.classList.add('extruida-marca');
                arrow1.setAttribute('data-diente', dienteId);
                svg.appendChild(arrow1);

                const arrow2 = document.createElementNS(ns, 'line');
                arrow2.setAttribute('x1', centerX + arrowOffset);
                arrow2.setAttribute('y1', puntaY);
                arrow2.setAttribute('x2', centerX);
                arrow2.setAttribute('y2', endY);
                arrow2.setAttribute('stroke', color);
                arrow2.setAttribute('stroke-width', 2);
                arrow2.classList.add('extruida-marca');
                arrow2.setAttribute('data-diente', dienteId);
                svg.appendChild(arrow2);

                // Datos para el backend
                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla);
                const nombre = tratamientoSeleccionado?.nombre || '';
                const descripcion = tratamientoSeleccionado?.descripcion || '';

                const coordenadas = {
                    centro_texto: { x: centerX, y: baseY }
                };

                hallazgosRegistrados.push({
                    tipo,
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: dienteId,
                    desde: parseInt(numDiente),
                    hasta: parseInt(numDiente),
                    seccion: selectedDiente?.seccion || null,
                    zonaId,
                    coordenadas
                });

                registrarHallazgoDetalle(
                    tipo,
                    `${nombre} (${sigla}) aplicado en diente ${numDiente}`,
                    observaciones
                );
            } else if (tipo === 'intruida') {
                const color = 'blue';
                const numDiente = selectedDiente?.diente?.replace('P', '');
                const dienteId = `P${numDiente}`;
                const g = document.getElementById(dienteId);
                const svg = document.querySelector('svg');

                if (!g || !svg) {
                    Swal.fire('Error', 'Diente no encontrado en el SVG.', 'error');
                    return;
                }

                // Dientes superiores
                const dientesSuperiores = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28,55,54,53,52,51,61,62,63,64,65];
                const esSuperior = dientesSuperiores.includes(parseInt(numDiente));

                // Calcular bounding box del grupo del diente
                const polygons = Array.from(g.querySelectorAll('polygon'));
                if (polygons.length === 0) return;

                let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                polygons.forEach(p => {
                    const puntos = p.getAttribute('points').trim().split(/\s+/);
                    puntos.forEach(pt => {
                        const [x, y] = pt.split(',').map(Number);
                        minX = Math.min(minX, x);
                        maxX = Math.max(maxX, x);
                        minY = Math.min(minY, y);
                        maxY = Math.max(maxY, y);
                    });
                });

                const scale = 1.5;
                const tx = parseFloat(g.getAttribute('transform')?.match(/translate\(([^,]+),\s*([^)]+)\)/)?.[1]) || 0;
                const ty = parseFloat(g.getAttribute('transform')?.match(/translate\(([^,]+),\s*([^)]+)\)/)?.[2]) || 0;

                const centerX = ((minX + maxX) / 2 + tx) * scale;

                // Flecha m√°s corta: 14px
                const longFlecha = 14;
                const baseY = esSuperior
                    ? (minY + ty - 5) * scale  // parte superior
                    : (maxY + ty + 5) * scale; // parte inferior

                const endY = esSuperior ? baseY + longFlecha : baseY - longFlecha;

                const ns = "http://www.w3.org/2000/svg";

                // L√≠nea principal
                const line = document.createElementNS(ns, 'line');
                line.setAttribute('x1', centerX);
                line.setAttribute('y1', baseY);
                line.setAttribute('x2', centerX);
                line.setAttribute('y2', endY);
                line.setAttribute('stroke', color);
                line.setAttribute('stroke-width', 2);
                line.classList.add('intruida-marca');
                line.setAttribute('data-diente', dienteId);
                svg.appendChild(line);

                // Flechas
                const arrowOffset = 4;
                const puntaY = esSuperior ? endY - 5 : endY + 5;

                const arrow1 = document.createElementNS(ns, 'line');
                arrow1.setAttribute('x1', centerX - arrowOffset);
                arrow1.setAttribute('y1', puntaY);
                arrow1.setAttribute('x2', centerX);
                arrow1.setAttribute('y2', endY);
                arrow1.setAttribute('stroke', color);
                arrow1.setAttribute('stroke-width', 2);
                arrow1.classList.add('intruida-marca');
                arrow1.setAttribute('data-diente', dienteId);
                svg.appendChild(arrow1);

                const arrow2 = document.createElementNS(ns, 'line');
                arrow2.setAttribute('x1', centerX + arrowOffset);
                arrow2.setAttribute('y1', puntaY);
                arrow2.setAttribute('x2', centerX);
                arrow2.setAttribute('y2', endY);
                arrow2.setAttribute('stroke', color);
                arrow2.setAttribute('stroke-width', 2);
                arrow2.classList.add('intruida-marca');
                arrow2.setAttribute('data-diente', dienteId);
                svg.appendChild(arrow2);

                // Datos para el backend
                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla);
                const nombre = tratamientoSeleccionado?.nombre || '';
                const descripcion = tratamientoSeleccionado?.descripcion || '';

                const coordenadas = {
                    centro_texto: { x: centerX, y: baseY }
                };

                hallazgosRegistrados.push({
                    tipo,
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: dienteId,
                    desde: parseInt(numDiente),
                    hasta: parseInt(numDiente),
                    seccion: selectedDiente?.seccion || null,
                    zonaId,
                    coordenadas
                });

                registrarHallazgoDetalle(
                    tipo,
                    `${nombre} (${sigla}) aplicado en diente ${numDiente}`,
                    observaciones
                );
            } else if (tipo === 'supernumeraria') {
                if (selectedOrtodoncia.length !== 2) {
                    Swal.fire('Atenci√≥n', 'Debes seleccionar dos dientes adyacentes para Supernumeraria.', 'warning');
                    return;
                }

                const [inicio, fin] = selectedOrtodoncia;
                const desde = Math.min(inicio.numDiente, fin.numDiente);
                const hasta = Math.max(inicio.numDiente, fin.numDiente);

                if (Math.abs(desde - hasta) !== 1) {
                    Swal.fire('Error', 'Los dientes seleccionados deben ser adyacentes.', 'warning');
                    return;
                }

                const obtenerPosTextoNumero = (numDiente) => {
                    const grupo = document.querySelector(`#P${numDiente}`);
                    if (!grupo) {
                        console.warn(`‚ùå No se encontr√≥ el grupo #P${numDiente}`);
                        return null;
                    }

                    const textos = grupo.querySelectorAll('text');
                    let textoNumero = null;

                    textos.forEach(t => {
                        const contenido = t.textContent.trim();
                        if (contenido === String(numDiente)) {
                            textoNumero = t;
                        }
                    });

                    if (!textoNumero) {
                        console.warn(`‚ùå No se encontr√≥ el texto con el n√∫mero ${numDiente} en #P${numDiente}`);
                        return null;
                    }

                    const x = parseFloat(textoNumero.getAttribute('x'));
                    const y = parseFloat(textoNumero.getAttribute('y'));

                    const transform = grupo.getAttribute('transform');
                    let offsetX = 5, offsetY = -5;
                    if (transform && transform.includes('translate')) {
                        const match = transform.match(/translate\(([\d.-]+),\s*([\d.-]+)\)/);
                        if (match) {
                            offsetX = parseFloat(match[1]);
                            offsetY = parseFloat(match[2]);
                        }
                    }

                    const escala = 1.5;
                    const absX = (x + offsetX) * escala;
                    const absY = (y + offsetY) * escala;

                    return { x: absX, y: absY };
                };

                const pos1 = obtenerPosTextoNumero(desde);
                const pos2 = obtenerPosTextoNumero(hasta);

                if (!pos1 || !pos2) {
                    Swal.fire('Error', 'No se pudo obtener la posici√≥n de los n√∫meros de los dientes.', 'error');
                    return;
                }

                const midX = (pos1.x + pos2.x) / 2;
                const midY = (pos1.y + pos2.y) / 2;

                const ajusteX = 5;    // derecha
                const ajusteY = -10;   // arriba

                const ns = "http://www.w3.org/2000/svg";

                // Eliminar si ya existe una marca entre los mismos dientes
                const selector = `.supernumeraria-marca[data-super="${desde}-${hasta}"]`;
                document.querySelectorAll(selector).forEach(e => e.remove());

                const grupo = document.createElementNS(ns, 'g');
                grupo.classList.add('supernumeraria-marca');
                grupo.setAttribute('data-super', `${desde}-${hasta}`);

                // C√≠rculo azul con fondo blanco
                const circle = document.createElementNS(ns, 'circle');
                circle.setAttribute('cx', midX + ajusteX);
                circle.setAttribute('cy', midY + ajusteY);
                circle.setAttribute('r', 10);
                circle.setAttribute('stroke', 'blue');
                circle.setAttribute('fill', 'white');
                circle.setAttribute('stroke-width', '1.5');

                // Letra "S" centrada
                const texto = document.createElementNS(ns, 'text');
                texto.setAttribute('x', midX + ajusteX);
                texto.setAttribute('y', midY + ajusteY + 4);
                texto.setAttribute('text-anchor', 'middle');
                texto.setAttribute('font-size', '10');
                texto.setAttribute('fill', 'blue');
                texto.setAttribute('font-weight', 'bold');
                texto.textContent = 'S';

                grupo.appendChild(circle);
                grupo.appendChild(texto);

                document.querySelector('svg').appendChild(grupo);

                // Registrar hallazgo (si usas ese sistema)
                hallazgosRegistrados.push({
                    tipo: 'supernumeraria',
                    sigla: 'SUP',
                    color: 'blue',
                    nombre: 'Supernumeraria',
                    descripcion: 'Circunferencia azul con letra S entre los √°pices de dientes adyacentes',
                    observaciones: '',
                    desde,
                    hasta,
                    coordenadas: { x: midX, y: midY }
                });

                registrarHallazgoDetalle('supernumeraria', `Supernumeraria entre dientes ${desde} y ${hasta}`, '');
                selectedOrtodoncia = [];
            } else if (tipo === 'pos_anormal') {
                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla && t.tipo === 'pos_anormal');

                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento DDE no encontrado para sigla:", sigla);
                    return;
                }

                const { nombre, descripcion, color } = tratamientoSeleccionado;

                // Asignar texto de la sigla en el centro del diente
                const siglaId = `sigla-P${numPieza}`;
                let textElement = document.querySelector(`#${siglaId}`);

                if (!textElement) {
                    // Crear si no existe
                    const centroX = selectedDiente.centroX || 10;
                    const centroY = selectedDiente.centroY || 10;
                    textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textElement.setAttribute('id', siglaId);
                    textElement.setAttribute('x', centroX);
                    textElement.setAttribute('y', centroY);
                    textElement.setAttribute('text-anchor', 'middle');
                    textElement.setAttribute('dominant-baseline', 'middle');
                    textElement.setAttribute('font-size', '10');
                    textElement.setAttribute('font-weight', 'bold');
                    g.appendChild(textElement);
                }

                textElement.textContent = sigla;
                textElement.setAttribute("fill", color);
                textElement.setAttribute("title", `${observaciones} - ${descripcion}`);

                registrarHallazgoDetalle('PAD', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                hallazgosRegistrados.push({
                    tipo: 'pos_anormal',
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    seccion: selectedDiente.seccion,
                    zonaId
                });
            } else if (tipo === 'protesis_parcial') {
                if (selectedOrtodoncia.length !== 2) {
                    Swal.fire('Atenci√≥n', 'Debes seleccionar dos dientes para la pr√≥tesis fija.', 'warning');
                    return;
                }

                const [inicio, fin] = selectedOrtodoncia;
                const desde = Math.min(inicio.numDiente, fin.numDiente);
                const hasta = Math.max(inicio.numDiente, fin.numDiente);

                const existe = hallazgosRegistrados.some(h =>
                    h.tipo === 'protesis_parcial' &&
                    ((h.desde === desde && h.hasta === hasta) || (h.desde === hasta && h.hasta === desde))
                );

                if (existe) {
                    Swal.fire('Ya existe', 'Ya hay una pr√≥tesis registrada entre esos dientes.', 'info');
                    return;
                }

                const svg = document.querySelector('svg');
                const ns = "http://www.w3.org/2000/svg";

                const estado = document.getElementById('estadoSelect').value;
                const color = estado === 'bueno' ? 'blue' : 'red';
                const yOffset = 10;

                const cx1 = inicio.x;
                const cy1 = inicio.y;
                const cx2 = fin.x;
                const cy2 = fin.y;

                // Detectar si son dientes superiores o inferiores
                const dientesSuperiores = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28,55,54,53,52,51,61,62,63,64,65];
                const esSuperior = dientesSuperiores.includes(desde);

                // Ajustes finos para posici√≥n vertical del trazo

                const ajusteFino = 7;

                const yBase = esSuperior
                    ? Math.min(cy1, cy2) - yOffset - ajusteFino  // M√°s arriba para superiores
                    : Math.max(cy1, cy2) + yOffset + ajusteFino; // M√°s abajo para inferiores

                const group = document.createElementNS(ns, 'g');
                group.classList.add('protesis-parcial');
                group.setAttribute('data-desde', desde);
                group.setAttribute('data-hasta', hasta);

                const alturaCorchete = 10; // Altura fija del corchete vertical

                // L√≠nea vertical inicial (izquierda)
                const lineStart = document.createElementNS(ns, 'line');
                lineStart.setAttribute('x1', cx1);
                lineStart.setAttribute('x2', cx1);
                lineStart.setAttribute('y1', esSuperior ? yBase : yBase - alturaCorchete);
                lineStart.setAttribute('y2', esSuperior ? yBase + alturaCorchete : yBase);
                lineStart.setAttribute('stroke', color);
                lineStart.setAttribute('stroke-width', 2);
                group.appendChild(lineStart);

                // L√≠nea horizontal
                const lineMiddle = document.createElementNS(ns, 'line');
                lineMiddle.setAttribute('x1', cx1);
                lineMiddle.setAttribute('y1', yBase);
                lineMiddle.setAttribute('x2', cx2);
                lineMiddle.setAttribute('y2', yBase);
                lineMiddle.setAttribute('stroke', color);
                lineMiddle.setAttribute('stroke-width', 2);
                group.appendChild(lineMiddle);

                // L√≠nea vertical final (derecha)
                const lineEnd = document.createElementNS(ns, 'line');
                lineEnd.setAttribute('x1', cx2);
                lineEnd.setAttribute('x2', cx2);
                lineEnd.setAttribute('y1', esSuperior ? yBase : yBase - alturaCorchete);
                lineEnd.setAttribute('y2', esSuperior ? yBase + alturaCorchete : yBase);
                lineEnd.setAttribute('stroke', color);
                lineEnd.setAttribute('stroke-width', 2);
                group.appendChild(lineEnd);

                svg.appendChild(group);

                hallazgosRegistrados.push({
                    tipo: 'protesis_parcial',
                    sigla: sigla, // 'PPF' o 'PPF_M'
                    color,
                    nombre: 'Pr√≥tesis Dental Parcial Fija',
                    descripcion: 'L√≠nea horizontal con extremos en pilares a nivel de √°pices',
                    observaciones: document.getElementById('observaciones')?.value || '',
                    desde: desde,
                    hasta: hasta,
                    coordenadas: {
                        x1: cx1,
                        y1: yBase,
                        x2: cx2,
                        y2: yBase
                    }
                });

                registrarHallazgoDetalle('protesis_parcial', `Pr√≥tesis parcial fija entre dientes ${desde} y ${hasta}`, '');
            } else if (tipo === 'protesis_removible') {
                if (selectedOrtodoncia.length !== 2) {
                    Swal.fire('Atenci√≥n', 'Debes seleccionar dos dientes para la pr√≥tesis removible.', 'warning');
                    return;
                }

                const [inicio, fin] = selectedOrtodoncia;
                const desde = Math.min(inicio.numDiente, fin.numDiente);
                const hasta = Math.max(inicio.numDiente, fin.numDiente);

                const existe = hallazgosRegistrados.some(h =>
                    h.tipo === 'protesis_removible' &&
                    ((h.desde === desde && h.hasta === hasta) || (h.desde === hasta && h.hasta === desde))
                );

                if (existe) {
                    Swal.fire('Ya existe', 'Ya hay una pr√≥tesis removible registrada entre esos dientes.', 'info');
                    return;
                }

                const svg = document.querySelector('svg');
                const ns = "http://www.w3.org/2000/svg";

                const estado = document.getElementById('estadoSelect').value;
                const color = estado === 'bueno' ? 'blue' : 'red';
                const separacion = 4;

                const cx1 = inicio.x;
                const cy1 = inicio.y;
                const cx2 = fin.x;
                const cy2 = fin.y;

                const dientesSuperiores = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28,55,54,53,52,51,61,62,63,64,65];
                const esSuperior = dientesSuperiores.includes(desde);

                const ajusteFino = 7;
                const yBase = esSuperior
                    ? Math.min(cy1, cy2) - 10 - ajusteFino
                    : Math.max(cy1, cy2) + 10 + ajusteFino;

                const group = document.createElementNS(ns, 'g');
                group.classList.add('protesis-removible');
                group.setAttribute('data-desde', desde);
                group.setAttribute('data-hasta', hasta);

                for (let i = 0; i < 2; i++) {
                    const y = esSuperior ? yBase - i * separacion : yBase + i * separacion;

                    const linea = document.createElementNS(ns, 'line');
                    linea.setAttribute('x1', cx1);
                    linea.setAttribute('x2', cx2);
                    linea.setAttribute('y1', y);
                    linea.setAttribute('y2', y);
                    linea.setAttribute('stroke', color);
                    linea.setAttribute('stroke-width', 2);
                    group.appendChild(linea);
                }

                svg.appendChild(group);

                hallazgosRegistrados.push({
                    tipo: 'protesis_removible',
                    sigla: 'PPR',
                    color,
                    nombre: 'Pr√≥tesis Dental Parcial Removible',
                    descripcion: 'Dos l√≠neas horizontales paralelas a nivel de √°pices',
                    observaciones: document.getElementById('observaciones')?.value || '',
                    desde: desde,
                    hasta: hasta,
                    coordenadas: {
                        x1: cx1,
                        y1: yBase,
                        x2: cx2,
                        y2: yBase
                    }
                });

                registrarHallazgoDetalle(
                    'protesis_removible',
                    `Pr√≥tesis removible entre dientes ${desde} y ${hasta}`,
                    ''
                );
            } else if (tipo === 'remanente') {
                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla && t.tipo === 'remanente');

                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento DDE no encontrado para sigla:", sigla);
                    return;
                }

                const { nombre, descripcion, color } = tratamientoSeleccionado;

                // Asignar texto de la sigla en el centro del diente
                const siglaId = `sigla-P${numPieza}`;
                let textElement = document.querySelector(`#${siglaId}`);

                if (!textElement) {
                    // Crear si no existe
                    const centroX = selectedDiente.centroX || 10;
                    const centroY = selectedDiente.centroY || 10;
                    textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textElement.setAttribute('id', siglaId);
                    textElement.setAttribute('x', centroX);
                    textElement.setAttribute('y', centroY);
                    textElement.setAttribute('text-anchor', 'middle');
                    textElement.setAttribute('dominant-baseline', 'middle');
                    textElement.setAttribute('font-size', '10');
                    textElement.setAttribute('font-weight', 'bold');
                    g.appendChild(textElement);
                }

                textElement.textContent = sigla;
                textElement.setAttribute("fill", color);
                textElement.setAttribute("title", `${observaciones} - ${descripcion}`);

                registrarHallazgoDetalle('RR', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                hallazgosRegistrados.push({
                    tipo: 'remanente',
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    seccion: selectedDiente.seccion,
                    zonaId
                });
            } else if (tipo === 'conducto') {
                const estado = document.getElementById('estadoSelect')?.value;
                const color = estado === 'bueno' ? 'blue' : 'red';

                const tratamientoSeleccionado = tratamientosNTP.find(t => t.sigla === sigla);
                if (!tratamientoSeleccionado) {
                    console.warn("Tratamiento de conducto no encontrado:", sigla);
                    return;
                }

                const nombre = tratamientoSeleccionado.nombre;
                const descripcion = tratamientoSeleccionado.descripcion;

                const g = document.getElementById(`P${numPieza}`);
                if (!g) {
                    Swal.fire('Error', 'Diente no encontrado.', 'error');
                    return;
                }

                const polygons = Array.from(g.querySelectorAll('polygon'));
                if (polygons.length === 0) {
                    Swal.fire('Error', 'Este diente no tiene pol√≠gonos.', 'warning');
                    return;
                }

                // Calcular el bounding box
                let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                polygons.forEach(p => {
                    const points = p.getAttribute('points').trim().split(/\s+/);
                    points.forEach(pt => {
                        const [x, y] = pt.split(',').map(Number);
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    });
                });

                // Obtener transformaciones del diente
                const transform = g.getAttribute('transform');
                let tx = 0, ty = 0;
                if (transform?.includes('translate')) {
                    const match = transform.match(/translate\(([^,]+),\s*([^)]+)\)/);
                    if (match) {
                        tx = parseFloat(match[1]) || 0;
                        ty = parseFloat(match[2]) || 0;
                    }
                }

                const scale = 1.5;
                const cx = (minX + maxX) / 2;
                const startX = (cx + tx) * scale;
                const yStart = (maxY + ty) * scale;
                const yEnd = (minY + ty - 4) * scale;

                // Dibujar l√≠nea recta vertical
                const ns = "http://www.w3.org/2000/svg";
                const linea = document.createElementNS(ns, 'line');
                linea.setAttribute('x1', startX);
                linea.setAttribute('y1', yStart);
                linea.setAttribute('x2', startX);
                linea.setAttribute('y2', yEnd);
                linea.setAttribute('stroke', color);
                linea.setAttribute('stroke-width', 2);
                linea.classList.add('conducto-marca');
                linea.setAttribute('data-diente', `P${numPieza}`);
                svg.appendChild(linea);

                // Mostrar sigla en el diente
                const textElement = document.querySelector(`#sigla-P${numPieza}`);
                if (textElement) {
                    textElement.textContent = sigla;
                    textElement.setAttribute("fill", color);
                    textElement.setAttribute("title", `${observaciones} - ${descripcion}`);
                }

                registrarHallazgoDetalle('conducto', `${nombre} (${sigla}) en diente ${numPieza}`, observaciones);

                // Guardar en hallazgos
                hallazgosRegistrados.push({
                    tipo,
                    sigla,
                    color,
                    nombre,
                    descripcion,
                    observaciones,
                    diente: selectedDiente.diente,
                    desde: numPieza,
                    hasta: numPieza,
                    seccion: selectedDiente.seccion,
                    zonaId,
                    coordenadas: {
                        diente: {},
                        centro_texto: { x: startX, y: yStart }
                    }
                });
            }


            const zona = zonaDescriptiva(selectedDiente.seccion, selectedDiente.diente);
            infoDiente.innerHTML = `<strong>${sigla}</strong> aplicado a Diente ${numPieza} - ${zona}`;
            // Calcular y guardar coordenadas del hallazgo tipo corona


            console.log("üìå Hallazgos registrados:", hallazgosRegistrados);
        });

        function zonaDescriptiva(id, diente) {
            if (!diente) return 'Zona';

            const num = parseInt(diente.replace('P', ''));
            let cuadrante = 0;

            if ((num >= 11 && num <= 18) || (num >= 51 && num <= 55)) {
                cuadrante = 1;
            } else if ((num >= 21 && num <= 28) || (num >= 61 && num <= 65)) {
                cuadrante = 2;
            } else if ((num >= 31 && num <= 38) || (num >= 71 && num <= 75)) {
                cuadrante = 3;
            } else if ((num >= 41 && num <= 48) || (num >= 81 && num <= 85)) {
                cuadrante = 4;
            }

            const zonas = {
                1: { T: 'Vestibular', L: 'Distal', R: 'Mesial', B: 'Palatino', C: 'Oclusal' },
                2: { T: 'Vestibular', L: 'Mesial', R: 'Distal', B: 'Palatino', C: 'Oclusal' },
                3: { T: 'Lingual',    L: 'Mesial', R: 'Distal', B: 'Vestibular', C: 'Oclusal' },
                4: { T: 'Lingual',    L: 'Distal', R: 'Mesial', B: 'Vestibular', C: 'Oclusal' }
            };

            return zonas[cuadrante]?.[id] || 'Zona';
        }

        const tooltip = document.getElementById('zona-tooltip');

        document.querySelectorAll('svg polygon.odontoseccion').forEach(polygon => {
            polygon.addEventListener('mouseover', function (e) {
                const zonaId = this.id;
                const dienteGroup = this.closest('g[id^="P"]');
                const dienteId = dienteGroup ? dienteGroup.id : null;

                const descripcion = zonaDescriptiva(zonaId, dienteId);
                tooltip.innerText = descripcion;
                tooltip.style.display = 'block';
            });

            polygon.addEventListener('mousemove', function (e) {
                const svg = this.ownerSVGElement;
                const pt = svg.createSVGPoint();
                pt.x = e.clientX;
                pt.y = e.clientY;

                const screenCTM = svg.getScreenCTM();
                const coords = pt.matrixTransform(screenCTM.inverse());

                const matrix = svg.getScreenCTM();
                const x = coords.x * matrix.a + matrix.e;
                const y = coords.y * matrix.d + matrix.f;

                tooltip.style.position = 'fixed';
                tooltip.style.left = `${x + 10}px`;
                tooltip.style.top = `${y + 10}px`;
            });

            polygon.addEventListener('mouseout', function () {
                tooltip.style.display = 'none';
            });
        });


        document.getElementById('btnEliminar').addEventListener('click', function () {
            const option = select.selectedOptions[0];
            const tipo = option?.dataset?.tipo || '';
            const posicion = option?.dataset?.posicion || ''; // superior, inferior
            const dienteId = option?.dataset?.diente || ''; // ej: "P11"

            // Eliminaci√≥n espec√≠fica para ortodoncia
            if (tipo === 'ortodoncia') {
                console.log('selectedOrtodoncia:', selectedOrtodoncia);
                if (selectedOrtodoncia.length !== 2) {
                    Swal.fire('Atenci√≥n', 'Debes seleccionar dos dientes para eliminar el aparato ortod√≥ntico.', 'warning');
                    return;
                }

                const [inicio, fin] = selectedOrtodoncia;
                const desde = Math.min(inicio.numDiente, fin.numDiente);
                const hasta = Math.max(inicio.numDiente, fin.numDiente);
                console.log("desde - hasta", desde, hasta);
                console.log("hallazgosRegistrados", hallazgosRegistrados);
                const index = hallazgosRegistrados.findIndex(h =>
                    h.tipo === 'ortodoncia' &&
                    (Number(h.desde) === desde && Number(h.hasta) === hasta || Number(h.desde) === hasta && Number(h.hasta) === desde)
                );
                console.log("index",index);
                if (index === -1) {
                    Swal.fire('No encontrado', 'No se encontr√≥ un hallazgo ortod√≥ntico con ese rango.', 'info');
                    return;
                }

                // Eliminar solo las marcas espec√≠ficas del rango
                const marks = document.querySelectorAll(`.ortodoncia-marca[data-desde="${desde}"][data-hasta="${hasta}"]`);
                console.log("marks",marks);
                if (marks.length === 0) {
                    Swal.fire('No encontrada', 'No se encontr√≥ ninguna marca gr√°fica asociada a este rango.', 'info');
                } else {
                    marks.forEach(mark => mark.remove());
                }

                // Eliminar del arreglo
                hallazgosRegistrados.splice(index, 1);
                registrarHallazgoDetalle(
                    'eliminacion',
                    `Eliminada ortodoncia de diente ${desde} a ${hasta}`,
                    ''
                );

                Swal.fire('Eliminado', `Ortodoncia de diente ${desde} a ${hasta} eliminada.`, 'success');

                selectedOrtodoncia = [];
                infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';
            // üî∑ Eliminar Ed√©ntulo Total Superior / Inferior
            } else if (tipo === 'edentulo') {
                // Buscar y eliminar la l√≠nea con clase 'edentulo-marca'
                const marca = document.querySelector('.edentulo-marca');
                if (marca) {
                    marca.remove();
                }

                // Eliminar el registro del hallazgo
                const index = hallazgosRegistrados.findIndex(h =>
                    h.tipo === 'edentulo' &&
                    (h.sigla === 'ETS' || h.sigla === 'ETI')
                );

                if (index !== -1) {
                    const eliminado = hallazgosRegistrados.splice(index, 1)[0];

                    registrarHallazgoDetalle(
                        'eliminacion',
                        `Eliminado hallazgo ${eliminado.nombre}`
                    );

                    Swal.fire('Eliminado', `${eliminado.nombre} eliminado correctamente.`, 'success');
                } else {
                    Swal.fire('No encontrado', 'No se encontr√≥ un hallazgo de tipo Ed√©ntulo.', 'info');
                }

                selectedDiente = null;
                selectedOrtodoncia = [];
                infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';
            } else if (tipo === 'protesis_total') {
                // Buscar y eliminar la l√≠nea con clase 'edentulo-marca'
                document.querySelectorAll('.protesis_total-marca').forEach(el => el.remove());

                // Eliminar el registro del hallazgo
                const index = hallazgosRegistrados.findIndex(h =>
                    h.tipo === 'protesis_total' &&
                    (h.sigla === 'PTS' || h.sigla === 'PTI')
                );

                if (index !== -1) {
                    const eliminado = hallazgosRegistrados.splice(index, 1)[0];

                    registrarHallazgoDetalle(
                        'eliminacion',
                        `Eliminado hallazgo ${eliminado.nombre}`
                    );

                    Swal.fire('Eliminado', `${eliminado.nombre} eliminado correctamente.`, 'success');
                } else {
                    Swal.fire('No encontrado', 'No se encontr√≥ un hallazgo de tipo Pr√≥tesis Total.', 'info');
                }

                selectedDiente = null;
                selectedOrtodoncia = [];
                infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';
            
            } else if (tipo === 'espigo') {
                if (!selectedDiente || !selectedDiente.diente) {
                    Swal.fire('Sin selecci√≥n', 'Debes seleccionar un diente para eliminar el espigo.', 'warning');
                    return;
                }

                const dienteId = selectedDiente.diente; // Ej: "P45"
                const numDiente = dienteId.replace('P', '');

                // 1. Eliminar solo las marcas SVG asociadas a ese diente
                const marcas = document.querySelectorAll(`.espigo-munon-marca[data-diente="P${numDiente}"]`);
                if (marcas.length > 0) {
                    marcas.forEach(el => el.remove());
                }

                // 2. Eliminar del arreglo hallazgosRegistrados
                const index = hallazgosRegistrados.findIndex(h =>
                    h.tipo === 'espigo' && h.diente === dienteId
                );

                if (index !== -1) {
                    const eliminado = hallazgosRegistrados.splice(index, 1)[0];

                    // 3. Limpiar texto del diente
                    const textElement = document.querySelector(`#sigla-P${numDiente}`);
                    if (textElement) {
                        textElement.textContent = '';
                        textElement.removeAttribute('fill');
                        textElement.removeAttribute('title');
                    }

                    registrarHallazgoDetalle(
                        'eliminacion',
                        `Eliminado hallazgo Espigo ‚Äì Mu√±√≥n en diente ${numDiente}`
                    );

                    Swal.fire('Eliminado', `Espigo ‚Äì Mu√±√≥n del diente ${numDiente} eliminado.`, 'success');
                } else {
                    Swal.fire('No encontrado', 'No se encontr√≥ un espigo en el diente seleccionado.', 'info');
                }

                selectedDiente = null;
                infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';

            } else if (['fractura', 'fusion', 'geminacion', 'caries', 'supernumeraria', 'pulpotomia', 'restauracion_definitiva', 'restauracion_temporal'].includes(tipo)) {
                if (!selectedDiente || !selectedDiente.diente) {
                    Swal.fire('Sin selecci√≥n', 'Debes seleccionar un diente para eliminar este hallazgo.', 'warning');
                    return;
                }

                const dienteId = selectedDiente.diente; // "P43"
                const numDiente = parseInt(dienteId.replace('P', ''));

                //console.log("‚úÖ Eliminando hallazgo tipo:", tipo, "en diente:", dienteId);
                //console.log("Hallazgos antes de eliminar:", hallazgosRegistrados);

                // Eliminar marcas SVG
                if (tipo === 'fractura') {
                    document.querySelectorAll(`.fractura-dental-marca[data-diente="${dienteId}"]`)
                        .forEach(el => {
                            console.log("üßπ Eliminando l√≠nea fractura:", el);
                            el.remove();
                        });
                // ‚úÖ Restablecer cursor y estado
                modoDibujoFD = false;
                svg.style.cursor = 'default';
                selectedDiente = null;

                }
                if (tipo === 'caries') {
                    console.log("üßπ Eliminando caries para diente:", dienteId);

                    // Buscar la secci√≥n del diente que fue pintada (por ejemplo: 'T', 'B', 'C', etc.)
                    const secciones = ['T', 'B', 'L', 'R', 'C'];
                    secciones.forEach(seccion => {
                        const poligono = document.querySelector(`#${dienteId} > polygon[id="${seccion}"]`);
                        if (poligono && poligono.getAttribute('fill') === 'red') {
                            poligono.setAttribute('fill', 'white'); // Restaurar color original
                        }
                    });

                    // Quitar sigla si estaba
                    const siglaText = document.getElementById(`sigla-${dienteId}`);
                    if (siglaText && siglaText.textContent === 'CA') {
                        siglaText.textContent = '';
                    }

                    // Eliminar de hallazgos registrados
                    hallazgosRegistrados = hallazgosRegistrados.filter(h => !(h.tipo === 'caries' && h.diente === dienteId.replace('P', '')));

                    // Reset estados
                    modoDibujoCaries = false;
                    svg.style.cursor = 'default';
                    selectedDiente = null;
                    desactivarCursorCaries();
                }

                if (tipo === 'fusion') {
                    document.querySelectorAll(`.ortodoncia-marca[data-desde="${numDiente}"], .ortodoncia-marca[data-hasta="${numDiente}"]`)
                        .forEach(el => el.remove());
                }

                if (tipo === 'geminacion') {
                    document.querySelectorAll(`.ortodoncia-marca[data-diente="${numDiente}"]`)
                        .forEach(el => el.remove());
                }
                if (tipo === 'supernumeraria') {
                    // Buscar en hallazgosRegistrados el que contenga este diente
                    const hallazgo = hallazgosRegistrados.find(h =>
                        h.tipo === 'supernumeraria' &&
                        (h.desde === numDiente || h.hasta === numDiente)
                    );

                    if (hallazgo) {
                        const desde = hallazgo.desde;
                        const hasta = hallazgo.hasta;
                        const selector = `.supernumeraria-marca[data-super="${desde}-${hasta}"]`;
                        document.querySelectorAll(selector).forEach(el => el.remove());
                    }
                }
                if (tipo === 'pulpotomia') {
                    console.log("üßπ Eliminando pulpotom√≠a para diente:", dienteId);

                    // Restaurar color original en las secciones (si pintaste alguna secci√≥n espec√≠fica)
                    const secciones = ['T', 'B', 'L', 'R', 'C'];
                    secciones.forEach(seccion => {
                        const poligono = document.querySelector(`#${dienteId} > polygon[id="${seccion}"]`);
                        if (poligono && (poligono.getAttribute('fill') === 'red' || poligono.getAttribute('fill') === 'blue')) {
                            poligono.setAttribute('fill', 'white');
                        }
                    });

                    // Eliminar sigla PP si existe
                    const siglaText = document.getElementById(`sigla-${dienteId}`);
                    if (siglaText && siglaText.textContent === 'PP') {
                        siglaText.textContent = '';
                    }

                    // Eliminar de los hallazgos registrados
                    hallazgosRegistrados = hallazgosRegistrados.filter(h => !(h.tipo === 'pulpotomia' && h.diente === dienteId.replace('P', '')));

                    // Reset de estados
                    modoDibujoPulpotomia = false;
                    svg.style.cursor = 'default';
                    selectedDiente = null;
                    desactivarCursorPulpotomia();
                }

                if (tipo === 'restauracion_definitiva') {
                    //console.log("Buscando eliminar restauracion definitiva para diente:", dienteId);
                    //console.log("Buscando selector:", `.restauracion-marca[data-diente="P${numDiente}"]`);

                    document.querySelectorAll(`.restauracion-marca[data-diente="P${numDiente}"]`)
                        .forEach(el => {
                            //console.log("üßπ Eliminando trazo de restauraci√≥n:", el);
                            el.remove();
                        });
                    // ‚úÖ Restablecer cursor y estado
                    modoDibujoRestauracion = false;
                    svg.style.cursor = 'default';
                    selectedDiente = null;
                    desactivarCursorRestauracion();
                }
                if (tipo === 'restauracion_temporal') {
                    //console.log("Buscando eliminar restauracion definitiva para diente:", dienteId);
                    //console.log("Buscando selector:", `.restauracion-marca[data-diente="P${numDiente}"]`);

                    document.querySelectorAll(`.restauracion-temporal-marca[data-diente="P${numDiente}"]`)
                        .forEach(el => {
                            //console.log("üßπ Eliminando trazo de restauraci√≥n:", el);
                            el.remove();
                        });
                    // ‚úÖ Restablecer cursor y estado
                    modoDibujoRestauracion = false;
                    svg.style.cursor = 'default';
                    selectedDiente = null;
                    desactivarCursorRestauracion();
                }
                // Eliminar del array con comparaci√≥n segura
                const prevLength = hallazgosRegistrados.length;
                hallazgosRegistrados = hallazgosRegistrados.filter(h =>
                    !(
                        h.tipo === tipo &&
                        (
                            parseInt(h.diente) === numDiente ||         // para fractura, geminaci√≥n
                            h.desde === numDiente || h.hasta === numDiente // para fusi√≥n
                        )
                    )
                );

                const eliminados = prevLength - hallazgosRegistrados.length;

                console.log("‚ùå Eliminados:", eliminados);
                console.log("üèÅ Hallazgos restantes:", hallazgosRegistrados);

                // Limpiar sigla si existiera
                const textElement = document.querySelector(`#sigla-${dienteId}`);
                if (textElement) {
                    textElement.textContent = '';
                    textElement.removeAttribute('fill');
                    textElement.removeAttribute('title');
                }

                if (eliminados > 0) {
                    registrarHallazgoDetalle(
                        'eliminacion',
                        `Eliminado hallazgo ${tipo} del diente ${numDiente}`
                    );
                    Swal.fire('Eliminado', `Hallazgo ${tipo} del diente ${numDiente} eliminado.`, 'success');
                } else {
                    Swal.fire('No encontrado', `No se encontr√≥ un hallazgo "${tipo}" en el diente seleccionado.`, 'info');
                }

                selectedDiente = null;
                modoDibujoFD = false;
                infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';

            } else if (tipo === 'corona') {
            // Eliminaci√≥n est√°ndar para hallazgos normales
                if (!selectedDiente || !selectedDiente.diente || !selectedDiente.seccion) {
                    Swal.fire('Sin selecci√≥n', 'Debes seleccionar una secci√≥n de un diente para eliminar un hallazgo.', 'warning');
                    return;
                }

                const { diente, seccion } = selectedDiente;
                console.log("selectedDiente",selectedDiente);
                // Restaurar estilo visual del pol√≠gono
                const polygon = document.querySelector(`#${seccion}`);
                if (polygon) {
                    polygon.setAttribute('fill', '#F6F6F6');
                    polygon.setAttribute('stroke', '#8B4513');
                    polygon.setAttribute('stroke-width', '0.5');
                }

                // Restaurar texto (sigla)
                const numPieza = diente.replace('P', '');
                const textElement = document.querySelector(`#sigla-P${numPieza}`);
                if (textElement && textElement.textContent) {
                    textElement.textContent = '';
                    textElement.removeAttribute('fill');
                    textElement.removeAttribute('title');
                }

                // Eliminar rect√°ngulo de corona si existe
                const g = document.querySelector(`#${diente}`);
                const existingRect = g?.querySelector('rect.borde-corona');
                if (existingRect) {
                    existingRect.remove();
                }
                console.log("Hallazgos registrados:", hallazgosRegistrados);

                // Eliminar del array de hallazgos
                if (Array.isArray(hallazgosRegistrados)) {
                    const eliminados = hallazgosRegistrados.filter(item =>
                        Number(item.diente) === Number(numPieza)
                    );

                    hallazgosRegistrados = hallazgosRegistrados.filter(item =>
                        Number(item.diente) !== Number(numPieza)
                    );

                    console.log("Hallazgos eliminados:", eliminados);
                }

                registrarHallazgoDetalle(
                    'eliminacion',
                    `Eliminado hallazgo en Diente ${numPieza} - ${zonaDescriptiva(seccion, diente)}`
                );

                // Limpieza
                selectedDiente = null;
                infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';
                Swal.fire('Eliminado', 'Se elimin√≥ el hallazgo de la secci√≥n seleccionada.', 'success');
            } else if (tipo === 'ausente') {
                if (!selectedDiente || !selectedDiente.diente) {
                    Swal.fire('Sin selecci√≥n', 'Debes seleccionar un diente para eliminar el hallazgo de pieza ausente.', 'warning');
                    return;
                }

                const dienteId = selectedDiente.diente; // Ej: "P65"
                const numDiente = dienteId.replace('P', '');

                // 1. Eliminar marcas SVG asociadas a ese diente
                console.log("dienteId",dienteId);
                console.log("numDiente",numDiente);
                console.log("hallazgosRegistrados",hallazgosRegistrados);
                const marcas = document.querySelectorAll(`.ausente-marca[data-diente="P${numDiente}"]`);

                marcas.forEach(el => el.remove());

                // 2. Eliminar del arreglo hallazgosRegistrados
                const index = hallazgosRegistrados.findIndex(h =>
                    h.tipo === 'ausente' && h.diente == numDiente
                );

                if (index !== -1) {
                    const eliminado = hallazgosRegistrados.splice(index, 1)[0];

                    // 3. Limpiar sigla si aplica
                    const textElement = document.querySelector(`#sigla-P${numDiente}`);
                    if (textElement) {
                        textElement.textContent = '';
                        textElement.removeAttribute('fill');
                        textElement.removeAttribute('title');
                    }

                    registrarHallazgoDetalle(
                        'eliminacion',
                        `Eliminado hallazgo Pieza Dentaria Ausente (${eliminado.sigla}) en diente ${numDiente}`
                    );

                    Swal.fire('Eliminado', `Pieza Ausente (${eliminado.sigla}) en diente ${numDiente} eliminada.`, 'success');
                } else {
                    Swal.fire('No encontrado', 'No se encontr√≥ hallazgo de pieza ausente en el diente seleccionado.', 'info');
                }

                selectedDiente = null;
                infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';
            } else if (tipo === 'clavija') {
                if (!selectedDiente || !selectedDiente.diente) {
                    Swal.fire('Sin selecci√≥n', 'Debes seleccionar un diente para eliminar el hallazgo de clavija.', 'warning');
                    return;
                }

                const dienteId = selectedDiente.diente; // Ej: "P65"
                const numDiente = dienteId.replace('P', '');

                // 1. Eliminar marcas SVG asociadas a ese diente
                const marcas = document.querySelectorAll(`.clavija-marca[data-diente="P${numDiente}"]`);
                marcas.forEach(el => el.remove());

                // 2. Eliminar del arreglo hallazgosRegistrados
                const index = hallazgosRegistrados.findIndex(h =>
                    h.tipo === 'clavija' && h.diente === dienteId
                );

                if (index !== -1) {
                    const eliminado = hallazgosRegistrados.splice(index, 1)[0];

                    // 3. Limpiar sigla si aplica
                    const textElement = document.querySelector(`#sigla-P${numDiente}`);
                    if (textElement) {
                        textElement.textContent = '';
                        textElement.removeAttribute('fill');
                        textElement.removeAttribute('title');
                    }

                    registrarHallazgoDetalle(
                        'eliminacion',
                        `Eliminado hallazgo Clavija (${eliminado.sigla}) en diente ${numDiente}`
                    );

                    Swal.fire('Eliminado', `Hallazgo de Clavija en diente ${numDiente} eliminado.`, 'success');
                } else {
                    Swal.fire('No encontrado', 'No se encontr√≥ hallazgo de clavija en el diente seleccionado.', 'info');
                }

                selectedDiente = null;
                infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';
            } else if (tipo === 'erupcion') {
                if (!selectedDiente || !selectedDiente.diente) {
                    Swal.fire('Sin selecci√≥n', 'Debes seleccionar un diente para eliminar el hallazgo de erupci√≥n.', 'warning');
                    return;
                }

                const dienteId = selectedDiente.diente; // Ej: "P36"
                const numDiente = dienteId.replace('P', '');

                // 1. Eliminar la marca SVG (flecha en zigzag)
                const marcas = document.querySelectorAll(`.erupcion-marca[data-diente="P${numDiente}"]`);
                marcas.forEach(el => el.remove());

                console.log("hallazgosRegistrados",hallazgosRegistrados);
                // 2. Eliminar del array hallazgosRegistrados
                const index = hallazgosRegistrados.findIndex(h =>
                    h.tipo === 'erupcion' && h.diente === dienteId
                );

                if (index !== -1) {
                    const eliminado = hallazgosRegistrados.splice(index, 1)[0];

                    // 3. Limpiar texto sigla
                    const textElement = document.querySelector(`#sigla-P${numDiente}`);
                    if (textElement) {
                        textElement.textContent = '';
                        textElement.removeAttribute('fill');
                        textElement.removeAttribute('title');
                    }

                    registrarHallazgoDetalle(
                        'eliminacion',
                        `Hallazgo Erupci√≥n (${eliminado.sigla}) en diente ${numDiente} eliminado.`
                    );

                    Swal.fire('Eliminado', `Hallazgo de Erupci√≥n en diente ${numDiente} eliminado.`, 'success');
                } else {
                    Swal.fire('No encontrado', 'No se encontr√≥ hallazgo de erupci√≥n en el diente seleccionado.', 'info');
                }

                selectedDiente = null;
                infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';
            } else if (tipo === 'extruida') {
                if (!selectedDiente || !selectedDiente.diente) {
                    Swal.fire('Sin selecci√≥n', 'Debes seleccionar un diente para eliminar el hallazgo de pieza extruida.', 'warning');
                    return;
                }

                const dienteId = selectedDiente.diente; // Ej: "P44"
                const numDiente = dienteId.replace('P', '');

                // 1. Eliminar marcas SVG asociadas a ese diente
                const marcas = document.querySelectorAll(`.extruida-marca[data-diente="P${numDiente}"]`);
                marcas.forEach(el => el.remove());

                // 2. Eliminar del array hallazgosRegistrados
                const index = hallazgosRegistrados.findIndex(h =>
                    h.tipo === 'extruida' && h.diente === dienteId
                );

                if (index !== -1) {
                    const eliminado = hallazgosRegistrados.splice(index, 1)[0];

                    // 3. Limpiar sigla si aplica (si se est√° usando)
                    const textElement = document.querySelector(`#sigla-${dienteId}`);
                    if (textElement) {
                        textElement.textContent = '';
                        textElement.removeAttribute('fill');
                        textElement.removeAttribute('title');
                    }

                    registrarHallazgoDetalle(
                        'eliminacion',
                        `Eliminado hallazgo Pieza Extruida (${eliminado.sigla}) en diente ${numDiente}`
                    );

                    Swal.fire('Eliminado', `Hallazgo de pieza extruida en diente ${numDiente} eliminado.`, 'success');
                } else {
                    Swal.fire('No encontrado', 'No se encontr√≥ hallazgo de pieza extruida en el diente seleccionado.', 'info');
                }

                selectedDiente = null;
                infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';
            } else if (tipo === 'intruida') {
                if (!selectedDiente || !selectedDiente.diente) {
                    Swal.fire('Sin selecci√≥n', 'Debes seleccionar un diente para eliminar el hallazgo de pieza intruida.', 'warning');
                    return;
                }

                const dienteId = selectedDiente.diente; // Ej: "P44"
                const numDiente = dienteId.replace('P', '');
                //console.log("numDiente",numDiente);
                //console.log("hallazgosRegistrados",hallazgosRegistrados);
                // 1. Eliminar marcas SVG asociadas a ese diente
                const marcas = document.querySelectorAll(`.intruida-marca[data-diente="P${numDiente}"]`);
                //console.log("marcas",marcas);
                marcas.forEach(el => el.remove());
                
                // 2. Eliminar del array hallazgosRegistrados
                const index = hallazgosRegistrados.findIndex(h =>
                    h.tipo === 'intruida' && h.diente === dienteId
                );

                if (index !== -1) {
                    const eliminado = hallazgosRegistrados.splice(index, 1)[0];

                    // 3. Limpiar sigla si aplica (si se est√° usando)
                    const textElement = document.querySelector(`#sigla-${dienteId}`);
                    if (textElement) {
                        textElement.textContent = '';
                        textElement.removeAttribute('fill');
                        textElement.removeAttribute('title');
                    }

                    registrarHallazgoDetalle(
                        'eliminacion',
                        `Eliminado hallazgo Pieza Intruida (${eliminado.sigla}) en diente ${numDiente}`
                    );

                    Swal.fire('Eliminado', `Hallazgo de pieza intruida en diente ${numDiente} eliminado.`, 'success');
                } else {
                    Swal.fire('No encontrado', 'No se encontr√≥ hallazgo de pieza intruida en el diente seleccionado.', 'info');
                }

                selectedDiente = null;
                infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';
            } else // Eliminaci√≥n espec√≠fica para pr√≥tesis parcial fija con 1 solo diente
                if (tipo === 'protesis_parcial') {
                    if (selectedOrtodoncia.length !== 1) {
                        Swal.fire('Atenci√≥n', 'Debes seleccionar un diente que forme parte de la pr√≥tesis para eliminarla.', 'warning');
                        return;
                    }

                    const dienteSeleccionado = selectedOrtodoncia[0].numDiente;

                    const index = hallazgosRegistrados.findIndex(h =>
                        h.tipo === 'protesis_parcial' &&
                        Number(h.desde) <= dienteSeleccionado &&
                        Number(h.hasta) >= dienteSeleccionado
                    );

                    if (index === -1) {
                        Swal.fire('No encontrado', 'No se encontr√≥ una pr√≥tesis parcial que incluya este diente.', 'info');
                        return;
                    }

                    const desde = hallazgosRegistrados[index].desde;
                    const hasta = hallazgosRegistrados[index].hasta;

                    // Eliminar marcas SVG asociadas
                    const marks = document.querySelectorAll(`.protesis-parcial[data-desde="${desde}"][data-hasta="${hasta}"]`);
                    if (marks.length === 0) {
                        Swal.fire('No encontrada', 'No se encontr√≥ ninguna marca gr√°fica asociada a esta pr√≥tesis.', 'info');
                    } else {
                        marks.forEach(mark => mark.remove());
                    }

                    // Eliminar del arreglo de hallazgos
                    hallazgosRegistrados.splice(index, 1);

                    registrarHallazgoDetalle(
                        'eliminacion',
                        `Eliminada pr√≥tesis parcial fija entre dientes ${desde} y ${hasta}`,
                        ''
                    );

                    Swal.fire('Eliminado', `Pr√≥tesis parcial fija entre dientes ${desde} y ${hasta} eliminada.`, 'success');

                    selectedOrtodoncia = [];
                    infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';
                } else if (tipo === 'protesis_removible') {
                    if (selectedOrtodoncia.length !== 1) {
                        Swal.fire('Atenci√≥n', 'Debes seleccionar un diente que forme parte de la pr√≥tesis para eliminarla.', 'warning');
                        return;
                    }

                    const dienteSeleccionado = selectedOrtodoncia[0].numDiente;

                    const index = hallazgosRegistrados.findIndex(h =>
                        h.tipo === 'protesis_removible' &&
                        Number(h.desde) <= dienteSeleccionado &&
                        Number(h.hasta) >= dienteSeleccionado
                    );

                    if (index === -1) {
                        Swal.fire('No encontrado', 'No se encontr√≥ una pr√≥tesis removible que incluya este diente.', 'info');
                        return;
                    }

                    const desde = hallazgosRegistrados[index].desde;
                    const hasta = hallazgosRegistrados[index].hasta;

                    // Eliminar marcas SVG asociadas
                    const marks = document.querySelectorAll(`.protesis-removible[data-desde="${desde}"][data-hasta="${hasta}"]`);
                    if (marks.length === 0) {
                        Swal.fire('No encontrada', 'No se encontr√≥ ninguna marca gr√°fica asociada a esta pr√≥tesis.', 'info');
                    } else {
                        marks.forEach(mark => mark.remove());
                    }

                    // Eliminar del arreglo de hallazgos
                    hallazgosRegistrados.splice(index, 1);

                    registrarHallazgoDetalle(
                        'eliminacion',
                        `Eliminada pr√≥tesis parcial removible entre dientes ${desde} y ${hasta}`,
                        ''
                    );

                    Swal.fire('Eliminado', `Pr√≥tesis parcial removible entre dientes ${desde} y ${hasta} eliminada.`, 'success');

                    selectedOrtodoncia = [];
                    infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';
                } else if (tipo === 'conducto') {
                    if (!selectedDiente || !selectedDiente.diente) {
                        Swal.fire('Atenci√≥n', 'Debes seleccionar un diente para eliminar el hallazgo de conducto.', 'warning');
                        return;
                    }

                    const numDiente = parseInt(selectedDiente.diente.replace('P', ''));

                    const index = hallazgosRegistrados.findIndex(h =>
                        h.tipo === 'conducto' &&
                        parseInt(h.diente.replace('P', '')) === numDiente
                    );

                    if (index === -1) {
                        Swal.fire('No encontrado', `No se encontr√≥ un hallazgo de conducto para el diente ${numDiente}.`, 'info');
                        return;
                    }

                    // Eliminar marca SVG
                    const marcas = document.querySelectorAll(`.conducto-marca[data-diente="P${numDiente}"]`);
                    if (marcas.length === 0) {
                        Swal.fire('No encontrado', `No se encontr√≥ ninguna marca gr√°fica de conducto en el diente ${numDiente}.`, 'info');
                    } else {
                        marcas.forEach(mark => mark.remove());
                    }

                    // Eliminar del arreglo
                    hallazgosRegistrados.splice(index, 1);

                    registrarHallazgoDetalle(
                        'eliminacion',
                        `Eliminado conducto en diente ${numDiente}`,
                        ''
                    );

                    Swal.fire('Eliminado', `Conducto eliminado en diente ${numDiente}.`, 'success');

                    selectedDiente = null;
                    infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';
                } else if (tipo === 'transposicion') {
                    if (selectedOrtodoncia.length !== 1) {
                        Swal.fire('Atenci√≥n', 'Debes seleccionar un diente involucrado en la transposici√≥n.', 'warning');
                        return;
                    }

                    const dienteSeleccionado = selectedOrtodoncia[0].numDiente;

                    const index = hallazgosRegistrados.findIndex(h =>
                        h.tipo === 'transposicion' &&
                        (h.desde === dienteSeleccionado || h.hasta === dienteSeleccionado)
                    );

                    if (index === -1) {
                        Swal.fire('No encontrado', 'No se encontr√≥ ninguna transposici√≥n que incluya este diente.', 'info');
                        return;
                    }

                    const desde = hallazgosRegistrados[index].desde;
                    const hasta = hallazgosRegistrados[index].hasta;

                    // üîπ Eliminar marcas SVG espec√≠ficas por data-desde y data-hasta
                    const marcas = document.querySelectorAll(`.transposicion-marca[data-desde="${desde}"][data-hasta="${hasta}"]`);
                    marcas.forEach(m => m.remove());

                    // üîπ Eliminar del array
                    hallazgosRegistrados.splice(index, 1);

                    registrarHallazgoDetalle(
                        'eliminacion',
                        `Transposici√≥n eliminada entre dientes ${desde} y ${hasta}`,
                        ''
                    );

                    Swal.fire('Eliminado', `Se elimin√≥ la transposici√≥n entre los dientes ${desde} y ${hasta}.`, 'success');

                    selectedOrtodoncia = [];
                    infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';
                }

            // üîç Verificaci√≥n general para eliminar hallazgos con solo sigla (sin marca)
            if (selectedDiente && selectedDiente.diente) {
                const dienteId = selectedDiente.diente; // Ej: "P36"
                const numDiente = dienteId.replace('P', '');

                // Buscar el hallazgo para este diente
                const index = hallazgosRegistrados.findIndex(h => 
                    h.diente == dienteId || h.diente == numDiente
                );
                const hallazgo = hallazgosRegistrados[index];

                // Verifica si hay alguna marca SVG asociada
                const hayMarcaSVG = document.querySelector(`[data-diente="${dienteId}"]`);

                // Verifica si hay sigla visible
                const siglaElement = document.querySelector(`#sigla-${dienteId}`);
                const siglaText = siglaElement?.textContent?.trim();

                if (hallazgo && !hayMarcaSVG && siglaText) {
                    Swal.fire({
                        title: '¬øEliminar sigla?',
                        html: `Se encontr√≥ una sigla <b>${siglaText}</b> sin marca en el diente <b>${numDiente}</b>.<br>¬øDeseas eliminarla?`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'S√≠, eliminar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const eliminado = hallazgosRegistrados.splice(index, 1)[0];

                            if (siglaElement) {
                                siglaElement.textContent = '';
                                siglaElement.removeAttribute('fill');
                                siglaElement.removeAttribute('title');
                            }

                            registrarHallazgoDetalle(
                                'eliminacion',
                                `Eliminado hallazgo con solo sigla (${eliminado.sigla}) en diente ${numDiente}`
                            );

                            Swal.fire('Eliminado', `Sigla ${eliminado.sigla} eliminada del diente ${numDiente}.`, 'success');
                        }
                    });
                }
            }
        });

        document.getElementById('btnLimpiar').addEventListener('click', function () {
            // Restaurar el select a su valor inicial
            const tratamientoSelect = document.getElementById('tratamientoSelect');
            tratamientoSelect.value = '';
            $(tratamientoSelect).trigger('change'); // si usas Select2

            // Limpiar variables de selecci√≥n
            selectedDiente = null;
            selectedOrtodoncia = [];
            modoDibujoFD = false;
            modoDibujoCaries = false;
            modoDibujoPulpotomia = false;
            modoDibujoSellante = false;
            modoDibujoRestauracion = false;
            svg.style.cursor = 'default';
            desactivarCursorCaries();
            desactivarCursorPulpotomia();
            desactivarCursorDesgaste();
            desactivarCursorRestauracion();
            desactivarCursorSellante();
            // Limpiar el mensaje informativo
            const infoDiente = document.getElementById('infoDiente'); // Aseg√∫rate de que este ID exista
            infoDiente.innerHTML = 'ü¶∑ Seleccione un diente y una zona';
            console.log("hallazgosRegistrados",hallazgosRegistrados);
        });

        function registrarHallazgoDetalle(tipo, texto, observaciones = '') {
            const contenedor = document.getElementById('detalle-hallazgos');
            if (!contenedor) return;

            const item = document.createElement('div');
            item.className = 'hallazgo-item';

            const emoji = tipo === 'eliminacion' ? '‚ùå' :
                tipo === 'ortodoncia' ? 'ü¶∑' :
                tipo === 'corona'     ? 'üëë' :
                tipo === 'pieza'      ? '‚ö™' :
                tipo === 'seccion'    ? 'üîπ' :
                tipo === 'entrePiezas'? '‚ÜîÔ∏è' :
                '‚úÖ';

            item.innerHTML = `${emoji} ${texto}${observaciones ? ` <em>(${observaciones})</em>` : ''}`;
            contenedor.appendChild(item);
        }
    });
</script>

<script>
//SCRIPT PARA MOSTRAR LOS DATOS DE LA ULTIMA VERSION
    const svg = document.querySelector('svg');
    const ns = "http://www.w3.org/2000/svg";

    const drawSquareWithCross = (x, y, color, desde, hasta) => {
        const group = document.createElementNS(ns, 'g');
        group.classList.add('ortodoncia-marca');
        group.setAttribute('data-desde', desde);
        group.setAttribute('data-hasta', hasta);

        const rect = document.createElementNS(ns, 'rect');
        rect.setAttribute('x', x - 5);
        rect.setAttribute('y', y - 5);
        rect.setAttribute('width', 10);
        rect.setAttribute('height', 10);
        rect.setAttribute('fill', 'white');
        rect.setAttribute('stroke', color);
        rect.setAttribute('stroke-width', 1);
        group.appendChild(rect);

        const line1 = document.createElementNS(ns, 'line');
        line1.setAttribute('x1', x - 4);
        line1.setAttribute('y1', y - 4);
        line1.setAttribute('x2', x + 4);
        line1.setAttribute('y2', y + 4);
        line1.setAttribute('stroke', color);
        group.appendChild(line1);

        const line2 = document.createElementNS(ns, 'line');
        line2.setAttribute('x1', x + 4);
        line2.setAttribute('y1', y - 4);
        line2.setAttribute('x2', x - 4);
        line2.setAttribute('y2', y + 4);
        line2.setAttribute('stroke', color);
        group.appendChild(line2);

        svg.appendChild(group);
    };

    const drawAOF = (hallazgo) => {
        drawSquareWithCross(hallazgo.coordenada_x1, hallazgo.coordenada_y1, hallazgo.color, hallazgo.desde_diente, hallazgo.hasta_diente);
        drawSquareWithCross(hallazgo.coordenada_x2, hallazgo.coordenada_y2, hallazgo.color, hallazgo.desde_diente, hallazgo.hasta_diente);

        const lineGroup = document.createElementNS(ns, 'g');
        lineGroup.classList.add('ortodoncia-marca');
        lineGroup.setAttribute('data-desde', hallazgo.desde_diente);
        lineGroup.setAttribute('data-hasta', hallazgo.hasta_diente);

        const line = document.createElementNS(ns, 'line');
        line.setAttribute('x1', hallazgo.coordenada_x1);
        line.setAttribute('y1', hallazgo.coordenada_y1);
        line.setAttribute('x2', hallazgo.coordenada_x2);
        line.setAttribute('y2', hallazgo.coordenada_y2);
        line.setAttribute('stroke', hallazgo.color);
        line.setAttribute('stroke-width', 1.5);
        lineGroup.appendChild(line);
        svg.appendChild(lineGroup);
    };

    const drawZigZagLine = (hallazgo) => {
        const zigzag = document.createElementNS(ns, 'polyline');
        zigzag.setAttribute('fill', 'none');
        zigzag.setAttribute('stroke', hallazgo.color);
        zigzag.setAttribute('stroke-width', '1.5');

        const points = [];
        const segments = 12;
        const dx = (hallazgo.coordenada_x2 - hallazgo.coordenada_x1) / segments;
        const dy = (hallazgo.coordenada_y2 - hallazgo.coordenada_y1) / segments;
        const amplitude = 6;

        for (let i = 0; i <= segments; i++) {
            const x = Number(hallazgo.coordenada_x1) + dx * i;
            let y;
            if (i % 2 === 0) {
                y = Number(hallazgo.coordenada_y1) + dy * i - amplitude;
            } else {
                y = Number(hallazgo.coordenada_y1) + dy * i + amplitude;
            }
            points.push(`${x.toFixed(2)},${y.toFixed(2)}`);
        }

        zigzag.setAttribute("points", points.join(" "));
        zigzag.classList.add("ortodoncia-marca");
        zigzag.setAttribute("data-desde", hallazgo.desde_diente);
        zigzag.setAttribute("data-hasta", hallazgo.hasta_diente);
        svg.appendChild(zigzag);
    };

    const drawCorona = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;
        const padding = 1.5; // üëà Aqu√≠ defines padding
        // Recuadro de la corona
        const g = document.getElementById(`P${hallazgo.desde_diente}`);

        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', hallazgo.coordenada_x1 - padding);
        rect.setAttribute('y', hallazgo.coordenada_y1 - padding);
        rect.setAttribute('width', (hallazgo.coordenada_x2 - hallazgo.coordenada_x1) + padding * 2);
        rect.setAttribute('height', (hallazgo.coordenada_y2 - hallazgo.coordenada_y1) + padding * 2);
        rect.setAttribute('stroke', hallazgo.color);
        rect.setAttribute('fill', 'none');
        rect.setAttribute('stroke-width', '1.5');
        rect.setAttribute('class', 'borde-corona');
        g.appendChild(rect);
        // Asignar sigla al <text id="sigla-P##">
        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", hallazgo.color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle('corona', `${hallazgo.nombre} ${hallazgo.sigla} aplicada a diente ${hallazgo.desde_diente}`, hallazgo.observaciones);

    };
    const drawDDE = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;

        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", hallazgo.color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle('dde', `${hallazgo.nombre} ${hallazgo.sigla} aplicada a diente ${hallazgo.desde_diente}`, hallazgo.observaciones);
    };
    
    const drawEspigo = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;

        const numDiente = hallazgo.desde_diente;

        // Cuadrado (centro en coordenada_x1/y1)
        const size = 8;
        const square = document.createElementNS(ns, 'rect');
        square.setAttribute('x', hallazgo.coordenada_x1 - size / 2);
        square.setAttribute('y', hallazgo.coordenada_y1 - size / 2);
        square.setAttribute('width', size);
        square.setAttribute('height', size);
        square.setAttribute('fill', 'white');
        square.setAttribute('stroke', hallazgo.color);
        square.setAttribute('stroke-width', 1.5);
        square.setAttribute('class', 'espigo-munon-marca');
        square.setAttribute('data-diente', `P${numDiente}`);
        svg.appendChild(square);

        // L√≠nea vertical hacia arriba
        const linea = document.createElementNS(ns, 'line');
        linea.setAttribute('x1', hallazgo.coordenada_x1);
        linea.setAttribute('y1', hallazgo.coordenada_y1);
        linea.setAttribute('x2', hallazgo.coordenada_x2);
        linea.setAttribute('y2', hallazgo.coordenada_y2);
        linea.setAttribute('stroke', hallazgo.color);
        linea.setAttribute('stroke-width', 1.5);
        linea.setAttribute('class', 'espigo-munon-marca');
        linea.setAttribute('data-diente', `P${numDiente}`);
        svg.appendChild(linea);

        // Asignar sigla al texto
        const textElement = document.querySelector(`#sigla-P${numDiente}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", hallazgo.color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }

        registrarHallazgoDetalle('espigo', `${hallazgo.nombre} (${hallazgo.sigla}) en diente ${numDiente}`, hallazgo.observaciones);
    };

    const drawFFP = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;

        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", hallazgo.color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle('ffp', `${hallazgo.nombre} ${hallazgo.sigla} aplicada a diente ${hallazgo.desde_diente}`, hallazgo.observaciones);
    };
    
    const drawFracturaDental = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;

        const numDiente = hallazgo.desde_diente;

        const linea = document.createElementNS(ns, 'line');
        linea.setAttribute('x1', hallazgo.coordenada_x1);
        linea.setAttribute('y1', hallazgo.coordenada_y1);
        linea.setAttribute('x2', hallazgo.coordenada_x2);
        linea.setAttribute('y2', hallazgo.coordenada_y2);
        linea.setAttribute('stroke', hallazgo.color || 'red');
        linea.setAttribute('stroke-width', 2.5);
        linea.setAttribute('stroke-linecap', 'round');
        linea.setAttribute('class', 'fractura-dental-marca');
        linea.setAttribute('data-diente', `P${numDiente}`);
        svg.appendChild(linea);

        registrarHallazgoDetalle(
            'fractura',
            `Fractura dental en diente ${numDiente}`,
            hallazgo.observaciones
        );
    };

    const drawFusion = (hallazgo) => {
        const svg = document.querySelector('svg');
        if (!svg) return;

        const ns = "http://www.w3.org/2000/svg";

        const pos1 = { x: hallazgo.coordenada_x1, y: hallazgo.coordenada_y1 };
        const pos2 = { x: hallazgo.coordenada_x2, y: hallazgo.coordenada_y2 };

        const svgGroup = document.createElementNS(ns, "g");
        svgGroup.classList.add('ortodoncia-marca');
        svgGroup.setAttribute('data-desde', hallazgo.desde_diente);
        svgGroup.setAttribute('data-hasta', hallazgo.hasta_diente);

        const ellipse1 = document.createElementNS(ns, 'ellipse');
        ellipse1.setAttribute('cx', pos1.x + 10);
        ellipse1.setAttribute('cy', pos1.y - 5);
        ellipse1.setAttribute('rx', 18);
        ellipse1.setAttribute('ry', 8);
        ellipse1.setAttribute('stroke', 'blue');
        ellipse1.setAttribute('stroke-width', 1.5);
        ellipse1.setAttribute('fill', 'none');

        const ellipse2 = document.createElementNS(ns, 'ellipse');
        ellipse2.setAttribute('cx', pos2.x + 3);
        ellipse2.setAttribute('cy', pos2.y - 5);
        ellipse2.setAttribute('rx', 18);
        ellipse2.setAttribute('ry', 8);
        ellipse2.setAttribute('stroke', 'blue');
        ellipse2.setAttribute('stroke-width', 1.5);
        ellipse2.setAttribute('fill', 'none');

        svgGroup.appendChild(ellipse1);
        svgGroup.appendChild(ellipse2);
        svg.appendChild(svgGroup);

        registrarHallazgoDetalle('fusion', `Fusi√≥n entre dientes ${hallazgo.desde_diente} y ${hallazgo.hasta_diente}`, hallazgo.observaciones);
    };

    const drawGeminacion = (hallazgo) => {
        const svg = document.querySelector('svg');
        if (!svg) return;

        const ns = "http://www.w3.org/2000/svg";
        const diente = hallazgo.desde_diente;

        const ellipse = document.createElementNS(ns, 'ellipse');
        ellipse.setAttribute('cx', hallazgo.texto_x + 6);
        ellipse.setAttribute('cy', hallazgo.texto_y - 4); // Leve ajuste
        ellipse.setAttribute('rx', 12);
        ellipse.setAttribute('ry', 8);
        ellipse.setAttribute('stroke', 'blue');
        ellipse.setAttribute('stroke-width', 1.5);
        ellipse.setAttribute('fill', 'none');
        ellipse.setAttribute('class', 'ortodoncia-marca');
        ellipse.setAttribute('data-diente', `P${diente}`);

        svg.appendChild(ellipse);

        registrarHallazgoDetalle('geminacion', `Geminaci√≥n en diente ${hallazgo.desde_diente}`, hallazgo.observaciones);
    };

    const drawGiroversion = (hallazgo) => {
        const svg = document.querySelector('svg');
        if (!svg) return;

        const ns = "http://www.w3.org/2000/svg";

        let x1 = parseFloat(hallazgo.coordenada_x1);
        let y1 = parseFloat(hallazgo.coordenada_y1);
        let x2 = parseFloat(hallazgo.coordenada_x2);
        let y2 = parseFloat(hallazgo.coordenada_y2);


        const centerX = (x1 + x2) / 2;
        const radiusX = Math.abs(x2 - x1) / 2;
        const radiusY = 4;

        // üîÑ Ajuste seg√∫n sentido: intercambiar x1 y x2 si es antihorario
        if (hallazgo.sentido === 'horario') {
            sweepFlag = 0;
        } else {
            //[x1, x2] = [x2, x1]; // invertir para dibujar derecha ‚Üí izquierda
            sweepFlag = 1;
        }

        const pathData = `M ${x1} ${y1} A ${radiusX} ${radiusY} 0 0 ${sweepFlag} ${x2} ${y2}`;
        const path = document.createElementNS(ns, 'path');
        path.setAttribute('d', pathData);
        path.setAttribute('stroke', hallazgo.color || 'blue');
        path.setAttribute('stroke-width', 2.1);
        path.setAttribute('fill', 'none');
        path.setAttribute('class', 'giroversion-marca');

        // üîÑ Flecha en el extremo correcto
        if (hallazgo.sentido === 'horario') {
            path.setAttribute('marker-start', 'url(#flecha-inicio)');
        } else {
            path.setAttribute('marker-start', 'url(#flecha-fin)');
        }

        path.setAttribute('data-diente', `P${hallazgo.diente}`);
        svg.appendChild(path);

        // üìå Crear marcadores si no existen
        if (!document.getElementById("flecha-inicio")) {
            const defs = document.createElementNS(ns, "defs");

            const markerInicio = document.createElementNS(ns, "marker");
            markerInicio.setAttribute("id", "flecha-inicio");
            markerInicio.setAttribute("markerWidth", "5");
            markerInicio.setAttribute("markerHeight", "5");
            markerInicio.setAttribute("refX", "0.5");
            markerInicio.setAttribute("refY", "2.5");
            markerInicio.setAttribute("orient", "auto");
            markerInicio.setAttribute("markerUnits", "strokeWidth");

            const arrowInicio = document.createElementNS(ns, "path");
            arrowInicio.setAttribute("d", "M0,0 L5,2.5 L0,5 Z");
            arrowInicio.setAttribute("fill", hallazgo.color || "blue");
            markerInicio.appendChild(arrowInicio);
            defs.appendChild(markerInicio);

            const markerFin = document.createElementNS(ns, "marker");
            markerFin.setAttribute("id", "flecha-fin");
            markerFin.setAttribute("markerWidth", "5");
            markerFin.setAttribute("markerHeight", "5");
            markerFin.setAttribute("refX", "2.5");
            markerFin.setAttribute("refY", "2.5");
            markerFin.setAttribute("orient", "auto");
            markerFin.setAttribute("markerUnits", "strokeWidth");

            const arrowFin = document.createElementNS(ns, "path");
            arrowFin.setAttribute("d", "M0,0 L5,2.5 L0,5 Z");
            arrowFin.setAttribute("fill", hallazgo.color || "blue");
            markerFin.appendChild(arrowFin);
            defs.appendChild(markerFin);

            svg.prepend(defs);
        }

        registrarHallazgoDetalle('giroversion', `Giroversi√≥n (${hallazgo.sentido}) en diente ${hallazgo.desde_diente}`, hallazgo.observaciones);
    };

    const drawImpactacion = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;

        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", hallazgo.color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle('I', `${hallazgo.nombre} ${hallazgo.sigla} aplicada a diente ${hallazgo.desde_diente}`, hallazgo.observaciones);
    };

    const drawImplanteDental = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;

        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", hallazgo.color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle('IMP', `${hallazgo.nombre} ${hallazgo.sigla} aplicada a diente ${hallazgo.desde_diente}`, hallazgo.observaciones);
    };

    function drawCaries(hallazgo) {
        const zonaId = hallazgo.zona_id; // ejemplo: "CA-P34-C"
        const partes = zonaId.split('-'); // ["CA", "P34", "C"]

        if (partes.length !== 3) return;

        const dienteId = partes[1]; // "P34"
        const seccion = partes[2];  // "C"
        const color = hallazgo.color || 'red';

        const poligono = document.querySelector(`#${dienteId} > polygon[id="${seccion}"]`);
        if (poligono) {
            poligono.setAttribute('fill', color);
        }

        const siglaText = document.querySelector(`#sigla-${dienteId}`);
        if (siglaText) {
            siglaText.textContent = hallazgo.sigla || 'CA';
            siglaText.setAttribute('fill', color);
            siglaText.setAttribute('title', `${hallazgo.observaciones || ''} - ${hallazgo.descripcion || ''}`);
        }

        registrarHallazgoDetalle(
            'caries',
            `${hallazgo.nombre || 'Lesi√≥n de Caries Dental'} ${hallazgo.sigla || 'CA'} en diente ${dienteId.replace('P', '')}`,
            hallazgo.observaciones || ''
        );
    }

    const drawMacrodoncia = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;

        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", hallazgo.color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle('MAC', `${hallazgo.nombre} ${hallazgo.sigla} aplicada a diente ${hallazgo.desde_diente}`, hallazgo.observaciones);
    };
    const drawMicrodoncia = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;

        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", hallazgo.color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle('MIC', `${hallazgo.nombre} ${hallazgo.sigla} aplicada a diente ${hallazgo.desde_diente}`, hallazgo.observaciones);
    };
    const drawMP = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;

        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", hallazgo.color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle('MP', `${hallazgo.nombre} ${hallazgo.sigla} aplicada a diente ${hallazgo.desde_diente}`, hallazgo.observaciones);
    };
    const drawAusente = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;

        const numPieza = hallazgo.desde_diente;
        const color = hallazgo.color || 'blue';

        // Dibujar aspa (cruz diagonal)
        const line1 = document.createElementNS(ns, 'line');
        line1.setAttribute('x1', hallazgo.coordenada_x1);
        line1.setAttribute('y1', hallazgo.coordenada_y1);
        line1.setAttribute('x2', hallazgo.coordenada_x2);
        line1.setAttribute('y2', hallazgo.coordenada_y2);
        line1.setAttribute('stroke', color);
        line1.setAttribute('stroke-width', 1.8);
        line1.classList.add('ausente-marca');
        line1.setAttribute('data-diente', `P${numPieza}`);
        svg.appendChild(line1);

        // L√≠nea cruzada inversa
        const line2 = document.createElementNS(ns, 'line');
        line2.setAttribute('x1', hallazgo.coordenada_x1);
        line2.setAttribute('y1', hallazgo.coordenada_y2);
        line2.setAttribute('x2', hallazgo.coordenada_x2);
        line2.setAttribute('y2', hallazgo.coordenada_y1);
        line2.setAttribute('stroke', color);
        line2.setAttribute('stroke-width', 1.8);
        line2.classList.add('ausente-marca');
        line2.setAttribute('data-diente', `P${numPieza}`);
        svg.appendChild(line2);

        // Asignar sigla (DNE, DEX, DAO)
        const textElement = document.querySelector(`#sigla-P${numPieza}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }

        registrarHallazgoDetalle('ausente', `${hallazgo.nombre} ${hallazgo.sigla} en diente ${numPieza}`, hallazgo.observaciones);
    };

    const drawClavija = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;

        const color = hallazgo.color || 'blue';
        const numPieza = hallazgo.desde_diente;

        // Leer directamente texto_x y texto_y guardados en DB
        const cx = hallazgo.texto_x;
        const cy = hallazgo.texto_y;

        if (cx == null || cy == null) {
            console.warn("Coordenadas faltantes para hallazgo clavija:", hallazgo);
            return;
        }

        const size = 6;
        const triangle = document.createElementNS(ns, 'polygon');
        const points = [
            `${cx},${cy}`,                     // v√©rtice superior
            `${cx - size},${cy + size}`,      // base izquierda
            `${cx + size},${cy + size}`       // base derecha
        ].join(' ');
        triangle.setAttribute('points', points);
        triangle.setAttribute('stroke', color);
        triangle.setAttribute('fill', 'none');
        triangle.setAttribute('stroke-width', 1.5);
        triangle.classList.add('clavija-marca');
        triangle.setAttribute('data-diente', `P${numPieza}`);
        svg.appendChild(triangle);

        // Sigla en texto
        const textElement = document.querySelector(`#sigla-P${numPieza}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }

        registrarHallazgoDetalle(
            'clavija',
            `${hallazgo.nombre} (${hallazgo.sigla}) aplicada a diente ${numPieza}`,
            hallazgo.observaciones
        );
    };
    const drawEctopica = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;

        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", hallazgo.color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle('ECT', `${hallazgo.nombre} ${hallazgo.sigla} aplicada a diente ${hallazgo.desde_diente}`, hallazgo.observaciones);
    };

    const drawErupcion = (hallazgo) => {
        const svg = document.querySelector('svg');
        if (!svg) return;

        const color = hallazgo.color || 'blue';
        const dienteId = `P${hallazgo.desde_diente}`;
        const numPieza = hallazgo.desde_diente;
        const startX = hallazgo.texto_x;
        const baseY = hallazgo.texto_y;

        if (!startX || !baseY) {
            console.warn("Coordenadas faltantes para hallazgo erupci√≥n:", hallazgo);
            return;
        }

        const topY = baseY - 30; // Altura fija de flecha zigzag

        const points = [
            [startX, baseY],
            [startX - 4, baseY - 6],
            [startX + 4, baseY - 12],
            [startX - 4, baseY - 18],
            [startX + 4, baseY - 24],
            [startX, topY]
        ];

        const ns = "http://www.w3.org/2000/svg";
        const zigzag = document.createElementNS(ns, 'polyline');
        zigzag.setAttribute('points', points.map(p => p.join(',')).join(' '));
        zigzag.setAttribute('stroke', color);
        zigzag.setAttribute('stroke-width', 2);
        zigzag.setAttribute('fill', 'none');
        zigzag.classList.add('erupcion-marca');
        zigzag.setAttribute('data-diente', dienteId);
        svg.appendChild(zigzag);

        // Sigla en texto
        const textElement = document.querySelector(`#sigla-P${numPieza}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }

        registrarHallazgoDetalle(
            'erupcion',
            `${hallazgo.nombre} (${hallazgo.sigla}) aplicada a diente ${numPieza}`,
            hallazgo.observaciones
        );
    };

    function drawExtruida(hallazgo) {
        const svg = document.querySelector('svg');
        if (!svg) return;

        const numDiente = hallazgo.desde_diente;
        const dienteId = `P${numDiente}`;
        const g = document.getElementById(dienteId);
        const color = hallazgo.color || 'blue';

        const startX = hallazgo.texto_x;
        const baseY = hallazgo.texto_y;

        if (!startX || !baseY) {
            console.warn("Coordenadas faltantes para hallazgo extruida:", hallazgo);
            return;
        }

        // Dientes superiores
        const dientesSuperiores = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28,55,54,53,52,51,61,62,63,64,65];
        const esSuperior = dientesSuperiores.includes(parseInt(numDiente));

        const longFlecha = 14;
        const endY = esSuperior ? baseY - longFlecha : baseY + longFlecha;

        const ns = "http://www.w3.org/2000/svg";

        // L√≠nea principal
        const line = document.createElementNS(ns, 'line');
        line.setAttribute('x1', startX);
        line.setAttribute('y1', baseY);
        line.setAttribute('x2', startX);
        line.setAttribute('y2', endY);
        line.setAttribute('stroke', color);
        line.setAttribute('stroke-width', 2);
        line.classList.add('extruida-marca');
        line.setAttribute('data-diente', dienteId);
        svg.appendChild(line);

        // Puntas
        const puntaY = esSuperior ? endY + 5 : endY - 5;
        const offset = 4;

        const arrow1 = document.createElementNS(ns, 'line');
        arrow1.setAttribute('x1', startX - offset);
        arrow1.setAttribute('y1', puntaY);
        arrow1.setAttribute('x2', startX);
        arrow1.setAttribute('y2', endY);
        arrow1.setAttribute('stroke', color);
        arrow1.setAttribute('stroke-width', 2);
        arrow1.classList.add('extruida-marca');
        arrow1.setAttribute('data-diente', dienteId);
        svg.appendChild(arrow1);

        const arrow2 = document.createElementNS(ns, 'line');
        arrow2.setAttribute('x1', startX + offset);
        arrow2.setAttribute('y1', puntaY);
        arrow2.setAttribute('x2', startX);
        arrow2.setAttribute('y2', endY);
        arrow2.setAttribute('stroke', color);
        arrow2.setAttribute('stroke-width', 2);
        arrow2.classList.add('extruida-marca');
        arrow2.setAttribute('data-diente', dienteId);
        svg.appendChild(arrow2);
    }

    function drawIntruida(hallazgo) {
        const svg = document.querySelector('svg');
        if (!svg) return;

        const color = hallazgo.color || 'blue';
        const dienteId = `P${hallazgo.desde_diente}`;
        const centerX = hallazgo.texto_x;
        const baseY = hallazgo.texto_y;

        if (!centerX || !baseY) {
            console.warn("Coordenadas faltantes para hallazgo intrudida:", hallazgo);
            return;
        }

        const esSuperior = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28,55,54,53,52,51,61,62,63,64,65]
            .includes(parseInt(hallazgo.desde_diente));

        const longFlecha = 14;
        const endY = esSuperior ? baseY + longFlecha : baseY - longFlecha;
        const puntaY = esSuperior ? endY - 5 : endY + 5;

        const ns = "http://www.w3.org/2000/svg";

        // L√≠nea principal
        const line = document.createElementNS(ns, 'line');
        line.setAttribute('x1', centerX);
        line.setAttribute('y1', baseY);
        line.setAttribute('x2', centerX);
        line.setAttribute('y2', endY);
        line.setAttribute('stroke', color);
        line.setAttribute('stroke-width', 2);
        line.classList.add('intruida-marca');
        line.setAttribute('data-diente', dienteId);
        svg.appendChild(line);

        // Puntas
        const offset = 4;

        const arrow1 = document.createElementNS(ns, 'line');
        arrow1.setAttribute('x1', centerX - offset);
        arrow1.setAttribute('y1', puntaY);
        arrow1.setAttribute('x2', centerX);
        arrow1.setAttribute('y2', endY);
        arrow1.setAttribute('stroke', color);
        arrow1.setAttribute('stroke-width', 2);
        arrow1.classList.add('intruida-marca');
        arrow1.setAttribute('data-diente', dienteId);
        svg.appendChild(arrow1);

        const arrow2 = document.createElementNS(ns, 'line');
        arrow2.setAttribute('x1', centerX + offset);
        arrow2.setAttribute('y1', puntaY);
        arrow2.setAttribute('x2', centerX);
        arrow2.setAttribute('y2', endY);
        arrow2.setAttribute('stroke', color);
        arrow2.setAttribute('stroke-width', 2);
        arrow2.classList.add('intruida-marca');
        arrow2.setAttribute('data-diente', dienteId);
        svg.appendChild(arrow2);
    }

    function drawSupernumeraria(hallazgo) {
        const desde = parseInt(hallazgo.desde_diente);
        const hasta = parseInt(hallazgo.hasta_diente);
        const midX = parseFloat(hallazgo.texto_x);
        const midY = parseFloat(hallazgo.texto_y);

        const ajusteX = 5;
        const ajusteY = -10;

        const ns = "http://www.w3.org/2000/svg";

        // Eliminar si ya existe una marca entre esos dientes
        const selector = `.supernumeraria-marca[data-super="${desde}-${hasta}"]`;
        document.querySelectorAll(selector).forEach(e => e.remove());

        const grupo = document.createElementNS(ns, 'g');
        grupo.classList.add('supernumeraria-marca');
        grupo.setAttribute('data-super', `${desde}-${hasta}`);

        // C√≠rculo azul con fondo blanco
        const circle = document.createElementNS(ns, 'circle');
        circle.setAttribute('cx', midX + ajusteX);
        circle.setAttribute('cy', midY + ajusteY);
        circle.setAttribute('r', 10);
        circle.setAttribute('stroke', 'blue');
        circle.setAttribute('fill', 'white');
        circle.setAttribute('stroke-width', '1.5');

        // Letra "S" centrada
        const texto = document.createElementNS(ns, 'text');
        texto.setAttribute('x', midX + ajusteX);
        texto.setAttribute('y', midY + ajusteY + 4);
        texto.setAttribute('text-anchor', 'middle');
        texto.setAttribute('font-size', '10');
        texto.setAttribute('fill', 'blue');
        texto.setAttribute('font-weight', 'bold');
        texto.textContent = 'S';

        grupo.appendChild(circle);
        grupo.appendChild(texto);

        document.querySelector('svg').appendChild(grupo);

        registrarHallazgoDetalle(
            'supernumeraria',
            `${hallazgo.nombre} (${hallazgo.sigla}) aplicada entre dientes ${desde} y ${hasta}`,
            hallazgo.observaciones
        );
    }

    function drawPulpotomia(hallazgo) {
        const zonaId = hallazgo.zona_id; // ejemplo: "PP-P34-C"
        const partes = zonaId.split('-'); // ["PP", "P34", "C"]

        if (partes.length !== 3) return;

        const dienteId = partes[1]; // "P34"
        const seccion = partes[2];  // "C"
        const color = hallazgo.color || 'blue';

        // Eliminar marcas anteriores
        document.querySelectorAll(`.pulpotomia-marca[data-diente="${dienteId}"]`).forEach(e => e.remove());

        // Pintar el pol√≠gono correspondiente
        const poligono = document.querySelector(`#${dienteId} > polygon[id="${seccion}"]`);
        if (poligono) {
            poligono.setAttribute('fill', color);
        }

        // Mostrar sigla en el texto del diente
        const siglaText = document.querySelector(`#sigla-${dienteId}`);
        if (siglaText) {
            siglaText.textContent = hallazgo.sigla || 'PP';
            siglaText.setAttribute('fill', color);
            siglaText.setAttribute('title', `${hallazgo.observaciones || ''} - ${hallazgo.descripcion || ''}`);
        }

        registrarHallazgoDetalle(
            'pulpotomia',
            `${hallazgo.nombre || 'Pulpotom√≠a'} (${hallazgo.sigla || 'PP'}) en diente ${dienteId.replace('P', '')}`,
            hallazgo.observaciones || ''
        );
    }

    const drawPosicionAnormal = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;

        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", hallazgo.color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle('PAD', `${hallazgo.nombre} ${hallazgo.sigla} aplicada a diente ${hallazgo.desde_diente}`, hallazgo.observaciones);
    }

    function drawProtesisParcial(hallazgo) {
        const svg = document.querySelector('svg');
        const ns = "http://www.w3.org/2000/svg";

        const x1 = parseFloat(hallazgo.coordenada_x1);
        const y1 = parseFloat(hallazgo.coordenada_y1);
        const x2 = parseFloat(hallazgo.coordenada_x2);
        const y2 = parseFloat(hallazgo.coordenada_y2);
        const color = hallazgo.color || 'blue';
        const desde = hallazgo.desde_diente;
        const hasta = hallazgo.hasta_diente;

        const dientesSuperiores = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28,55,54,53,52,51,61,62,63,64,65];
        const esSuperior = dientesSuperiores.includes(desde);

        const alturaCorchete = 10;

        const group = document.createElementNS(ns, 'g');
        group.classList.add('protesis-parcial');
        group.setAttribute('data-desde', desde);
        group.setAttribute('data-hasta', hasta);

        // L√≠nea vertical izquierda (corchete inicial)
        const lineStart = document.createElementNS(ns, 'line');
        lineStart.setAttribute('x1', x1);
        lineStart.setAttribute('x2', x1);
        lineStart.setAttribute('y1', esSuperior ? y1 : y1 - alturaCorchete);
        lineStart.setAttribute('y2', esSuperior ? y1 + alturaCorchete : y1);
        lineStart.setAttribute('stroke', color);
        lineStart.setAttribute('stroke-width', 2);
        group.appendChild(lineStart);

        // L√≠nea horizontal
        const lineMiddle = document.createElementNS(ns, 'line');
        lineMiddle.setAttribute('x1', x1);
        lineMiddle.setAttribute('y1', y1);
        lineMiddle.setAttribute('x2', x2);
        lineMiddle.setAttribute('y2', y2);
        lineMiddle.setAttribute('stroke', color);
        lineMiddle.setAttribute('stroke-width', 2);
        group.appendChild(lineMiddle);

        // L√≠nea vertical derecha (corchete final)
        const lineEnd = document.createElementNS(ns, 'line');
        lineEnd.setAttribute('x1', x2);
        lineEnd.setAttribute('x2', x2);
        lineEnd.setAttribute('y1', esSuperior ? y2 : y2 - alturaCorchete);
        lineEnd.setAttribute('y2', esSuperior ? y2 + alturaCorchete : y2);
        lineEnd.setAttribute('stroke', color);
        lineEnd.setAttribute('stroke-width', 2);
        group.appendChild(lineEnd);

        svg.appendChild(group);
        registrarHallazgoDetalle('PP', `${hallazgo.nombre} ${hallazgo.sigla} aplicada`, hallazgo.observaciones);
    }

    function drawProtesisTotal(hallazgo) {
        const svg = document.querySelector('svg');
        const ns = "http://www.w3.org/2000/svg";

        const sigla = hallazgo.sigla;
        const color = hallazgo.color || 'blue';
        const tipo = hallazgo.tipo;

        const dientesGrupo = [];
        const esSuperior = sigla === 'PTS'; // Pr√≥tesis Total Superior
        const ajusteVertical = esSuperior ? 5 : 95;

        if (esSuperior) {
            for (let i = 18; i >= 11; i--) dientesGrupo.push(document.getElementById(`P${i}`));
            for (let i = 21; i <= 28; i++) dientesGrupo.push(document.getElementById(`P${i}`));
        } else {
            for (let i = 48; i >= 41; i--) dientesGrupo.push(document.getElementById(`P${i}`));
            for (let i = 31; i <= 38; i++) dientesGrupo.push(document.getElementById(`P${i}`));
        }

        const dientesValidos = dientesGrupo.filter(d => d && d.querySelector('polygon#C'));
        if (dientesValidos.length < 2) {
            console.warn('No se encontraron suficientes dientes con pol√≠gono C para pr√≥tesis total.');
            return;
        }

        function obtenerCentroAbsoluto(g) {
            const poly = g.querySelector('polygon#C');
            const puntos = poly.getAttribute('points').trim().split(/\s+/);
            let sumX = 0, sumY = 0;
            puntos.forEach(pt => {
                const [x, y] = pt.split(',').map(Number);
                sumX += x;
                sumY += y;
            });

            const cx = sumX / puntos.length;
            const cy = sumY / puntos.length;

            let tx = 0, ty = 0;
            const transform = g.getAttribute('transform');
            if (transform?.includes('translate')) {
                const match = transform.match(/translate\(([^,]+),?([^\)]+)?\)/);
                if (match) {
                    tx = parseFloat(match[1]) || 0;
                    ty = parseFloat(match[2]) || 0;
                }
            }

            return { x: cx + tx, y: cy + ty };
        }

        const centroInicio = obtenerCentroAbsoluto(dientesValidos[0]);
        const inicio = {
            x: centroInicio.x,
            y: centroInicio.y + ajusteVertical
        };

        const fin = esSuperior
            ? { x: 592.90, y: 15.20 }
            : { x: 592.90, y: 284.95 };

        for (let i = 0; i < 2; i++) {
            const yOffset = esSuperior ? -i * 4 : i * 4;
            const linea = document.createElementNS(ns, 'line');
            linea.setAttribute('x1', inicio.x);
            linea.setAttribute('y1', inicio.y + yOffset - (esSuperior ? 15 : -15));
            linea.setAttribute('x2', fin.x);
            linea.setAttribute('y2', fin.y + yOffset - (esSuperior ? 15 : -15));
            linea.setAttribute('stroke', color);
            linea.setAttribute('stroke-width', 2);
            linea.classList.add('protesis_total-marca');
            svg.appendChild(linea);
        }
        registrarHallazgoDetalle('PT', `${hallazgo.nombre} ${hallazgo.sigla} aplicada`, hallazgo.observaciones);
    }

    function drawProtesisRemovible(hallazgo) {
        const svg = document.querySelector('svg');
        const ns = "http://www.w3.org/2000/svg";

        const x1 = parseFloat(hallazgo.coordenada_x1);
        const y1 = parseFloat(hallazgo.coordenada_y1);
        const x2 = parseFloat(hallazgo.coordenada_x2);
        const y2 = parseFloat(hallazgo.coordenada_y2);
        const color = hallazgo.color || 'blue';
        const desde = hallazgo.desde_diente;
        const hasta = hallazgo.hasta_diente;

        const dientesSuperiores = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28,55,54,53,52,51,61,62,63,64,65];
        const esSuperior = dientesSuperiores.includes(desde);

        const separacion = 4;

        const group = document.createElementNS(ns, 'g');
        group.classList.add('protesis-removible');
        group.setAttribute('data-desde', desde);
        group.setAttribute('data-hasta', hasta);

        for (let i = 0; i < 2; i++) {
            const y = esSuperior ? y1 - (i * separacion) : y1 + (i * separacion);

            const linea = document.createElementNS(ns, 'line');
            linea.setAttribute('x1', x1);
            linea.setAttribute('x2', x2);
            linea.setAttribute('y1', y);
            linea.setAttribute('y2', y);
            linea.setAttribute('stroke', color);
            linea.setAttribute('stroke-width', 2);
            group.appendChild(linea);
        }

        svg.appendChild(group);
        registrarHallazgoDetalle('PPR', `${hallazgo.nombre} ${hallazgo.sigla} aplicada`, hallazgo.observaciones);
    }

    const drawRemanente = (hallazgo) => {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.querySelector('svg');
        if (!svg) return;

        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", hallazgo.color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle('rr', `${hallazgo.nombre} ${hallazgo.sigla} aplicada a diente ${hallazgo.desde_diente}`, hallazgo.observaciones);
    }

    function drawRestauracion(hallazgo) {
        const ns = "http://www.w3.org/2000/svg";

        // Eliminar si ya existe una marca para ese diente
        const selector = `.restauracion-marca[data-diente="${hallazgo.diente}"]`;
        document.querySelectorAll(selector).forEach(e => e.remove());

        const path = document.createElementNS(ns, 'path');
        path.setAttribute('d', hallazgo.path_svg);
        path.setAttribute('fill', hallazgo.color || 'blue');
        path.setAttribute('stroke', hallazgo.color || 'blue');
        path.setAttribute('stroke-width', 3);
        path.setAttribute('fill-opacity', 0.6);
        path.setAttribute('data-diente', hallazgo.desde_diente);
        path.classList.add('restauracion-marca');

        document.querySelector('svg').appendChild(path);
        // üîπ Dibujar sigla en el recuadro del diente
        //console.log("hallazgo-restaura",hallazgo);
        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`); // o desde_diente
        if (textElement) {
            textElement.textContent = hallazgo.sigla.toUpperCase();
            textElement.setAttribute("fill", hallazgo.color || 'blue');
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle(
            'restauracion_definitiva',
            `${hallazgo.nombre} (${hallazgo.sigla}) en diente ${hallazgo.desde_diente}`,
            hallazgo.observaciones
        );
    }

    function drawRestauracionTemporal(hallazgo) {
        const ns = "http://www.w3.org/2000/svg";

        // Eliminar si ya existe una marca para ese diente
        const selector = `.restauracion-temporal-marca[data-diente="${hallazgo.diente}"]`;
        document.querySelectorAll(selector).forEach(e => e.remove());

        const path = document.createElementNS(ns, 'path');
        path.setAttribute('d', hallazgo.path_svg);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', hallazgo.color || 'blue');
        path.setAttribute('stroke-width', 3);
        path.setAttribute('fill-opacity', 0.6);
        path.setAttribute('data-diente', hallazgo.desde_diente);
        path.classList.add('restauracion-temporal-marca');

        document.querySelector('svg').appendChild(path);
        // üîπ Dibujar sigla en el recuadro del diente
        //console.log("hallazgo",hallazgo);
        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`); // o desde_diente
        if (textElement) {
            textElement.textContent = hallazgo.sigla.toUpperCase();
            textElement.setAttribute("fill", hallazgo.color || 'blue');
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle(
            'restauracion_temporal',
            `${hallazgo.nombre} (${hallazgo.sigla}) en diente ${hallazgo.desde_diente}`,
            hallazgo.observaciones
        );
    }

    function drawSellante(hallazgo) {
        const ns = "http://www.w3.org/2000/svg";

        // Eliminar si ya existe una marca para ese diente
        const selector = `.sellante-marca[data-diente="${hallazgo.diente}"]`;
        document.querySelectorAll(selector).forEach(e => e.remove());

        const path = document.createElementNS(ns, 'path');
        path.setAttribute('d', hallazgo.path_svg);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', hallazgo.color || 'blue');
        path.setAttribute('stroke-width', 1);
        path.setAttribute('data-diente', hallazgo.desde_diente);
        path.classList.add('sellante-marca');

        document.querySelector('svg').appendChild(path);
        // üîπ Dibujar sigla en el recuadro del diente
        //console.log("hallazgo",hallazgo);
        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`); // o desde_diente
        if (textElement) {
            textElement.textContent = hallazgo.sigla.toUpperCase();
            textElement.setAttribute("fill", hallazgo.color || 'blue');
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle(
            'sellante',
            `${hallazgo.nombre} (${hallazgo.sigla}) en diente ${hallazgo.desde_diente}`,
            hallazgo.observaciones
        );
    }

    function drawDesgaste(hallazgo) {
        const ns = "http://www.w3.org/2000/svg";

        // Eliminar si ya existe una marca para ese diente
        const selector = `.desgaste-marca[data-diente="${hallazgo.diente}"]`;
        document.querySelectorAll(selector).forEach(e => e.remove());

        const path = document.createElementNS(ns, 'path');
        path.setAttribute('d', hallazgo.path_svg);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', hallazgo.color || 'red');
        path.setAttribute('stroke-width', 1);
        path.setAttribute('data-diente', hallazgo.desde_diente);
        path.classList.add('desgaste-marca');

        document.querySelector('svg').appendChild(path);
        // üîπ Dibujar sigla en el recuadro del diente
        //console.log("hallazgo",hallazgo);
        const textElement = document.querySelector(`#sigla-P${hallazgo.desde_diente}`); // o desde_diente
        if (textElement) {
            textElement.textContent = hallazgo.sigla.toUpperCase();
            textElement.setAttribute("fill", hallazgo.color || 'red');
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }
        registrarHallazgoDetalle(
            'desgaste',
            `${hallazgo.nombre} (${hallazgo.sigla}) en diente ${hallazgo.desde_diente}`,
            hallazgo.observaciones
        );
    }

    const drawConducto = (hallazgo) => {
        const svg = document.querySelector('svg');
        if (!svg) return;

        const color = hallazgo.color || 'blue';
        const dienteId = `P${hallazgo.desde_diente}`;
        const numPieza = hallazgo.desde_diente;
        const startX = hallazgo.texto_x;
        const baseY = hallazgo.texto_y;

        if (!startX || !baseY) {
            console.warn("‚ùó Coordenadas faltantes para tratamiento de conducto:", hallazgo);
            return;
        }

        const topY = baseY - 30; // altura fija para la l√≠nea del tratamiento

        const ns = "http://www.w3.org/2000/svg";
        const linea = document.createElementNS(ns, 'line');
        linea.setAttribute('x1', startX);
        linea.setAttribute('y1', baseY);
        linea.setAttribute('x2', startX);
        linea.setAttribute('y2', topY);
        linea.setAttribute('stroke', color);
        linea.setAttribute('stroke-width', 2);
        linea.setAttribute('fill', 'none');
        linea.classList.add('conducto-marca');
        linea.setAttribute('data-diente', dienteId);
        svg.appendChild(linea);

        // Mostrar sigla (TC / PC) en el recuadro
        const textElement = document.querySelector(`#sigla-${dienteId}`);
        if (textElement) {
            textElement.textContent = hallazgo.sigla;
            textElement.setAttribute("fill", color);
            textElement.setAttribute("title", `${hallazgo.observaciones} - ${hallazgo.descripcion}`);
        }

        registrarHallazgoDetalle(
            'conducto',
            `${hallazgo.nombre} (${hallazgo.sigla}) en diente ${numPieza}`,
            hallazgo.observaciones
        );
    };

    const drawTransposicion = (hallazgo) => {
        const svg = document.querySelector("svg");
        if (!svg) return;

        const color = hallazgo.color || 'blue';

        // === Coordenadas principales
        const x1 = hallazgo.coordenada_x1;
        const x2 = hallazgo.coordenada_x2;
        const y  = hallazgo.coordenada_y1;

        // === Crear marcador si no existe
        if (!document.getElementById("flecha-fin")) {
            const ns = "http://www.w3.org/2000/svg";
            const defs = document.createElementNS(ns, "defs");

            const markerFin = document.createElementNS(ns, "marker");
            markerFin.setAttribute("id", "flecha-fin");
            markerFin.setAttribute("markerWidth", "5");
            markerFin.setAttribute("markerHeight", "5");
            markerFin.setAttribute("refX", "2.5");
            markerFin.setAttribute("refY", "2.5");
            markerFin.setAttribute("orient", "auto");
            markerFin.setAttribute("markerUnits", "strokeWidth");

            const arrow = document.createElementNS(ns, "path");
            arrow.setAttribute("d", "M0,0 L5,2.5 L0,5 Z");
            arrow.setAttribute("fill", color);

            markerFin.appendChild(arrow);
            defs.appendChild(markerFin);
            svg.prepend(defs);
        }

        const ns = "http://www.w3.org/2000/svg";

        // === Flecha 1 (original)
        const path1 = document.createElementNS(ns, "path");
        path1.setAttribute("d", `M ${x1} ${y} C ${x1 + 10} ${y - 12}, ${x2 - 10} ${y - 12}, ${x2} ${y}`);
        path1.setAttribute("stroke", color);
        path1.setAttribute("stroke-width", 2);
        path1.setAttribute("fill", "none");
        path1.setAttribute("marker-end", "url(#flecha-fin)");
        path1.classList.add("transposicion-marca");
        path1.setAttribute("data-desde", hallazgo.desde_diente);
        path1.setAttribute("data-hasta", hallazgo.hasta_diente);
        svg.appendChild(path1);

        // === Flecha 2 (reflejo de la primera)
        const path2 = document.createElementNS(ns, "path");
        //path2.setAttribute("d", `M ${x2 + 12} ${y} C ${x2 + 2} ${y - 12}, ${x1 + 20} ${y - 12}, ${x1 + 12} ${y}`);
        path2.setAttribute("d", `M ${x2 + 20} ${y} C ${x2 + 10} ${y - 12}, ${x1 + 28} ${y - 12}, ${x1 + 20} ${y}`);
        path2.setAttribute("stroke", color);
        path2.setAttribute("stroke-width", 2);
        path2.setAttribute("fill", "none");
        path2.setAttribute("marker-end", "url(#flecha-fin)");
        path2.classList.add("transposicion-marca");
        path2.setAttribute("data-desde", hallazgo.desde_diente);
        path2.setAttribute("data-hasta", hallazgo.hasta_diente);
        svg.appendChild(path2);
         registrarHallazgoDetalle(
            'transposicion',
            `${hallazgo.nombre} (${hallazgo.sigla}) aplicada entre dientes ${hallazgo.desde_diente} y ${hallazgo.hasta_diente}`,
            hallazgo.observaciones
        );
    };

    function renderizarHallazgosOdontograma(hallazgos) {
        const svg = document.querySelector('svg');
        if (!svg || !hallazgos) return;

        // Crear t√≠tulo del log si no existe
        const log = document.getElementById('detalle-hallazgos');
        if (log && !log.querySelector('.log-titulo')) {
            const titulo = document.createElement('h4');
            titulo.className = 'log-titulo';
            titulo.innerHTML = 'ü¶∑‚ú® <strong>Log de Hallazgos</strong>';
            titulo.style.marginBottom = '10px';
            titulo.style.borderBottom = '2px solid #ccc';
            titulo.style.paddingBottom = '5px';
            log.prepend(titulo);
        }
        console.log("hallazgos",hallazgos);
        hallazgos.forEach(h => {
            if (h.sigla === 'AOF') {
                drawAOF(h);
                registrarHallazgoDetalle('ortodoncia', `${h.nombre} AOF desde ${h.desde_diente} hasta ${h.hasta_diente}`);

                // ‚ûï Push al array como lo haces para ortodoncia
                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    desde: h.desde_diente,
                    hasta: h.hasta_diente,
                    coordenadas: {
                        diente1: { x: h.coordenada_x1, y: h.coordenada_y1 },
                        diente2: { x: h.coordenada_x2, y: h.coordenada_y2 }
                    }
                });

            } else if (h.sigla === 'AOR') {
                drawZigZagLine(h);
                registrarHallazgoDetalle('ortodoncia', `${h.nombre} AOR desde ${h.desde_diente} hasta ${h.hasta_diente}`);

                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    desde: h.desde_diente,
                    hasta: h.hasta_diente,
                    coordenadas: {
                        diente1: { x: h.coordenada_x1, y: h.coordenada_y1 },
                        diente2: { x: h.coordenada_x2, y: h.coordenada_y2 }
                    }
                });

            } else if (h.tipo === 'corona' || h.sigla === 'CT') {
                drawCorona(h);

                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    seccion: h.accion || null,
                    zonaId: null,
                    coordenadas: {
                        diente: {
                            x1: h.coordenada_x1,
                            y1: h.coordenada_y1,
                            x2: h.coordenada_x2,
                            y2: h.coordenada_y2
                        },
                        centro_texto: {
                            x: (h.coordenada_x1 + h.coordenada_x2) / 2,
                            y: (h.coordenada_y1 + h.coordenada_y2) / 2
                        }
                    }
                });

            } else if (h.tipo === 'dde') {
                drawDDE(h);

                hallazgosRegistrados.push({
                    tipo: 'dde',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    seccion: h.accion || null,
                    zonaId: null
                });
            } else if (h.tipo === 'edentulo') {
                const linea = document.createElementNS("http://www.w3.org/2000/svg", 'line');
                linea.setAttribute('x1', h.coordenadas.x1);
                linea.setAttribute('y1', h.coordenadas.y1);
                linea.setAttribute('x2', h.coordenadas.x2);
                linea.setAttribute('y2', h.coordenadas.y2);
                linea.setAttribute('stroke', h.color);
                linea.setAttribute('stroke-width', 2);
                linea.classList.add('edentulo-marca');
                svg.appendChild(linea);

                registrarHallazgoDetalle('edentulo', `${h.nombre}`, h.observaciones || '');

                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    dientes: h.dientes, // 'superior' o 'inferior'
                    coordenadas: {
                        x1: h.coordenadas.x1,
                        y1: h.coordenadas.y1,
                        x2: h.coordenadas.x2,
                        y2: h.coordenadas.y2
                    }
                });
            } else if (h.tipo === 'espigo') {
                // üîÅ Si viene con diente1/diente2 (versi√≥n antigua)
                if (h.coordenadas?.diente1 && h.coordenadas?.diente2) {
                    h.coordenadas = {
                        diente: {
                            x1: h.coordenadas.diente1.x,
                            y1: h.coordenadas.diente1.y,
                            x2: h.coordenadas.diente2.x,
                            y2: h.coordenadas.diente2.y
                        },
                        centro_texto: {
                            x: h.coordenadas.diente1.x,
                            y: (h.coordenadas.diente1.y + h.coordenadas.diente2.y) / 2
                        }
                    };
                }

                // üü° Si no tiene coordenadas estructuradas, pero s√≠ tiene x1, y1, x2, y2 directos
                else if (
                    h.coordenada_x1 !== undefined &&
                    h.coordenada_y1 !== undefined &&
                    h.coordenada_x2 !== undefined &&
                    h.coordenada_y2 !== undefined
                ) {
                    h.coordenadas = {
                        diente: {
                            x1: h.coordenada_x1,
                            y1: h.coordenada_y1,
                            x2: h.coordenada_x2,
                            y2: h.coordenada_y2
                        },
                        centro_texto: {
                            x: h.coordenada_x1,
                            y: (h.coordenada_y1 + h.coordenada_y2) / 2
                        }
                    };
                }

                drawEspigo(h);

                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: `P${h.desde_diente ?? h.diente?.replace('P', '')}`,
                    seccion: h.accion || null,
                    zonaId: h.zonaId ?? null,
                    coordenadas: h.coordenadas ?? null
                });

            } else if (h.tipo === 'ffp') {
                drawFFP(h);

                hallazgosRegistrados.push({
                    tipo: 'ffp',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    seccion: h.accion || null,
                    zonaId: null
                });
            } else if (h.tipo === 'fractura') {
                drawFracturaDental(h);
                 hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente, // 'superior' o 'inferior'
                    coordenadas: {
                        x1: h.coordenada_x1,
                        y1: h.coordenada_y1,
                        x2: h.coordenada_x2,
                        y2: h.coordenada_y2
                    }
                });
            } else if (h.tipo === 'fusion') {
                drawFusion(h);
                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    desde: h.desde_diente,
                    hasta: h.hasta_diente,
                    coordenadas: {
                        x1: h.coordenada_x1,
                        y1: h.coordenada_y1,
                        x2: h.coordenada_x2,
                        y2: h.coordenada_y2
                    }
                });

            } else if (h.tipo === 'geminacion') {
                drawGeminacion(h);
                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: `P${h.desde_diente}`,  // Debe estar con prefijo "P" para que coincida con selectedDiente.diente
                     coordenadas: {
                        x: h.texto_x,  // ‚Üê usamos los valores correctos guardados previamente
                        y: h.texto_y
                    }
                });
            } else if (h.tipo === 'giroversion') {
                drawGiroversion(h);
                 hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: `P${h.desde_diente}`, // Prefijo P para que coincida con selectedDiente.diente
                    coordenadas: {
                        x1: h.coordenada_x1,
                        y1: h.coordenada_y1,
                        x2: h.coordenada_x2,
                        y2: h.coordenada_y2
                    },
                    sentido: h.sentido
                });
            } else if (h.tipo === 'impactacion') {
                drawImpactacion(h);

                hallazgosRegistrados.push({
                    tipo: 'impactacion',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    seccion: h.accion || null,
                    zonaId: null
                });
            } else if (h.tipo === 'imp') {
                drawImplanteDental(h);

                hallazgosRegistrados.push({
                    tipo: 'imp',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    seccion: h.accion || null,
                    zonaId: null
                });
            } else if (h.tipo === 'caries') {
                drawCaries(h);

                hallazgosRegistrados.push({
                    tipo: 'caries',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    zonaId: h.zona_id || null,
                    path_svg: h.path_svg || '',
                    seccion: null // No seccion espec√≠fica en caries
                });
            }  else if (h.tipo === 'mac') {
                drawMacrodoncia(h);

                hallazgosRegistrados.push({
                    tipo: 'mac',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    seccion: h.accion || null,
                    zonaId: null
                });
            } else if (h.tipo === 'mic') {
                drawMicrodoncia(h);

                hallazgosRegistrados.push({
                    tipo: 'mic',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    seccion: h.accion || null,
                    zonaId: null
                });
            }  else if (h.tipo === 'mp') {
                drawMP(h);

                hallazgosRegistrados.push({
                    tipo: 'mp',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    seccion: h.accion || null,
                    zonaId: null
                });
            }  else if (h.tipo === 'ausente') {
                drawAusente(h);

                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    seccion: h.accion || null,
                    zonaId: null,
                    coordenadas: {
                        diente: {
                            x1: h.coordenada_x1,
                            y1: h.coordenada_y1,
                            x2: h.coordenada_x2,
                            y2: h.coordenada_y2
                        },
                        centro_texto: {
                            x: (h.coordenada_x1 + h.coordenada_x2) / 2,
                            y: (h.coordenada_y1 + h.coordenada_y2) / 2
                        }
                    }
                });
            } else if (h.tipo === 'clavija') {
                drawClavija(h);

                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: `P${h.desde_diente}`, // importante: mantener formato tipo "P65"
                    seccion: h.accion || null,
                    zonaId: null,
                    coordenadas: {
                        diente: {
                            cx: h.texto_x,
                            cy: h.texto_y
                        },
                        centro_texto: {
                            x: h.texto_x,
                            y: h.texto_y
                        }
                    }
                });
            } else if (h.tipo === 'ectopica') {
                drawEctopica(h);

                hallazgosRegistrados.push({
                    tipo: 'ectopica',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    seccion: h.accion || null,
                    zonaId: null
                });
            } else if (h.tipo === 'erupcion') {
                drawErupcion(h);

                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: `P${h.desde_diente}`, // importante: mantener formato tipo "P65"
                    seccion: h.accion || null,
                    zonaId: null,
                    coordenadas: {
                        diente: {
                            cx: h.texto_x,
                            cy: h.texto_y
                        },
                        centro_texto: {
                            x: h.texto_x,
                            y: h.texto_y
                        }
                    }
                });
            } else if (h.tipo === 'extruida') {
                drawExtruida(h);

                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: `P${h.desde_diente}`, // importante: mantener formato tipo "P65"
                    seccion: h.accion || null,
                    zonaId: null,
                    coordenadas: {
                        diente: {
                            cx: h.texto_x,
                            cy: h.texto_y
                        },
                        centro_texto: {
                            x: h.texto_x,
                            y: h.texto_y
                        }
                    }
                });
            } else if (h.tipo === 'intruida') {
                drawIntruida(h);

                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: `P${h.desde_diente}`, // importante: mantener formato tipo "P65"
                    seccion: h.accion || null,
                    zonaId: null,
                    coordenadas: {
                        diente: {
                            cx: h.texto_x,
                            cy: h.texto_y
                        },
                        centro_texto: {
                            x: h.texto_x,
                            y: h.texto_y
                        }
                    }
                });
            } else if (h.tipo === 'supernumeraria') {
                drawSupernumeraria(h);
                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    desde: h.desde_diente,  // Debe estar con prefijo "P" para que coincida con selectedDiente.diente
                    hasta: h.hasta_diente,
                     coordenadas: {
                        x: h.texto_x,  // ‚Üê usamos los valores correctos guardados previamente
                        y: h.texto_y
                    }
                });
            } else if (h.tipo === 'pulpotomia') {
                drawPulpotomia(h);

                hallazgosRegistrados.push({
                    tipo: 'pulpotomia',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    zonaId: h.zona_id || null,
                    path_svg: h.path_svg || '',
                    seccion: null // No seccion espec√≠fica en caries
                });
            } else if (h.tipo === 'pos_anormal') {
                drawPosicionAnormal(h);

                hallazgosRegistrados.push({
                    tipo: 'pos_anormal',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    seccion: h.accion || null,
                    zonaId: null
                });
            } else if (h.tipo === 'protesis_parcial') {
                drawProtesisParcial(h); // Usa la funci√≥n ya definida con coordenadas absolutas

                hallazgosRegistrados.push({
                    tipo: 'protesis_parcial',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    desde: h.desde_diente,
                    hasta: h.hasta_diente,
                    coordenadas: {
                        x1: parseFloat(h.coordenada_x1),
                        y1: parseFloat(h.coordenada_y1),
                        x2: parseFloat(h.coordenada_x2),
                        y2: parseFloat(h.coordenada_y2)
                    }
                });
            } else if (h.tipo === 'protesis_total') {
                drawProtesisTotal(h);
                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    desde: h.desde_diente,
                    hasta: h.hasta_diente,
                    coordenadas: {
                        diente1: { x: h.coordenada_x1, y: h.coordenada_y1 },
                        diente2: { x: h.coordenada_x2, y: h.coordenada_y2 }
                    }
                });
            } else if (h.tipo === 'protesis_removible') {
                drawProtesisRemovible(h); // Usa la funci√≥n ya definida con coordenadas absolutas

                hallazgosRegistrados.push({
                    tipo: 'protesis_removible',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    desde: h.desde_diente,
                    hasta: h.hasta_diente,
                    coordenadas: {
                        x1: parseFloat(h.coordenada_x1),
                        y1: parseFloat(h.coordenada_y1),
                        x2: parseFloat(h.coordenada_x2),
                        y2: parseFloat(h.coordenada_y2)
                    }
                });
            } else if (h.tipo === 'remanente') {
                drawRemanente(h);

                hallazgosRegistrados.push({
                    tipo: 'remanente',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    seccion: h.accion || null,
                    zonaId: null
                });
            } else if (h.tipo === 'restauracion_definitiva') {
                drawRestauracion(h);

                hallazgosRegistrados.push({
                    tipo: 'restauracion_definitiva',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    zonaId: h.zona_id || null,
                    path_svg: h.path_svg || '',
                    seccion: null // No seccion espec√≠fica en caries
                });
            } else if (h.tipo === 'restauracion_temporal') {
                drawRestauracionTemporal(h);

                hallazgosRegistrados.push({
                    tipo: 'restauracion_temporal',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    zonaId: h.zona_id || null,
                    path_svg: h.path_svg || '',
                    seccion: null // No seccion espec√≠fica en caries
                });
            } else if (h.tipo === 'sellante') {
                drawSellante(h);

                hallazgosRegistrados.push({
                    tipo: 'sellante',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    zonaId: h.zona_id || null,
                    path_svg: h.path_svg || '',
                    seccion: null // No seccion espec√≠fica en caries
                });
            } else if (h.tipo === 'desgaste') {
                drawDesgaste(h);

                hallazgosRegistrados.push({
                    tipo: 'desgaste',
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: h.desde_diente,
                    zonaId: h.zona_id || null,
                    path_svg: h.path_svg || '',
                    seccion: null // No seccion espec√≠fica en caries
                });
            } else if (h.tipo === 'conducto') {
                drawConducto(h);

                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: `P${h.desde_diente}`, // importante: mantener formato tipo "P65"
                    seccion: h.accion || null,
                    zonaId: null,
                    coordenadas: {
                        diente: {
                            cx: h.texto_x,
                            cy: h.texto_y
                        },
                        centro_texto: {
                            x: h.texto_x,
                            y: h.texto_y
                        }
                    }
                });
            } else if (h.tipo === 'transposicion') {
                drawTransposicion(h); // Ya debe estar implementado como te pas√© antes

                hallazgosRegistrados.push({
                    tipo: h.tipo,
                    sigla: h.sigla,
                    color: h.color,
                    nombre: h.nombre,
                    descripcion: h.descripcion,
                    observaciones: h.observaciones,
                    diente: `P${h.desde_diente}-P${h.hasta_diente}`,  // Ejemplo: P31-P32
                    desde: h.desde_diente,
                    hasta: h.hasta_diente,
                    coordenadas: {
                        centro_texto: {
                            x: h.texto_x,
                            y: h.texto_y
                        },
                        flecha1: {
                            x1: h.coordenada_x1,
                            x2: h.coordenada_x2,
                            y: h.coordenada_y1
                        }
                    }
                });
            }

        });
    }

    function registrarHallazgoDetalle(tipo, texto, observaciones = '') {
        const contenedor = document.getElementById('detalle-hallazgos');
        if (!contenedor) return;

        const item = document.createElement('div');
        item.className = 'hallazgo-item';

        const emojiSpan = document.createElement('span');
        emojiSpan.className = 'emoji';
        emojiSpan.textContent = obtenerEmojiPorTipo(tipo); // Funci√≥n que asigna el emoji

        const textSpan = document.createElement('span');
        textSpan.className = 'hallazgo-text';
        textSpan.innerHTML = `${texto}${observaciones ? ` <em>(${observaciones})</em>` : ''}`;

        item.appendChild(emojiSpan);
        item.appendChild(textSpan);
        contenedor.appendChild(item);
    }

    function obtenerEmojiPorTipo(tipo) {
        const emojis = {
            eliminacion: '‚ùå',
            ortodoncia: 'ü¶∑',
            corona: 'üëë',
            pieza: '‚ö™',
            seccion: 'üîπ',
            entrePiezas: '‚ÜîÔ∏è',
            edentulo: '‚ûñ',
            transposicion: 'üîÑ',
            protesis_fija: 'üõ†Ô∏è',
            protesis_parcial: '‚öôÔ∏è',
            protesis_total: 'üîß',
            restauracion_definitiva: 'üß©',
            restauracion_temporal: 'üß±',
            sellante: 'ü©π',
            desgaste: 'üí¢',
            caries: 'üç¨',
            pulpotomia: 'üß™',
            conducto: 'ü©∏',
            fractura: 'üí•',
            giroversion: 'üîÅ',
            espigo_munon: 'üìê',
            fusion: 'üîó',
            diastema: 'üìè',
            erupcion: 'üå±',
            intruida: '‚¨áÔ∏è',
            extruida: '‚¨ÜÔ∏è',
            hallazgo_textual: 'üìù'
        };
        return emojis[tipo] || '‚úÖ';
    }

    function limpiarOdontograma() {
        const svg = document.querySelector('svg');
        if (!svg) return;

        // Borrar todos los elementos con clase .ortodoncia-marca y .borde-corona
        svg.querySelectorAll('.ortodoncia-marca, .borde-corona').forEach(e => e.remove());

        // Limpiar siglas en los dientes
        document.querySelectorAll('[id^="sigla-P"]').forEach(el => {
            el.textContent = '';
            el.removeAttribute("fill");
            el.removeAttribute("title");
        });

        // Tambi√©n puedes reiniciar logs u otras partes si lo deseas
        const log = document.getElementById('detalle-hallazgos');
        if (log) log.innerHTML = '';
    }

    // Llamar a la funci√≥n cuando la p√°gina est√© lista
    document.addEventListener('DOMContentLoaded', function () {
        const hallazgosIniciales = @json($hallazgos);
        renderizarHallazgosOdontograma(hallazgosIniciales); // Aseg√∫rate de que esta variable est√© definida
    });
   
</script>

<style>
    .svg-responsive {
        width: 100%;
        max-width: 610px;
        aspect-ratio: 610 / 340;
        margin: 0 auto;
    }
    .corona-sigla {
    text-transform: uppercase;
    pointer-events: none;
    }
    .hallazgo-log {
        background: #f9f9f9;
        border-left: 5px solid #4a90e2;
        padding: 10px 15px;
        height: 200px;
        overflow-y: auto;
        font-family: 'Segoe UI', sans-serif;
        font-size: 14px;
        line-height: 1.6;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        scrollbar-width: thin;
        scrollbar-color: #4a90e2 #e0e0e0;
    }

    .hallazgo-log::-webkit-scrollbar {
        width: 6px;
    }

    .hallazgo-log::-webkit-scrollbar-thumb {
        background-color: #4a90e2;
        border-radius: 3px;
    }

    .hallazgo-log::-webkit-scrollbar-track {
        background-color: #e0e0e0;
    }

    .hallazgo-item {
        padding: 6px 0;
        border-bottom: 1px solid #ddd;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .hallazgo-item:last-child {
        border-bottom: none;
    }

    .hallazgo-item .emoji {
        font-size: 18px;
    }
    #zona-tooltip {
        position: fixed;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 6px 10px;
        border-radius: 5px;
        font-size: 0.85rem;
        pointer-events: none;
        z-index: 10000;
        white-space: nowrap;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }


</style> 
